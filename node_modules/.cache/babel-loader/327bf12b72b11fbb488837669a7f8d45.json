{"ast":null,"code":"/**\n * screen.js - screen node for blessed\n * Copyright (c) 2013-2015, Christopher Jeffrey and contributors (MIT License).\n * https://github.com/chjj/blessed\n */\n\n/**\n * Modules\n */\nvar path = require('path'),\n    fs = require('fs'),\n    cp = require('child_process');\n\nvar colors = require('../colors'),\n    program = require('../program'),\n    unicode = require('../unicode');\n\nvar nextTick = global.setImmediate || process.nextTick.bind(process);\n\nvar helpers = require('../helpers');\n\nvar Node = require('./node');\n\nvar Log = require('./log');\n\nvar Element = require('./element');\n\nvar Box = require('./box');\n/**\n * Screen\n */\n\n\nfunction Screen(options) {\n  var self = this;\n\n  if (!(this instanceof Node)) {\n    return new Screen(options);\n  }\n\n  Screen.bind(this);\n  options = options || {};\n\n  if (options.rsety && options.listen) {\n    options = {\n      program: options\n    };\n  }\n\n  this.program = options.program;\n\n  if (!this.program) {\n    this.program = program({\n      input: options.input,\n      output: options.output,\n      log: options.log,\n      debug: options.debug,\n      dump: options.dump,\n      terminal: options.terminal || options.term,\n      resizeTimeout: options.resizeTimeout,\n      forceUnicode: options.forceUnicode,\n      tput: true,\n      buffer: true,\n      zero: true\n    });\n  } else {\n    this.program.setupTput();\n    this.program.useBuffer = true;\n    this.program.zero = true;\n    this.program.options.resizeTimeout = options.resizeTimeout;\n\n    if (options.forceUnicode != null) {\n      this.program.tput.features.unicode = options.forceUnicode;\n      this.program.tput.unicode = options.forceUnicode;\n    }\n  }\n\n  this.tput = this.program.tput;\n  Node.call(this, options);\n  this.autoPadding = options.autoPadding !== false;\n  this.tabc = Array((options.tabSize || 4) + 1).join(' ');\n  this.dockBorders = options.dockBorders;\n  this.ignoreLocked = options.ignoreLocked || [];\n  this._unicode = this.tput.unicode || this.tput.numbers.U8 === 1;\n  this.fullUnicode = this.options.fullUnicode && this._unicode;\n  this.dattr = 0 << 18 | 0x1ff << 9 | 0x1ff;\n  this.renders = 0;\n  this.position = {\n    left: this.left = this.aleft = this.rleft = 0,\n    right: this.right = this.aright = this.rright = 0,\n    top: this.top = this.atop = this.rtop = 0,\n    bottom: this.bottom = this.abottom = this.rbottom = 0,\n\n    get height() {\n      return self.height;\n    },\n\n    get width() {\n      return self.width;\n    }\n\n  };\n  this.ileft = 0;\n  this.itop = 0;\n  this.iright = 0;\n  this.ibottom = 0;\n  this.iheight = 0;\n  this.iwidth = 0;\n  this.padding = {\n    left: 0,\n    top: 0,\n    right: 0,\n    bottom: 0\n  };\n  this.hover = null;\n  this.history = [];\n  this.clickable = [];\n  this.keyable = [];\n  this.grabKeys = false;\n  this.lockKeys = false;\n  this.focused;\n  this._buf = '';\n  this._ci = -1;\n\n  if (options.title) {\n    this.title = options.title;\n  }\n\n  options.cursor = options.cursor || {\n    artificial: options.artificialCursor,\n    shape: options.cursorShape,\n    blink: options.cursorBlink,\n    color: options.cursorColor\n  };\n  this.cursor = {\n    artificial: options.cursor.artificial || false,\n    shape: options.cursor.shape || 'block',\n    blink: options.cursor.blink || false,\n    color: options.cursor.color || null,\n    _set: false,\n    _state: 1,\n    _hidden: true\n  };\n  this.program.on('resize', function () {\n    self.alloc();\n    self.render();\n\n    (function emit(el) {\n      el.emit('resize');\n      el.children.forEach(emit);\n    })(self);\n  });\n  this.program.on('focus', function () {\n    self.emit('focus');\n  });\n  this.program.on('blur', function () {\n    self.emit('blur');\n  });\n  this.program.on('warning', function (text) {\n    self.emit('warning', text);\n  });\n  this.on('newListener', function fn(type) {\n    if (type === 'keypress' || type.indexOf('key ') === 0 || type === 'mouse') {\n      if (type === 'keypress' || type.indexOf('key ') === 0) self._listenKeys();\n      if (type === 'mouse') self._listenMouse();\n    }\n\n    if (type === 'mouse' || type === 'click' || type === 'mouseover' || type === 'mouseout' || type === 'mousedown' || type === 'mouseup' || type === 'mousewheel' || type === 'wheeldown' || type === 'wheelup' || type === 'mousemove') {\n      self._listenMouse();\n    }\n  });\n  this.setMaxListeners(Infinity);\n  this.enter();\n  this.postEnter();\n}\n\nScreen.global = null;\nScreen.total = 0;\nScreen.instances = [];\n\nScreen.bind = function (screen) {\n  if (!Screen.global) {\n    Screen.global = screen;\n  }\n\n  if (!~Screen.instances.indexOf(screen)) {\n    Screen.instances.push(screen);\n    screen.index = Screen.total;\n    Screen.total++;\n  }\n\n  if (Screen._bound) return;\n  Screen._bound = true;\n  process.on('uncaughtException', Screen._exceptionHandler = function (err) {\n    if (process.listeners('uncaughtException').length > 1) {\n      return;\n    }\n\n    Screen.instances.slice().forEach(function (screen) {\n      screen.destroy();\n    });\n    err = err || new Error('Uncaught Exception.');\n    console.error(err.stack ? err.stack + '' : err + '');\n    nextTick(function () {\n      process.exit(1);\n    });\n  });\n  ['SIGTERM', 'SIGINT', 'SIGQUIT'].forEach(function (signal) {\n    var name = '_' + signal.toLowerCase() + 'Handler';\n    process.on(signal, Screen[name] = function () {\n      if (process.listeners(signal).length > 1) {\n        return;\n      }\n\n      nextTick(function () {\n        process.exit(0);\n      });\n    });\n  });\n  process.on('exit', Screen._exitHandler = function () {\n    Screen.instances.slice().forEach(function (screen) {\n      screen.destroy();\n    });\n  });\n};\n\nScreen.prototype.__proto__ = Node.prototype;\nScreen.prototype.type = 'screen';\n\nScreen.prototype.__defineGetter__('title', function () {\n  return this.program.title;\n});\n\nScreen.prototype.__defineSetter__('title', function (title) {\n  return this.program.title = title;\n});\n\nScreen.prototype.__defineGetter__('terminal', function () {\n  return this.program.terminal;\n});\n\nScreen.prototype.__defineSetter__('terminal', function (terminal) {\n  this.setTerminal(terminal);\n  return this.program.terminal;\n});\n\nScreen.prototype.setTerminal = function (terminal) {\n  var entered = !!this.program.isAlt;\n\n  if (entered) {\n    this._buf = '';\n    this.program._buf = '';\n    this.leave();\n  }\n\n  this.program.setTerminal(terminal);\n  this.tput = this.program.tput;\n\n  if (entered) {\n    this.enter();\n  }\n};\n\nScreen.prototype.enter = function () {\n  if (this.program.isAlt) return;\n\n  if (!this.cursor._set) {\n    if (this.options.cursor.shape) {\n      this.cursorShape(this.cursor.shape, this.cursor.blink);\n    }\n\n    if (this.options.cursor.color) {\n      this.cursorColor(this.cursor.color);\n    }\n  }\n\n  if (process.platform === 'win32') {\n    try {\n      cp.execSync('cls', {\n        stdio: 'ignore',\n        timeout: 1000\n      });\n    } catch (e) {\n      ;\n    }\n  }\n\n  this.program.alternateBuffer();\n  this.program.put.keypad_xmit();\n  this.program.csr(0, this.height - 1);\n  this.program.hideCursor();\n  this.program.cup(0, 0); // We need this for tmux now:\n\n  if (this.tput.strings.ena_acs) {\n    this.program._write(this.tput.enacs());\n  }\n\n  this.alloc();\n};\n\nScreen.prototype.leave = function () {\n  if (!this.program.isAlt) return;\n  this.program.put.keypad_local();\n\n  if (this.program.scrollTop !== 0 || this.program.scrollBottom !== this.rows - 1) {\n    this.program.csr(0, this.height - 1);\n  } // XXX For some reason if alloc/clear() is before this\n  // line, it doesn't work on linux console.\n\n\n  this.program.showCursor();\n  this.alloc();\n\n  if (this._listenedMouse) {\n    this.program.disableMouse();\n  }\n\n  this.program.normalBuffer();\n  if (this.cursor._set) this.cursorReset();\n  this.program.flush();\n\n  if (process.platform === 'win32') {\n    try {\n      cp.execSync('cls', {\n        stdio: 'ignore',\n        timeout: 1000\n      });\n    } catch (e) {\n      ;\n    }\n  }\n};\n\nScreen.prototype.postEnter = function () {\n  var self = this;\n\n  if (this.options.debug) {\n    this.debugLog = new Log({\n      screen: this,\n      parent: this,\n      hidden: true,\n      draggable: true,\n      left: 'center',\n      top: 'center',\n      width: '30%',\n      height: '30%',\n      border: 'line',\n      label: ' {bold}Debug Log{/bold} ',\n      tags: true,\n      keys: true,\n      vi: true,\n      mouse: true,\n      scrollbar: {\n        ch: ' ',\n        track: {\n          bg: 'yellow'\n        },\n        style: {\n          inverse: true\n        }\n      }\n    });\n\n    this.debugLog.toggle = function () {\n      if (self.debugLog.hidden) {\n        self.saveFocus();\n        self.debugLog.show();\n        self.debugLog.setFront();\n        self.debugLog.focus();\n      } else {\n        self.debugLog.hide();\n        self.restoreFocus();\n      }\n\n      self.render();\n    };\n\n    this.debugLog.key(['q', 'escape'], self.debugLog.toggle);\n    this.key('f12', self.debugLog.toggle);\n  }\n\n  if (this.options.warnings) {\n    this.on('warning', function (text) {\n      var warning = new Box({\n        screen: self,\n        parent: self,\n        left: 'center',\n        top: 'center',\n        width: 'shrink',\n        padding: 1,\n        height: 'shrink',\n        align: 'center',\n        valign: 'middle',\n        border: 'line',\n        label: ' {red-fg}{bold}WARNING{/} ',\n        content: '{bold}' + text + '{/bold}',\n        tags: true\n      });\n      self.render();\n      var timeout = setTimeout(function () {\n        warning.destroy();\n        self.render();\n      }, 1500);\n\n      if (timeout.unref) {\n        timeout.unref();\n      }\n    });\n  }\n};\n\nScreen.prototype._destroy = Screen.prototype.destroy;\n\nScreen.prototype.destroy = function () {\n  this.leave();\n  var index = Screen.instances.indexOf(this);\n\n  if (~index) {\n    Screen.instances.splice(index, 1);\n    Screen.total--;\n    Screen.global = Screen.instances[0];\n\n    if (Screen.total === 0) {\n      Screen.global = null;\n      process.removeListener('uncaughtException', Screen._exceptionHandler);\n      process.removeListener('SIGTERM', Screen._sigtermHandler);\n      process.removeListener('SIGINT', Screen._sigintHandler);\n      process.removeListener('SIGQUIT', Screen._sigquitHandler);\n      process.removeListener('exit', Screen._exitHandler);\n      delete Screen._exceptionHandler;\n      delete Screen._sigtermHandler;\n      delete Screen._sigintHandler;\n      delete Screen._sigquitHandler;\n      delete Screen._exitHandler;\n      delete Screen._bound;\n    }\n\n    this.destroyed = true;\n    this.emit('destroy');\n\n    this._destroy();\n  }\n\n  this.program.destroy();\n};\n\nScreen.prototype.log = function () {\n  return this.program.log.apply(this.program, arguments);\n};\n\nScreen.prototype.debug = function () {\n  if (this.debugLog) {\n    this.debugLog.log.apply(this.debugLog, arguments);\n  }\n\n  return this.program.debug.apply(this.program, arguments);\n};\n\nScreen.prototype._listenMouse = function (el) {\n  var self = this;\n\n  if (el && !~this.clickable.indexOf(el)) {\n    el.clickable = true;\n    this.clickable.push(el);\n  }\n\n  if (this._listenedMouse) return;\n  this._listenedMouse = true;\n  this.program.enableMouse();\n\n  if (this.options.sendFocus) {\n    this.program.setMouse({\n      sendFocus: true\n    }, true);\n  }\n\n  this.on('render', function () {\n    self._needsClickableSort = true;\n  });\n  this.program.on('mouse', function (data) {\n    if (self.lockKeys) return;\n\n    if (self._needsClickableSort) {\n      self.clickable = helpers.hsort(self.clickable);\n      self._needsClickableSort = false;\n    }\n\n    var i = 0,\n        el,\n        set,\n        pos;\n\n    for (; i < self.clickable.length; i++) {\n      el = self.clickable[i];\n\n      if (el.detached || !el.visible) {\n        continue;\n      } // if (self.grabMouse && self.focused !== el\n      //     && !el.hasAncestor(self.focused)) continue;\n\n\n      pos = el.lpos;\n      if (!pos) continue;\n\n      if (data.x >= pos.xi && data.x < pos.xl && data.y >= pos.yi && data.y < pos.yl) {\n        el.emit('mouse', data);\n\n        if (data.action === 'mousedown') {\n          self.mouseDown = el;\n        } else if (data.action === 'mouseup') {\n          (self.mouseDown || el).emit('click', data);\n          self.mouseDown = null;\n        } else if (data.action === 'mousemove') {\n          if (self.hover && el.index > self.hover.index) {\n            set = false;\n          }\n\n          if (self.hover !== el && !set) {\n            if (self.hover) {\n              self.hover.emit('mouseout', data);\n            }\n\n            el.emit('mouseover', data);\n            self.hover = el;\n          }\n\n          set = true;\n        }\n\n        el.emit(data.action, data);\n        break;\n      }\n    } // Just mouseover?\n\n\n    if ((data.action === 'mousemove' || data.action === 'mousedown' || data.action === 'mouseup') && self.hover && !set) {\n      self.hover.emit('mouseout', data);\n      self.hover = null;\n    }\n\n    self.emit('mouse', data);\n    self.emit(data.action, data);\n  }); // Autofocus highest element.\n  // this.on('element click', function(el, data) {\n  //   var target;\n  //   do {\n  //     if (el.clickable === true && el.options.autoFocus !== false) {\n  //       target = el;\n  //     }\n  //   } while (el = el.parent);\n  //   if (target) target.focus();\n  // });\n  // Autofocus elements with the appropriate option.\n\n  this.on('element click', function (el) {\n    if (el.clickable === true && el.options.autoFocus !== false) {\n      el.focus();\n    }\n  });\n};\n\nScreen.prototype.enableMouse = function (el) {\n  this._listenMouse(el);\n};\n\nScreen.prototype._listenKeys = function (el) {\n  var self = this;\n\n  if (el && !~this.keyable.indexOf(el)) {\n    el.keyable = true;\n    this.keyable.push(el);\n  }\n\n  if (this._listenedKeys) return;\n  this._listenedKeys = true; // NOTE: The event emissions used to be reversed:\n  // element + screen\n  // They are now:\n  // screen + element\n  // After the first keypress emitted, the handler\n  // checks to make sure grabKeys, lockKeys, and focused\n  // weren't changed, and handles those situations appropriately.\n\n  this.program.on('keypress', function (ch, key) {\n    if (self.lockKeys && !~self.ignoreLocked.indexOf(key.full)) {\n      return;\n    }\n\n    var focused = self.focused,\n        grabKeys = self.grabKeys;\n\n    if (!grabKeys || ~self.ignoreLocked.indexOf(key.full)) {\n      self.emit('keypress', ch, key);\n      self.emit('key ' + key.full, ch, key);\n    } // If something changed from the screen key handler, stop.\n\n\n    if (self.grabKeys !== grabKeys || self.lockKeys) {\n      return;\n    }\n\n    if (focused && focused.keyable) {\n      focused.emit('keypress', ch, key);\n      focused.emit('key ' + key.full, ch, key);\n    }\n  });\n};\n\nScreen.prototype.enableKeys = function (el) {\n  this._listenKeys(el);\n};\n\nScreen.prototype.enableInput = function (el) {\n  this._listenMouse(el);\n\n  this._listenKeys(el);\n};\n\nScreen.prototype._initHover = function () {\n  var self = this;\n\n  if (this._hoverText) {\n    return;\n  }\n\n  this._hoverText = new Box({\n    screen: this,\n    left: 0,\n    top: 0,\n    tags: false,\n    height: 'shrink',\n    width: 'shrink',\n    border: 'line',\n    style: {\n      border: {\n        fg: 'default'\n      },\n      bg: 'default',\n      fg: 'default'\n    }\n  });\n  this.on('mousemove', function (data) {\n    if (self._hoverText.detached) return;\n    self._hoverText.rleft = data.x + 1;\n    self._hoverText.rtop = data.y;\n    self.render();\n  });\n  this.on('element mouseover', function (el, data) {\n    if (!el._hoverOptions) return;\n    self._hoverText.parseTags = el.parseTags;\n\n    self._hoverText.setContent(el._hoverOptions.text);\n\n    self.append(self._hoverText);\n    self._hoverText.rleft = data.x + 1;\n    self._hoverText.rtop = data.y;\n    self.render();\n  });\n  this.on('element mouseout', function () {\n    if (self._hoverText.detached) return;\n\n    self._hoverText.detach();\n\n    self.render();\n  }); // XXX This can cause problems if the\n  // terminal does not support allMotion.\n  // Workaround: check to see if content is set.\n\n  this.on('element mouseup', function (el) {\n    if (!self._hoverText.getContent()) return;\n    if (!el._hoverOptions) return;\n    self.append(self._hoverText);\n    self.render();\n  });\n};\n\nScreen.prototype.__defineGetter__('cols', function () {\n  return this.program.cols;\n});\n\nScreen.prototype.__defineGetter__('rows', function () {\n  return this.program.rows;\n});\n\nScreen.prototype.__defineGetter__('width', function () {\n  return this.program.cols;\n});\n\nScreen.prototype.__defineGetter__('height', function () {\n  return this.program.rows;\n});\n\nScreen.prototype.alloc = function (dirty) {\n  var x, y;\n  this.lines = [];\n\n  for (y = 0; y < this.rows; y++) {\n    this.lines[y] = [];\n\n    for (x = 0; x < this.cols; x++) {\n      this.lines[y][x] = [this.dattr, ' '];\n    }\n\n    this.lines[y].dirty = !!dirty;\n  }\n\n  this.olines = [];\n\n  for (y = 0; y < this.rows; y++) {\n    this.olines[y] = [];\n\n    for (x = 0; x < this.cols; x++) {\n      this.olines[y][x] = [this.dattr, ' '];\n    }\n  }\n\n  this.program.clear();\n};\n\nScreen.prototype.realloc = function () {\n  return this.alloc(true);\n};\n\nScreen.prototype.render = function () {\n  var self = this;\n  if (this.destroyed) return;\n  this.emit('prerender');\n  this._borderStops = {}; // TODO: Possibly get rid of .dirty altogether.\n  // TODO: Could possibly drop .dirty and just clear the `lines` buffer every\n  // time before a screen.render. This way clearRegion doesn't have to be\n  // called in arbitrary places for the sake of clearing a spot where an\n  // element used to be (e.g. when an element moves or is hidden). There could\n  // be some overhead though.\n  // this.screen.clearRegion(0, this.cols, 0, this.rows);\n\n  this._ci = 0;\n  this.children.forEach(function (el) {\n    el.index = self._ci++; //el._rendering = true;\n\n    el.render(); //el._rendering = false;\n  });\n  this._ci = -1;\n\n  if (this.screen.dockBorders) {\n    this._dockBorders();\n  }\n\n  this.draw(0, this.lines.length - 1); // XXX Workaround to deal with cursor pos before the screen has rendered and\n  // lpos is not reliable (stale).\n\n  if (this.focused && this.focused._updateCursor) {\n    this.focused._updateCursor(true);\n  }\n\n  this.renders++;\n  this.emit('render');\n};\n\nScreen.prototype.blankLine = function (ch, dirty) {\n  var out = [];\n\n  for (var x = 0; x < this.cols; x++) {\n    out[x] = [this.dattr, ch || ' '];\n  }\n\n  out.dirty = dirty;\n  return out;\n};\n\nScreen.prototype.insertLine = function (n, y, top, bottom) {\n  // if (y === top) return this.insertLineNC(n, y, top, bottom);\n  if (!this.tput.strings.change_scroll_region || !this.tput.strings.delete_line || !this.tput.strings.insert_line) return;\n  this._buf += this.tput.csr(top, bottom);\n  this._buf += this.tput.cup(y, 0);\n  this._buf += this.tput.il(n);\n  this._buf += this.tput.csr(0, this.height - 1);\n  var j = bottom + 1;\n\n  while (n--) {\n    this.lines.splice(y, 0, this.blankLine());\n    this.lines.splice(j, 1);\n    this.olines.splice(y, 0, this.blankLine());\n    this.olines.splice(j, 1);\n  }\n};\n\nScreen.prototype.deleteLine = function (n, y, top, bottom) {\n  // if (y === top) return this.deleteLineNC(n, y, top, bottom);\n  if (!this.tput.strings.change_scroll_region || !this.tput.strings.delete_line || !this.tput.strings.insert_line) return;\n  this._buf += this.tput.csr(top, bottom);\n  this._buf += this.tput.cup(y, 0);\n  this._buf += this.tput.dl(n);\n  this._buf += this.tput.csr(0, this.height - 1);\n  var j = bottom + 1;\n\n  while (n--) {\n    this.lines.splice(j, 0, this.blankLine());\n    this.lines.splice(y, 1);\n    this.olines.splice(j, 0, this.blankLine());\n    this.olines.splice(y, 1);\n  }\n}; // This is how ncurses does it.\n// Scroll down (up cursor-wise).\n// This will only work for top line deletion as opposed to arbitrary lines.\n\n\nScreen.prototype.insertLineNC = function (n, y, top, bottom) {\n  if (!this.tput.strings.change_scroll_region || !this.tput.strings.delete_line) return;\n  this._buf += this.tput.csr(top, bottom);\n  this._buf += this.tput.cup(top, 0);\n  this._buf += this.tput.dl(n);\n  this._buf += this.tput.csr(0, this.height - 1);\n  var j = bottom + 1;\n\n  while (n--) {\n    this.lines.splice(j, 0, this.blankLine());\n    this.lines.splice(y, 1);\n    this.olines.splice(j, 0, this.blankLine());\n    this.olines.splice(y, 1);\n  }\n}; // This is how ncurses does it.\n// Scroll up (down cursor-wise).\n// This will only work for bottom line deletion as opposed to arbitrary lines.\n\n\nScreen.prototype.deleteLineNC = function (n, y, top, bottom) {\n  if (!this.tput.strings.change_scroll_region || !this.tput.strings.delete_line) return;\n  this._buf += this.tput.csr(top, bottom);\n  this._buf += this.tput.cup(bottom, 0);\n  this._buf += Array(n + 1).join('\\n');\n  this._buf += this.tput.csr(0, this.height - 1);\n  var j = bottom + 1;\n\n  while (n--) {\n    this.lines.splice(j, 0, this.blankLine());\n    this.lines.splice(y, 1);\n    this.olines.splice(j, 0, this.blankLine());\n    this.olines.splice(y, 1);\n  }\n};\n\nScreen.prototype.insertBottom = function (top, bottom) {\n  return this.deleteLine(1, top, top, bottom);\n};\n\nScreen.prototype.insertTop = function (top, bottom) {\n  return this.insertLine(1, top, top, bottom);\n};\n\nScreen.prototype.deleteBottom = function (top, bottom) {\n  return this.clearRegion(0, this.width, bottom, bottom);\n};\n\nScreen.prototype.deleteTop = function (top, bottom) {\n  // Same as: return this.insertBottom(top, bottom);\n  return this.deleteLine(1, top, top, bottom);\n}; // Parse the sides of an element to determine\n// whether an element has uniform cells on\n// both sides. If it does, we can use CSR to\n// optimize scrolling on a scrollable element.\n// Not exactly sure how worthwile this is.\n// This will cause a performance/cpu-usage hit,\n// but will it be less or greater than the\n// performance hit of slow-rendering scrollable\n// boxes with clean sides?\n\n\nScreen.prototype.cleanSides = function (el) {\n  var pos = el.lpos;\n\n  if (!pos) {\n    return false;\n  }\n\n  if (pos._cleanSides != null) {\n    return pos._cleanSides;\n  }\n\n  if (pos.xi <= 0 && pos.xl >= this.width) {\n    return pos._cleanSides = true;\n  }\n\n  if (this.options.fastCSR) {\n    // Maybe just do this instead of parsing.\n    if (pos.yi < 0) return pos._cleanSides = false;\n    if (pos.yl > this.height) return pos._cleanSides = false;\n\n    if (this.width - (pos.xl - pos.xi) < 40) {\n      return pos._cleanSides = true;\n    }\n\n    return pos._cleanSides = false;\n  }\n\n  if (!this.options.smartCSR) {\n    return false;\n  } // The scrollbar can't update properly, and there's also a\n  // chance that the scrollbar may get moved around senselessly.\n  // NOTE: In pratice, this doesn't seem to be the case.\n  // if (this.scrollbar) {\n  //   return pos._cleanSides = false;\n  // }\n  // Doesn't matter if we're only a height of 1.\n  // if ((pos.yl - el.ibottom) - (pos.yi + el.itop) <= 1) {\n  //   return pos._cleanSides = false;\n  // }\n\n\n  var yi = pos.yi + el.itop,\n      yl = pos.yl - el.ibottom,\n      first,\n      ch,\n      x,\n      y;\n  if (pos.yi < 0) return pos._cleanSides = false;\n  if (pos.yl > this.height) return pos._cleanSides = false;\n  if (pos.xi - 1 < 0) return pos._cleanSides = true;\n  if (pos.xl > this.width) return pos._cleanSides = true;\n\n  for (x = pos.xi - 1; x >= 0; x--) {\n    if (!this.olines[yi]) break;\n    first = this.olines[yi][x];\n\n    for (y = yi; y < yl; y++) {\n      if (!this.olines[y] || !this.olines[y][x]) break;\n      ch = this.olines[y][x];\n\n      if (ch[0] !== first[0] || ch[1] !== first[1]) {\n        return pos._cleanSides = false;\n      }\n    }\n  }\n\n  for (x = pos.xl; x < this.width; x++) {\n    if (!this.olines[yi]) break;\n    first = this.olines[yi][x];\n\n    for (y = yi; y < yl; y++) {\n      if (!this.olines[y] || !this.olines[y][x]) break;\n      ch = this.olines[y][x];\n\n      if (ch[0] !== first[0] || ch[1] !== first[1]) {\n        return pos._cleanSides = false;\n      }\n    }\n  }\n\n  return pos._cleanSides = true;\n};\n\nScreen.prototype._dockBorders = function () {\n  var lines = this.lines,\n      stops = this._borderStops,\n      i,\n      y,\n      x,\n      ch; // var keys, stop;\n  //\n  // keys = Object.keys(this._borderStops)\n  //   .map(function(k) { return +k; })\n  //   .sort(function(a, b) { return a - b; });\n  //\n  // for (i = 0; i < keys.length; i++) {\n  //   y = keys[i];\n  //   if (!lines[y]) continue;\n  //   stop = this._borderStops[y];\n  //   for (x = stop.xi; x < stop.xl; x++) {\n\n  stops = Object.keys(stops).map(function (k) {\n    return +k;\n  }).sort(function (a, b) {\n    return a - b;\n  });\n\n  for (i = 0; i < stops.length; i++) {\n    y = stops[i];\n    if (!lines[y]) continue;\n\n    for (x = 0; x < this.width; x++) {\n      ch = lines[y][x][1];\n\n      if (angles[ch]) {\n        lines[y][x][1] = this._getAngle(lines, x, y);\n        lines[y].dirty = true;\n      }\n    }\n  }\n};\n\nScreen.prototype._getAngle = function (lines, x, y) {\n  var angle = 0,\n      attr = lines[y][x][0],\n      ch = lines[y][x][1];\n\n  if (lines[y][x - 1] && langles[lines[y][x - 1][1]]) {\n    if (!this.options.ignoreDockContrast) {\n      if (lines[y][x - 1][0] !== attr) return ch;\n    }\n\n    angle |= 1 << 3;\n  }\n\n  if (lines[y - 1] && uangles[lines[y - 1][x][1]]) {\n    if (!this.options.ignoreDockContrast) {\n      if (lines[y - 1][x][0] !== attr) return ch;\n    }\n\n    angle |= 1 << 2;\n  }\n\n  if (lines[y][x + 1] && rangles[lines[y][x + 1][1]]) {\n    if (!this.options.ignoreDockContrast) {\n      if (lines[y][x + 1][0] !== attr) return ch;\n    }\n\n    angle |= 1 << 1;\n  }\n\n  if (lines[y + 1] && dangles[lines[y + 1][x][1]]) {\n    if (!this.options.ignoreDockContrast) {\n      if (lines[y + 1][x][0] !== attr) return ch;\n    }\n\n    angle |= 1 << 0;\n  } // Experimental: fixes this situation:\n  // +----------+\n  //            | <-- empty space here, should be a T angle\n  // +-------+  |\n  // |       |  |\n  // +-------+  |\n  // |          |\n  // +----------+\n  // if (uangles[lines[y][x][1]]) {\n  //   if (lines[y + 1] && cdangles[lines[y + 1][x][1]]) {\n  //     if (!this.options.ignoreDockContrast) {\n  //       if (lines[y + 1][x][0] !== attr) return ch;\n  //     }\n  //     angle |= 1 << 0;\n  //   }\n  // }\n\n\n  return angleTable[angle] || ch;\n};\n\nScreen.prototype.draw = function (start, end) {\n  // this.emit('predraw');\n  var x, y, line, out, ch, data, attr, fg, bg, flags;\n  var main = '',\n      pre,\n      post;\n  var clr, neq, xx;\n  var lx = -1,\n      ly = -1,\n      o;\n  var acs;\n\n  if (this._buf) {\n    main += this._buf;\n    this._buf = '';\n  }\n\n  for (y = start; y <= end; y++) {\n    line = this.lines[y];\n    o = this.olines[y];\n\n    if (!line.dirty && !(this.cursor.artificial && y === this.program.y)) {\n      continue;\n    }\n\n    line.dirty = false;\n    out = '';\n    attr = this.dattr;\n\n    for (x = 0; x < line.length; x++) {\n      data = line[x][0];\n      ch = line[x][1]; // Render the artificial cursor.\n\n      if (this.cursor.artificial && !this.cursor._hidden && this.cursor._state && x === this.program.x && y === this.program.y) {\n        var cattr = this._cursorAttr(this.cursor, data);\n\n        if (cattr.ch) ch = cattr.ch;\n        data = cattr.attr;\n      } // Take advantage of xterm's back_color_erase feature by using a\n      // lookahead. Stop spitting out so many damn spaces. NOTE: Is checking\n      // the bg for non BCE terminals worth the overhead?\n\n\n      if (this.options.useBCE && ch === ' ' && (this.tput.bools.back_color_erase || (data & 0x1ff) === (this.dattr & 0x1ff)) && (data >> 18 & 8) === (this.dattr >> 18 & 8)) {\n        clr = true;\n        neq = false;\n\n        for (xx = x; xx < line.length; xx++) {\n          if (line[xx][0] !== data || line[xx][1] !== ' ') {\n            clr = false;\n            break;\n          }\n\n          if (line[xx][0] !== o[xx][0] || line[xx][1] !== o[xx][1]) {\n            neq = true;\n          }\n        }\n\n        if (clr && neq) {\n          lx = -1, ly = -1;\n\n          if (data !== attr) {\n            out += this.codeAttr(data);\n            attr = data;\n          }\n\n          out += this.tput.cup(y, x);\n          out += this.tput.el();\n\n          for (xx = x; xx < line.length; xx++) {\n            o[xx][0] = data;\n            o[xx][1] = ' ';\n          }\n\n          break;\n        } // If there's more than 10 spaces, use EL regardless\n        // and start over drawing the rest of line. Might\n        // not be worth it. Try to use ECH if the terminal\n        // supports it. Maybe only try to use ECH here.\n        // //if (this.tput.strings.erase_chars)\n        // if (!clr && neq && (xx - x) > 10) {\n        //   lx = -1, ly = -1;\n        //   if (data !== attr) {\n        //     out += this.codeAttr(data);\n        //     attr = data;\n        //   }\n        //   out += this.tput.cup(y, x);\n        //   if (this.tput.strings.erase_chars) {\n        //     // Use erase_chars to avoid erasing the whole line.\n        //     out += this.tput.ech(xx - x);\n        //   } else {\n        //     out += this.tput.el();\n        //   }\n        //   if (this.tput.strings.parm_right_cursor) {\n        //     out += this.tput.cuf(xx - x);\n        //   } else {\n        //     out += this.tput.cup(y, xx);\n        //   }\n        //   this.fillRegion(data, ' ',\n        //     x, this.tput.strings.erase_chars ? xx : line.length,\n        //     y, y + 1);\n        //   x = xx - 1;\n        //   continue;\n        // }\n        // Skip to the next line if the\n        // rest of the line is already drawn.\n        // if (!neq) {\n        //   for (; xx < line.length; xx++) {\n        //     if (line[xx][0] !== o[xx][0] || line[xx][1] !== o[xx][1]) {\n        //       neq = true;\n        //       break;\n        //     }\n        //   }\n        //   if (!neq) {\n        //     attr = data;\n        //     break;\n        //   }\n        // }\n\n      } // Optimize by comparing the real output\n      // buffer to the pending output buffer.\n\n\n      if (data === o[x][0] && ch === o[x][1]) {\n        if (lx === -1) {\n          lx = x;\n          ly = y;\n        }\n\n        continue;\n      } else if (lx !== -1) {\n        if (this.tput.strings.parm_right_cursor) {\n          out += y === ly ? this.tput.cuf(x - lx) : this.tput.cup(y, x);\n        } else {\n          out += this.tput.cup(y, x);\n        }\n\n        lx = -1, ly = -1;\n      }\n\n      o[x][0] = data;\n      o[x][1] = ch;\n\n      if (data !== attr) {\n        if (attr !== this.dattr) {\n          out += '\\x1b[m';\n        }\n\n        if (data !== this.dattr) {\n          out += '\\x1b[';\n          bg = data & 0x1ff;\n          fg = data >> 9 & 0x1ff;\n          flags = data >> 18; // bold\n\n          if (flags & 1) {\n            out += '1;';\n          } // underline\n\n\n          if (flags & 2) {\n            out += '4;';\n          } // blink\n\n\n          if (flags & 4) {\n            out += '5;';\n          } // inverse\n\n\n          if (flags & 8) {\n            out += '7;';\n          } // invisible\n\n\n          if (flags & 16) {\n            out += '8;';\n          }\n\n          if (bg !== 0x1ff) {\n            bg = this._reduceColor(bg);\n\n            if (bg < 16) {\n              if (bg < 8) {\n                bg += 40;\n              } else if (bg < 16) {\n                bg -= 8;\n                bg += 100;\n              }\n\n              out += bg + ';';\n            } else {\n              out += '48;5;' + bg + ';';\n            }\n          }\n\n          if (fg !== 0x1ff) {\n            fg = this._reduceColor(fg);\n\n            if (fg < 16) {\n              if (fg < 8) {\n                fg += 30;\n              } else if (fg < 16) {\n                fg -= 8;\n                fg += 90;\n              }\n\n              out += fg + ';';\n            } else {\n              out += '38;5;' + fg + ';';\n            }\n          }\n\n          if (out[out.length - 1] === ';') out = out.slice(0, -1);\n          out += 'm';\n        }\n      } // If we find a double-width char, eat the next character which should be\n      // a space due to parseContent's behavior.\n\n\n      if (this.fullUnicode) {\n        // If this is a surrogate pair double-width char, we can ignore it\n        // because parseContent already counted it as length=2.\n        if (unicode.charWidth(line[x][1]) === 2) {\n          // NOTE: At cols=44, the bug that is avoided\n          // by the angles check occurs in widget-unicode:\n          // Might also need: `line[x + 1][0] !== line[x][0]`\n          // for borderless boxes?\n          if (x === line.length - 1 || angles[line[x + 1][1]]) {\n            // If we're at the end, we don't have enough space for a\n            // double-width. Overwrite it with a space and ignore.\n            ch = ' ';\n            o[x][1] = '\\0';\n          } else {\n            // ALWAYS refresh double-width chars because this special cursor\n            // behavior is needed. There may be a more efficient way of doing\n            // this. See above.\n            o[x][1] = '\\0'; // Eat the next character by moving forward and marking as a\n            // space (which it is).\n\n            o[++x][1] = '\\0';\n          }\n        }\n      } // Attempt to use ACS for supported characters.\n      // This is not ideal, but it's how ncurses works.\n      // There are a lot of terminals that support ACS\n      // *and UTF8, but do not declare U8. So ACS ends\n      // up being used (slower than utf8). Terminals\n      // that do not support ACS and do not explicitly\n      // support UTF8 get their unicode characters\n      // replaced with really ugly ascii characters.\n      // It is possible there is a terminal out there\n      // somewhere that does not support ACS, but\n      // supports UTF8, but I imagine it's unlikely.\n      // Maybe remove !this.tput.unicode check, however,\n      // this seems to be the way ncurses does it.\n\n\n      if (this.tput.strings.enter_alt_charset_mode && !this.tput.brokenACS && (this.tput.acscr[ch] || acs)) {\n        // Fun fact: even if this.tput.brokenACS wasn't checked here,\n        // the linux console would still work fine because the acs\n        // table would fail the check of: this.tput.acscr[ch]\n        if (this.tput.acscr[ch]) {\n          if (acs) {\n            ch = this.tput.acscr[ch];\n          } else {\n            ch = this.tput.smacs() + this.tput.acscr[ch];\n            acs = true;\n          }\n        } else if (acs) {\n          ch = this.tput.rmacs() + ch;\n          acs = false;\n        }\n      } else {\n        // U8 is not consistently correct. Some terminfo's\n        // terminals that do not declare it may actually\n        // support utf8 (e.g. urxvt), but if the terminal\n        // does not declare support for ACS (and U8), chances\n        // are it does not support UTF8. This is probably\n        // the \"safest\" way to do this. Should fix things\n        // like sun-color.\n        // NOTE: It could be the case that the $LANG\n        // is all that matters in some cases:\n        // if (!this.tput.unicode && ch > '~') {\n        if (!this.tput.unicode && this.tput.numbers.U8 !== 1 && ch > '~') {\n          ch = this.tput.utoa[ch] || '?';\n        }\n      }\n\n      out += ch;\n      attr = data;\n    }\n\n    if (attr !== this.dattr) {\n      out += '\\x1b[m';\n    }\n\n    if (out) {\n      main += this.tput.cup(y, 0) + out;\n    }\n  }\n\n  if (acs) {\n    main += this.tput.rmacs();\n    acs = false;\n  }\n\n  if (main) {\n    pre = '';\n    post = '';\n    pre += this.tput.sc();\n    post += this.tput.rc();\n\n    if (!this.program.cursorHidden) {\n      pre += this.tput.civis();\n      post += this.tput.cnorm();\n    } // this.program.flush();\n    // this.program._owrite(pre + main + post);\n\n\n    this.program._write(pre + main + post);\n  } // this.emit('draw');\n\n};\n\nScreen.prototype._reduceColor = function (color) {\n  return colors.reduce(color, this.tput.colors);\n}; // Convert an SGR string to our own attribute format.\n\n\nScreen.prototype.attrCode = function (code, cur, def) {\n  var flags = cur >> 18 & 0x1ff,\n      fg = cur >> 9 & 0x1ff,\n      bg = cur & 0x1ff,\n      c,\n      i;\n  code = code.slice(2, -1).split(';');\n  if (!code[0]) code[0] = '0';\n\n  for (i = 0; i < code.length; i++) {\n    c = +code[i] || 0;\n\n    switch (c) {\n      case 0:\n        // normal\n        bg = def & 0x1ff;\n        fg = def >> 9 & 0x1ff;\n        flags = def >> 18 & 0x1ff;\n        break;\n\n      case 1:\n        // bold\n        flags |= 1;\n        break;\n\n      case 22:\n        flags = def >> 18 & 0x1ff;\n        break;\n\n      case 4:\n        // underline\n        flags |= 2;\n        break;\n\n      case 24:\n        flags = def >> 18 & 0x1ff;\n        break;\n\n      case 5:\n        // blink\n        flags |= 4;\n        break;\n\n      case 25:\n        flags = def >> 18 & 0x1ff;\n        break;\n\n      case 7:\n        // inverse\n        flags |= 8;\n        break;\n\n      case 27:\n        flags = def >> 18 & 0x1ff;\n        break;\n\n      case 8:\n        // invisible\n        flags |= 16;\n        break;\n\n      case 28:\n        flags = def >> 18 & 0x1ff;\n        break;\n\n      case 39:\n        // default fg\n        fg = def >> 9 & 0x1ff;\n        break;\n\n      case 49:\n        // default bg\n        bg = def & 0x1ff;\n        break;\n\n      case 100:\n        // default fg/bg\n        fg = def >> 9 & 0x1ff;\n        bg = def & 0x1ff;\n        break;\n\n      default:\n        // color\n        if (c === 48 && +code[i + 1] === 5) {\n          i += 2;\n          bg = +code[i];\n          break;\n        } else if (c === 48 && +code[i + 1] === 2) {\n          i += 2;\n          bg = colors.match(+code[i], +code[i + 1], +code[i + 2]);\n          if (bg === -1) bg = def & 0x1ff;\n          i += 2;\n          break;\n        } else if (c === 38 && +code[i + 1] === 5) {\n          i += 2;\n          fg = +code[i];\n          break;\n        } else if (c === 38 && +code[i + 1] === 2) {\n          i += 2;\n          fg = colors.match(+code[i], +code[i + 1], +code[i + 2]);\n          if (fg === -1) fg = def >> 9 & 0x1ff;\n          i += 2;\n          break;\n        }\n\n        if (c >= 40 && c <= 47) {\n          bg = c - 40;\n        } else if (c >= 100 && c <= 107) {\n          bg = c - 100;\n          bg += 8;\n        } else if (c === 49) {\n          bg = def & 0x1ff;\n        } else if (c >= 30 && c <= 37) {\n          fg = c - 30;\n        } else if (c >= 90 && c <= 97) {\n          fg = c - 90;\n          fg += 8;\n        } else if (c === 39) {\n          fg = def >> 9 & 0x1ff;\n        } else if (c === 100) {\n          fg = def >> 9 & 0x1ff;\n          bg = def & 0x1ff;\n        }\n\n        break;\n    }\n  }\n\n  return flags << 18 | fg << 9 | bg;\n}; // Convert our own attribute format to an SGR string.\n\n\nScreen.prototype.codeAttr = function (code) {\n  var flags = code >> 18 & 0x1ff,\n      fg = code >> 9 & 0x1ff,\n      bg = code & 0x1ff,\n      out = ''; // bold\n\n  if (flags & 1) {\n    out += '1;';\n  } // underline\n\n\n  if (flags & 2) {\n    out += '4;';\n  } // blink\n\n\n  if (flags & 4) {\n    out += '5;';\n  } // inverse\n\n\n  if (flags & 8) {\n    out += '7;';\n  } // invisible\n\n\n  if (flags & 16) {\n    out += '8;';\n  }\n\n  if (bg !== 0x1ff) {\n    bg = this._reduceColor(bg);\n\n    if (bg < 16) {\n      if (bg < 8) {\n        bg += 40;\n      } else if (bg < 16) {\n        bg -= 8;\n        bg += 100;\n      }\n\n      out += bg + ';';\n    } else {\n      out += '48;5;' + bg + ';';\n    }\n  }\n\n  if (fg !== 0x1ff) {\n    fg = this._reduceColor(fg);\n\n    if (fg < 16) {\n      if (fg < 8) {\n        fg += 30;\n      } else if (fg < 16) {\n        fg -= 8;\n        fg += 90;\n      }\n\n      out += fg + ';';\n    } else {\n      out += '38;5;' + fg + ';';\n    }\n  }\n\n  if (out[out.length - 1] === ';') out = out.slice(0, -1);\n  return '\\x1b[' + out + 'm';\n};\n\nScreen.prototype.focusOffset = function (offset) {\n  var shown = this.keyable.filter(function (el) {\n    return !el.detached && el.visible;\n  }).length;\n\n  if (!shown || !offset) {\n    return;\n  }\n\n  var i = this.keyable.indexOf(this.focused);\n  if (!~i) return;\n\n  if (offset > 0) {\n    while (offset--) {\n      if (++i > this.keyable.length - 1) i = 0;\n      if (this.keyable[i].detached || !this.keyable[i].visible) offset++;\n    }\n  } else {\n    offset = -offset;\n\n    while (offset--) {\n      if (--i < 0) i = this.keyable.length - 1;\n      if (this.keyable[i].detached || !this.keyable[i].visible) offset++;\n    }\n  }\n\n  return this.keyable[i].focus();\n};\n\nScreen.prototype.focusPrev = Screen.prototype.focusPrevious = function () {\n  return this.focusOffset(-1);\n};\n\nScreen.prototype.focusNext = function () {\n  return this.focusOffset(1);\n};\n\nScreen.prototype.focusPush = function (el) {\n  if (!el) return;\n  var old = this.history[this.history.length - 1];\n\n  if (this.history.length === 10) {\n    this.history.shift();\n  }\n\n  this.history.push(el);\n\n  this._focus(el, old);\n};\n\nScreen.prototype.focusPop = function () {\n  var old = this.history.pop();\n\n  if (this.history.length) {\n    this._focus(this.history[this.history.length - 1], old);\n  }\n\n  return old;\n};\n\nScreen.prototype.saveFocus = function () {\n  return this._savedFocus = this.focused;\n};\n\nScreen.prototype.restoreFocus = function () {\n  if (!this._savedFocus) return;\n\n  this._savedFocus.focus();\n\n  delete this._savedFocus;\n  return this.focused;\n};\n\nScreen.prototype.rewindFocus = function () {\n  var old = this.history.pop(),\n      el;\n\n  while (this.history.length) {\n    el = this.history.pop();\n\n    if (!el.detached && el.visible) {\n      this.history.push(el);\n\n      this._focus(el, old);\n\n      return el;\n    }\n  }\n\n  if (old) {\n    old.emit('blur');\n  }\n};\n\nScreen.prototype._focus = function (self, old) {\n  // Find a scrollable ancestor if we have one.\n  var el = self;\n\n  while (el = el.parent) {\n    if (el.scrollable) break;\n  } // If we're in a scrollable element,\n  // automatically scroll to the focused element.\n\n\n  if (el && !el.detached) {\n    // NOTE: This is different from the other \"visible\" values - it needs the\n    // visible height of the scrolling element itself, not the element within\n    // it.\n    var visible = self.screen.height - el.atop - el.itop - el.abottom - el.ibottom;\n\n    if (self.rtop < el.childBase) {\n      el.scrollTo(self.rtop);\n      self.screen.render();\n    } else if (self.rtop + self.height - self.ibottom > el.childBase + visible) {\n      // Explanation for el.itop here: takes into account scrollable elements\n      // with borders otherwise the element gets covered by the bottom border:\n      el.scrollTo(self.rtop - (el.height - self.height) + el.itop, true);\n      self.screen.render();\n    }\n  }\n\n  if (old) {\n    old.emit('blur', self);\n  }\n\n  self.emit('focus', old);\n};\n\nScreen.prototype.__defineGetter__('focused', function () {\n  return this.history[this.history.length - 1];\n});\n\nScreen.prototype.__defineSetter__('focused', function (el) {\n  return this.focusPush(el);\n});\n\nScreen.prototype.clearRegion = function (xi, xl, yi, yl, override) {\n  return this.fillRegion(this.dattr, ' ', xi, xl, yi, yl, override);\n};\n\nScreen.prototype.fillRegion = function (attr, ch, xi, xl, yi, yl, override) {\n  var lines = this.lines,\n      cell,\n      xx;\n  if (xi < 0) xi = 0;\n  if (yi < 0) yi = 0;\n\n  for (; yi < yl; yi++) {\n    if (!lines[yi]) break;\n\n    for (xx = xi; xx < xl; xx++) {\n      cell = lines[yi][xx];\n      if (!cell) break;\n\n      if (override || attr !== cell[0] || ch !== cell[1]) {\n        lines[yi][xx][0] = attr;\n        lines[yi][xx][1] = ch;\n        lines[yi].dirty = true;\n      }\n    }\n  }\n};\n\nScreen.prototype.key = function () {\n  return this.program.key.apply(this, arguments);\n};\n\nScreen.prototype.onceKey = function () {\n  return this.program.onceKey.apply(this, arguments);\n};\n\nScreen.prototype.unkey = Screen.prototype.removeKey = function () {\n  return this.program.unkey.apply(this, arguments);\n};\n\nScreen.prototype.spawn = function (file, args, options) {\n  if (!Array.isArray(args)) {\n    options = args;\n    args = [];\n  }\n\n  var screen = this,\n      program = screen.program,\n      spawn = require('child_process').spawn,\n      mouse = program.mouseEnabled,\n      ps;\n\n  options = options || {};\n  options.stdio = options.stdio || 'inherit';\n  program.lsaveCursor('spawn'); // program.csr(0, program.rows - 1);\n\n  program.normalBuffer();\n  program.showCursor();\n  if (mouse) program.disableMouse();\n  var write = program.output.write;\n\n  program.output.write = function () {};\n\n  program.input.pause();\n\n  if (program.input.setRawMode) {\n    program.input.setRawMode(false);\n  }\n\n  var resume = function () {\n    if (resume.done) return;\n    resume.done = true;\n\n    if (program.input.setRawMode) {\n      program.input.setRawMode(true);\n    }\n\n    program.input.resume();\n    program.output.write = write;\n    program.alternateBuffer(); // program.csr(0, program.rows - 1);\n\n    if (mouse) {\n      program.enableMouse();\n\n      if (screen.options.sendFocus) {\n        screen.program.setMouse({\n          sendFocus: true\n        }, true);\n      }\n    }\n\n    screen.alloc();\n    screen.render();\n    screen.program.lrestoreCursor('spawn', true);\n  };\n\n  ps = spawn(file, args, options);\n  ps.on('error', resume);\n  ps.on('exit', resume);\n  return ps;\n};\n\nScreen.prototype.exec = function (file, args, options, callback) {\n  var ps = this.spawn(file, args, options);\n  ps.on('error', function (err) {\n    if (!callback) return;\n    return callback(err, false);\n  });\n  ps.on('exit', function (code) {\n    if (!callback) return;\n    return callback(null, code === 0);\n  });\n  return ps;\n};\n\nScreen.prototype.readEditor = function (options, callback) {\n  if (typeof options === 'string') {\n    options = {\n      editor: options\n    };\n  }\n\n  if (!callback) {\n    callback = options;\n    options = null;\n  }\n\n  if (!callback) {\n    callback = function () {};\n  }\n\n  options = options || {};\n  var self = this,\n      editor = options.editor || process.env.EDITOR || 'vi',\n      name = options.name || process.title || 'blessed',\n      rnd = Math.random().toString(36).split('.').pop(),\n      file = '/tmp/' + name + '.' + rnd,\n      args = [file],\n      opt;\n  opt = {\n    stdio: 'inherit',\n    env: process.env,\n    cwd: process.env.HOME\n  };\n\n  function writeFile(callback) {\n    if (!options.value) return callback();\n    return fs.writeFile(file, options.value, callback);\n  }\n\n  return writeFile(function (err) {\n    if (err) return callback(err);\n    return self.exec(editor, args, opt, function (err, success) {\n      if (err) return callback(err);\n      return fs.readFile(file, 'utf8', function (err, data) {\n        return fs.unlink(file, function () {\n          if (!success) return callback(new Error('Unsuccessful.'));\n          if (err) return callback(err);\n          return callback(null, data);\n        });\n      });\n    });\n  });\n};\n\nScreen.prototype.displayImage = function (file, callback) {\n  if (!file) {\n    if (!callback) return;\n    return callback(new Error('No image.'));\n  }\n\n  file = path.resolve(process.cwd(), file);\n\n  if (!~file.indexOf('://')) {\n    file = 'file://' + file;\n  }\n\n  var args = ['w3m', '-T', 'text/html'];\n  var input = '<title>press q to exit</title>' + '<img align=\"center\" src=\"' + file + '\">';\n  var opt = {\n    stdio: ['pipe', 1, 2],\n    env: process.env,\n    cwd: process.env.HOME\n  };\n  var ps = this.spawn(args[0], args.slice(1), opt);\n  ps.on('error', function (err) {\n    if (!callback) return;\n    return callback(err);\n  });\n  ps.on('exit', function (code) {\n    if (!callback) return;\n    if (code !== 0) return callback(new Error('Exit Code: ' + code));\n    return callback(null, code === 0);\n  });\n  ps.stdin.write(input + '\\n');\n  ps.stdin.end();\n};\n\nScreen.prototype.setEffects = function (el, fel, over, out, effects, temp) {\n  if (!effects) return;\n  var tmp = {};\n  if (temp) el[temp] = tmp;\n\n  if (typeof el !== 'function') {\n    var _el = el;\n\n    el = function () {\n      return _el;\n    };\n  }\n\n  fel.on(over, function () {\n    var element = el();\n    Object.keys(effects).forEach(function (key) {\n      var val = effects[key];\n\n      if (val !== null && typeof val === 'object') {\n        tmp[key] = tmp[key] || {}; // element.style[key] = element.style[key] || {};\n\n        Object.keys(val).forEach(function (k) {\n          var v = val[k];\n          tmp[key][k] = element.style[key][k];\n          element.style[key][k] = v;\n        });\n        return;\n      }\n\n      tmp[key] = element.style[key];\n      element.style[key] = val;\n    });\n    element.screen.render();\n  });\n  fel.on(out, function () {\n    var element = el();\n    Object.keys(effects).forEach(function (key) {\n      var val = effects[key];\n\n      if (val !== null && typeof val === 'object') {\n        tmp[key] = tmp[key] || {}; // element.style[key] = element.style[key] || {};\n\n        Object.keys(val).forEach(function (k) {\n          if (tmp[key].hasOwnProperty(k)) {\n            element.style[key][k] = tmp[key][k];\n          }\n        });\n        return;\n      }\n\n      if (tmp.hasOwnProperty(key)) {\n        element.style[key] = tmp[key];\n      }\n    });\n    element.screen.render();\n  });\n};\n\nScreen.prototype.sigtstp = function (callback) {\n  var self = this;\n  this.program.sigtstp(function () {\n    self.alloc();\n    self.render();\n    self.program.lrestoreCursor('pause', true);\n    if (callback) callback();\n  });\n};\n\nScreen.prototype.copyToClipboard = function (text) {\n  return this.program.copyToClipboard(text);\n};\n\nScreen.prototype.cursorShape = function (shape, blink) {\n  var self = this;\n  this.cursor.shape = shape || 'block';\n  this.cursor.blink = blink || false;\n  this.cursor._set = true;\n\n  if (this.cursor.artificial) {\n    if (!this.program.hideCursor_old) {\n      var hideCursor = this.program.hideCursor;\n      this.program.hideCursor_old = this.program.hideCursor;\n\n      this.program.hideCursor = function () {\n        hideCursor.call(self.program);\n        self.cursor._hidden = true;\n        if (self.renders) self.render();\n      };\n    }\n\n    if (!this.program.showCursor_old) {\n      var showCursor = this.program.showCursor;\n      this.program.showCursor_old = this.program.showCursor;\n\n      this.program.showCursor = function () {\n        self.cursor._hidden = false;\n        if (self.program._exiting) showCursor.call(self.program);\n        if (self.renders) self.render();\n      };\n    }\n\n    if (!this._cursorBlink) {\n      this._cursorBlink = setInterval(function () {\n        if (!self.cursor.blink) return;\n        self.cursor._state ^= 1;\n        if (self.renders) self.render();\n      }, 500);\n\n      if (this._cursorBlink.unref) {\n        this._cursorBlink.unref();\n      }\n    }\n\n    return true;\n  }\n\n  return this.program.cursorShape(this.cursor.shape, this.cursor.blink);\n};\n\nScreen.prototype.cursorColor = function (color) {\n  this.cursor.color = color != null ? colors.convert(color) : null;\n  this.cursor._set = true;\n\n  if (this.cursor.artificial) {\n    return true;\n  }\n\n  return this.program.cursorColor(colors.ncolors[this.cursor.color]);\n};\n\nScreen.prototype.cursorReset = Screen.prototype.resetCursor = function () {\n  this.cursor.shape = 'block';\n  this.cursor.blink = false;\n  this.cursor.color = null;\n  this.cursor._set = false;\n\n  if (this.cursor.artificial) {\n    this.cursor.artificial = false;\n\n    if (this.program.hideCursor_old) {\n      this.program.hideCursor = this.program.hideCursor_old;\n      delete this.program.hideCursor_old;\n    }\n\n    if (this.program.showCursor_old) {\n      this.program.showCursor = this.program.showCursor_old;\n      delete this.program.showCursor_old;\n    }\n\n    if (this._cursorBlink) {\n      clearInterval(this._cursorBlink);\n      delete this._cursorBlink;\n    }\n\n    return true;\n  }\n\n  return this.program.cursorReset();\n};\n\nScreen.prototype._cursorAttr = function (cursor, dattr) {\n  var attr = dattr || this.dattr,\n      cattr,\n      ch;\n\n  if (cursor.shape === 'line') {\n    attr &= ~(0x1ff << 9);\n    attr |= 7 << 9;\n    ch = '\\u2502';\n  } else if (cursor.shape === 'underline') {\n    attr &= ~(0x1ff << 9);\n    attr |= 7 << 9;\n    attr |= 2 << 18;\n  } else if (cursor.shape === 'block') {\n    attr &= ~(0x1ff << 9);\n    attr |= 7 << 9;\n    attr |= 8 << 18;\n  } else if (typeof cursor.shape === 'object' && cursor.shape) {\n    cattr = Element.prototype.sattr.call(cursor, cursor.shape);\n\n    if (cursor.shape.bold || cursor.shape.underline || cursor.shape.blink || cursor.shape.inverse || cursor.shape.invisible) {\n      attr &= ~(0x1ff << 18);\n      attr |= (cattr >> 18 & 0x1ff) << 18;\n    }\n\n    if (cursor.shape.fg) {\n      attr &= ~(0x1ff << 9);\n      attr |= (cattr >> 9 & 0x1ff) << 9;\n    }\n\n    if (cursor.shape.bg) {\n      attr &= ~(0x1ff << 0);\n      attr |= cattr & 0x1ff;\n    }\n\n    if (cursor.shape.ch) {\n      ch = cursor.shape.ch;\n    }\n  }\n\n  if (cursor.color != null) {\n    attr &= ~(0x1ff << 9);\n    attr |= cursor.color << 9;\n  }\n\n  return {\n    ch: ch,\n    attr: attr\n  };\n};\n\nScreen.prototype.screenshot = function (xi, xl, yi, yl, term) {\n  if (xi == null) xi = 0;\n  if (xl == null) xl = this.cols;\n  if (yi == null) yi = 0;\n  if (yl == null) yl = this.rows;\n  if (xi < 0) xi = 0;\n  if (yi < 0) yi = 0;\n  var x, y, line, out, ch, data, attr;\n  var sdattr = this.dattr;\n\n  if (term) {\n    this.dattr = term.defAttr;\n  }\n\n  var main = '';\n\n  for (y = yi; y < yl; y++) {\n    line = term ? term.lines[y] : this.lines[y];\n    if (!line) break;\n    out = '';\n    attr = this.dattr;\n\n    for (x = xi; x < xl; x++) {\n      if (!line[x]) break;\n      data = line[x][0];\n      ch = line[x][1];\n\n      if (data !== attr) {\n        if (attr !== this.dattr) {\n          out += '\\x1b[m';\n        }\n\n        if (data !== this.dattr) {\n          var _data = data;\n\n          if (term) {\n            if ((_data >> 9 & 0x1ff) === 257) _data |= 0x1ff << 9;\n            if ((_data & 0x1ff) === 256) _data |= 0x1ff;\n          }\n\n          out += this.codeAttr(_data);\n        }\n      }\n\n      if (this.fullUnicode) {\n        if (unicode.charWidth(line[x][1]) === 2) {\n          if (x === xl - 1) {\n            ch = ' ';\n          } else {\n            x++;\n          }\n        }\n      }\n\n      out += ch;\n      attr = data;\n    }\n\n    if (attr !== this.dattr) {\n      out += '\\x1b[m';\n    }\n\n    if (out) {\n      main += (y > 0 ? '\\n' : '') + out;\n    }\n  }\n\n  main = main.replace(/(?:\\s*\\x1b\\[40m\\s*\\x1b\\[m\\s*)*$/, '') + '\\n';\n\n  if (term) {\n    this.dattr = sdattr;\n  }\n\n  return main;\n};\n/**\n * Positioning\n */\n\n\nScreen.prototype._getPos = function () {\n  return this;\n};\n/**\n * Angle Table\n */\n\n\nvar angles = {\n  '\\u2518': true,\n  // ''\n  '\\u2510': true,\n  // ''\n  '\\u250c': true,\n  // ''\n  '\\u2514': true,\n  // ''\n  '\\u253c': true,\n  // ''\n  '\\u251c': true,\n  // ''\n  '\\u2524': true,\n  // ''\n  '\\u2534': true,\n  // ''\n  '\\u252c': true,\n  // ''\n  '\\u2502': true,\n  // ''\n  '\\u2500': true // ''\n\n};\nvar langles = {\n  '\\u250c': true,\n  // ''\n  '\\u2514': true,\n  // ''\n  '\\u253c': true,\n  // ''\n  '\\u251c': true,\n  // ''\n  '\\u2534': true,\n  // ''\n  '\\u252c': true,\n  // ''\n  '\\u2500': true // ''\n\n};\nvar uangles = {\n  '\\u2510': true,\n  // ''\n  '\\u250c': true,\n  // ''\n  '\\u253c': true,\n  // ''\n  '\\u251c': true,\n  // ''\n  '\\u2524': true,\n  // ''\n  '\\u252c': true,\n  // ''\n  '\\u2502': true // ''\n\n};\nvar rangles = {\n  '\\u2518': true,\n  // ''\n  '\\u2510': true,\n  // ''\n  '\\u253c': true,\n  // ''\n  '\\u2524': true,\n  // ''\n  '\\u2534': true,\n  // ''\n  '\\u252c': true,\n  // ''\n  '\\u2500': true // ''\n\n};\nvar dangles = {\n  '\\u2518': true,\n  // ''\n  '\\u2514': true,\n  // ''\n  '\\u253c': true,\n  // ''\n  '\\u251c': true,\n  // ''\n  '\\u2524': true,\n  // ''\n  '\\u2534': true,\n  // ''\n  '\\u2502': true // ''\n\n}; // var cdangles = {\n//   '\\u250c': true  // ''\n// };\n// Every ACS angle character can be\n// represented by 4 bits ordered like this:\n// [langle][uangle][rangle][dangle]\n\nvar angleTable = {\n  '0000': '',\n  // ?\n  '0001': '\\u2502',\n  // '' // ?\n  '0010': '\\u2500',\n  // '' // ??\n  '0011': '\\u250c',\n  // ''\n  '0100': '\\u2502',\n  // '' // ?\n  '0101': '\\u2502',\n  // ''\n  '0110': '\\u2514',\n  // ''\n  '0111': '\\u251c',\n  // ''\n  '1000': '\\u2500',\n  // '' // ??\n  '1001': '\\u2510',\n  // ''\n  '1010': '\\u2500',\n  // '' // ??\n  '1011': '\\u252c',\n  // ''\n  '1100': '\\u2518',\n  // ''\n  '1101': '\\u2524',\n  // ''\n  '1110': '\\u2534',\n  // ''\n  '1111': '\\u253c' // ''\n\n};\nObject.keys(angleTable).forEach(function (key) {\n  angleTable[parseInt(key, 2)] = angleTable[key];\n  delete angleTable[key];\n});\n/**\n * Expose\n */\n\nmodule.exports = Screen;","map":{"version":3,"sources":["/Users/samianki/node_modules/blessed/lib/widgets/screen.js"],"names":["path","require","fs","cp","colors","program","unicode","nextTick","global","setImmediate","process","bind","helpers","Node","Log","Element","Box","Screen","options","self","rsety","listen","input","output","log","debug","dump","terminal","term","resizeTimeout","forceUnicode","tput","buffer","zero","setupTput","useBuffer","features","call","autoPadding","tabc","Array","tabSize","join","dockBorders","ignoreLocked","_unicode","numbers","U8","fullUnicode","dattr","renders","position","left","aleft","rleft","right","aright","rright","top","atop","rtop","bottom","abottom","rbottom","height","width","ileft","itop","iright","ibottom","iheight","iwidth","padding","hover","history","clickable","keyable","grabKeys","lockKeys","focused","_buf","_ci","title","cursor","artificial","artificialCursor","shape","cursorShape","blink","cursorBlink","color","cursorColor","_set","_state","_hidden","on","alloc","render","emit","el","children","forEach","text","fn","type","indexOf","_listenKeys","_listenMouse","setMaxListeners","Infinity","enter","postEnter","total","instances","screen","push","index","_bound","_exceptionHandler","err","listeners","length","slice","destroy","Error","console","error","stack","exit","signal","name","toLowerCase","_exitHandler","prototype","__proto__","__defineGetter__","__defineSetter__","setTerminal","entered","isAlt","leave","platform","execSync","stdio","timeout","e","alternateBuffer","put","keypad_xmit","csr","hideCursor","cup","strings","ena_acs","_write","enacs","keypad_local","scrollTop","scrollBottom","rows","showCursor","_listenedMouse","disableMouse","normalBuffer","cursorReset","flush","debugLog","parent","hidden","draggable","border","label","tags","keys","vi","mouse","scrollbar","ch","track","bg","style","inverse","toggle","saveFocus","show","setFront","focus","hide","restoreFocus","key","warnings","warning","align","valign","content","setTimeout","unref","_destroy","splice","removeListener","_sigtermHandler","_sigintHandler","_sigquitHandler","destroyed","apply","arguments","enableMouse","sendFocus","setMouse","_needsClickableSort","data","hsort","i","set","pos","detached","visible","lpos","x","xi","xl","y","yi","yl","action","mouseDown","autoFocus","_listenedKeys","full","enableKeys","enableInput","_initHover","_hoverText","fg","_hoverOptions","parseTags","setContent","append","detach","getContent","cols","dirty","lines","olines","clear","realloc","_borderStops","_dockBorders","draw","_updateCursor","blankLine","out","insertLine","n","change_scroll_region","delete_line","insert_line","il","j","deleteLine","dl","insertLineNC","deleteLineNC","insertBottom","insertTop","deleteBottom","clearRegion","deleteTop","cleanSides","_cleanSides","fastCSR","smartCSR","first","stops","Object","map","k","sort","a","b","angles","_getAngle","angle","attr","langles","ignoreDockContrast","uangles","rangles","dangles","angleTable","start","end","line","flags","main","pre","post","clr","neq","xx","lx","ly","o","acs","cattr","_cursorAttr","useBCE","bools","back_color_erase","codeAttr","parm_right_cursor","cuf","_reduceColor","charWidth","enter_alt_charset_mode","brokenACS","acscr","smacs","rmacs","utoa","sc","rc","cursorHidden","civis","cnorm","reduce","attrCode","code","cur","def","c","split","match","focusOffset","offset","shown","filter","focusPrev","focusPrevious","focusNext","focusPush","old","shift","_focus","focusPop","pop","_savedFocus","rewindFocus","scrollable","childBase","scrollTo","override","fillRegion","cell","onceKey","unkey","removeKey","spawn","file","args","isArray","mouseEnabled","ps","lsaveCursor","write","pause","setRawMode","resume","done","lrestoreCursor","exec","callback","readEditor","editor","env","EDITOR","rnd","Math","random","toString","opt","cwd","HOME","writeFile","value","success","readFile","unlink","displayImage","resolve","stdin","setEffects","fel","over","effects","temp","tmp","_el","element","val","v","hasOwnProperty","sigtstp","copyToClipboard","hideCursor_old","showCursor_old","_exiting","_cursorBlink","setInterval","convert","ncolors","resetCursor","clearInterval","sattr","bold","underline","invisible","screenshot","sdattr","defAttr","_data","replace","_getPos","parseInt","module","exports"],"mappings":"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","sourcesContent":["/**\n * screen.js - screen node for blessed\n * Copyright (c) 2013-2015, Christopher Jeffrey and contributors (MIT License).\n * https://github.com/chjj/blessed\n */\n\n/**\n * Modules\n */\n\nvar path = require('path')\n  , fs = require('fs')\n  , cp = require('child_process');\n\nvar colors = require('../colors')\n  , program = require('../program')\n  , unicode = require('../unicode');\n\nvar nextTick = global.setImmediate || process.nextTick.bind(process);\n\nvar helpers = require('../helpers');\n\nvar Node = require('./node');\nvar Log = require('./log');\nvar Element = require('./element');\nvar Box = require('./box');\n\n/**\n * Screen\n */\n\nfunction Screen(options) {\n  var self = this;\n\n  if (!(this instanceof Node)) {\n    return new Screen(options);\n  }\n\n  Screen.bind(this);\n\n  options = options || {};\n  if (options.rsety && options.listen) {\n    options = { program: options };\n  }\n\n  this.program = options.program;\n\n  if (!this.program) {\n    this.program = program({\n      input: options.input,\n      output: options.output,\n      log: options.log,\n      debug: options.debug,\n      dump: options.dump,\n      terminal: options.terminal || options.term,\n      resizeTimeout: options.resizeTimeout,\n      forceUnicode: options.forceUnicode,\n      tput: true,\n      buffer: true,\n      zero: true\n    });\n  } else {\n    this.program.setupTput();\n    this.program.useBuffer = true;\n    this.program.zero = true;\n    this.program.options.resizeTimeout = options.resizeTimeout;\n    if (options.forceUnicode != null) {\n      this.program.tput.features.unicode = options.forceUnicode;\n      this.program.tput.unicode = options.forceUnicode;\n    }\n  }\n\n  this.tput = this.program.tput;\n\n  Node.call(this, options);\n\n  this.autoPadding = options.autoPadding !== false;\n  this.tabc = Array((options.tabSize || 4) + 1).join(' ');\n  this.dockBorders = options.dockBorders;\n\n  this.ignoreLocked = options.ignoreLocked || [];\n\n  this._unicode = this.tput.unicode || this.tput.numbers.U8 === 1;\n  this.fullUnicode = this.options.fullUnicode && this._unicode;\n\n  this.dattr = ((0 << 18) | (0x1ff << 9)) | 0x1ff;\n\n  this.renders = 0;\n  this.position = {\n    left: this.left = this.aleft = this.rleft = 0,\n    right: this.right = this.aright = this.rright = 0,\n    top: this.top = this.atop = this.rtop = 0,\n    bottom: this.bottom = this.abottom = this.rbottom = 0,\n    get height() { return self.height; },\n    get width() { return self.width; }\n  };\n\n  this.ileft = 0;\n  this.itop = 0;\n  this.iright = 0;\n  this.ibottom = 0;\n  this.iheight = 0;\n  this.iwidth = 0;\n\n  this.padding = {\n    left: 0,\n    top: 0,\n    right: 0,\n    bottom: 0\n  };\n\n  this.hover = null;\n  this.history = [];\n  this.clickable = [];\n  this.keyable = [];\n  this.grabKeys = false;\n  this.lockKeys = false;\n  this.focused;\n  this._buf = '';\n\n  this._ci = -1;\n\n  if (options.title) {\n    this.title = options.title;\n  }\n\n  options.cursor = options.cursor || {\n    artificial: options.artificialCursor,\n    shape: options.cursorShape,\n    blink: options.cursorBlink,\n    color: options.cursorColor\n  };\n\n  this.cursor = {\n    artificial: options.cursor.artificial || false,\n    shape: options.cursor.shape || 'block',\n    blink: options.cursor.blink || false,\n    color: options.cursor.color || null,\n    _set: false,\n    _state: 1,\n    _hidden: true\n  };\n\n  this.program.on('resize', function() {\n    self.alloc();\n    self.render();\n    (function emit(el) {\n      el.emit('resize');\n      el.children.forEach(emit);\n    })(self);\n  });\n\n  this.program.on('focus', function() {\n    self.emit('focus');\n  });\n\n  this.program.on('blur', function() {\n    self.emit('blur');\n  });\n\n  this.program.on('warning', function(text) {\n    self.emit('warning', text);\n  });\n\n  this.on('newListener', function fn(type) {\n    if (type === 'keypress' || type.indexOf('key ') === 0 || type === 'mouse') {\n      if (type === 'keypress' || type.indexOf('key ') === 0) self._listenKeys();\n      if (type === 'mouse') self._listenMouse();\n    }\n    if (type === 'mouse'\n      || type === 'click'\n      || type === 'mouseover'\n      || type === 'mouseout'\n      || type === 'mousedown'\n      || type === 'mouseup'\n      || type === 'mousewheel'\n      || type === 'wheeldown'\n      || type === 'wheelup'\n      || type === 'mousemove') {\n      self._listenMouse();\n    }\n  });\n\n  this.setMaxListeners(Infinity);\n\n  this.enter();\n\n  this.postEnter();\n}\n\nScreen.global = null;\n\nScreen.total = 0;\n\nScreen.instances = [];\n\nScreen.bind = function(screen) {\n  if (!Screen.global) {\n    Screen.global = screen;\n  }\n\n  if (!~Screen.instances.indexOf(screen)) {\n    Screen.instances.push(screen);\n    screen.index = Screen.total;\n    Screen.total++;\n  }\n\n  if (Screen._bound) return;\n  Screen._bound = true;\n\n  process.on('uncaughtException', Screen._exceptionHandler = function(err) {\n    if (process.listeners('uncaughtException').length > 1) {\n      return;\n    }\n    Screen.instances.slice().forEach(function(screen) {\n      screen.destroy();\n    });\n    err = err || new Error('Uncaught Exception.');\n    console.error(err.stack ? err.stack + '' : err + '');\n    nextTick(function() {\n      process.exit(1);\n    });\n  });\n\n  ['SIGTERM', 'SIGINT', 'SIGQUIT'].forEach(function(signal) {\n    var name = '_' + signal.toLowerCase() + 'Handler';\n    process.on(signal, Screen[name] = function() {\n      if (process.listeners(signal).length > 1) {\n        return;\n      }\n      nextTick(function() {\n        process.exit(0);\n      });\n    });\n  });\n\n  process.on('exit', Screen._exitHandler = function() {\n    Screen.instances.slice().forEach(function(screen) {\n      screen.destroy();\n    });\n  });\n};\n\nScreen.prototype.__proto__ = Node.prototype;\n\nScreen.prototype.type = 'screen';\n\nScreen.prototype.__defineGetter__('title', function() {\n  return this.program.title;\n});\n\nScreen.prototype.__defineSetter__('title', function(title) {\n  return this.program.title = title;\n});\n\nScreen.prototype.__defineGetter__('terminal', function() {\n  return this.program.terminal;\n});\n\nScreen.prototype.__defineSetter__('terminal', function(terminal) {\n  this.setTerminal(terminal);\n  return this.program.terminal;\n});\n\nScreen.prototype.setTerminal = function(terminal) {\n  var entered = !!this.program.isAlt;\n  if (entered) {\n    this._buf = '';\n    this.program._buf = '';\n    this.leave();\n  }\n  this.program.setTerminal(terminal);\n  this.tput = this.program.tput;\n  if (entered) {\n    this.enter();\n  }\n};\n\nScreen.prototype.enter = function() {\n  if (this.program.isAlt) return;\n  if (!this.cursor._set) {\n    if (this.options.cursor.shape) {\n      this.cursorShape(this.cursor.shape, this.cursor.blink);\n    }\n    if (this.options.cursor.color) {\n      this.cursorColor(this.cursor.color);\n    }\n  }\n  if (process.platform === 'win32') {\n    try {\n      cp.execSync('cls', { stdio: 'ignore', timeout: 1000 });\n    } catch (e) {\n      ;\n    }\n  }\n  this.program.alternateBuffer();\n  this.program.put.keypad_xmit();\n  this.program.csr(0, this.height - 1);\n  this.program.hideCursor();\n  this.program.cup(0, 0);\n  // We need this for tmux now:\n  if (this.tput.strings.ena_acs) {\n    this.program._write(this.tput.enacs());\n  }\n  this.alloc();\n};\n\nScreen.prototype.leave = function() {\n  if (!this.program.isAlt) return;\n  this.program.put.keypad_local();\n  if (this.program.scrollTop !== 0\n      || this.program.scrollBottom !== this.rows - 1) {\n    this.program.csr(0, this.height - 1);\n  }\n  // XXX For some reason if alloc/clear() is before this\n  // line, it doesn't work on linux console.\n  this.program.showCursor();\n  this.alloc();\n  if (this._listenedMouse) {\n    this.program.disableMouse();\n  }\n  this.program.normalBuffer();\n  if (this.cursor._set) this.cursorReset();\n  this.program.flush();\n  if (process.platform === 'win32') {\n    try {\n      cp.execSync('cls', { stdio: 'ignore', timeout: 1000 });\n    } catch (e) {\n      ;\n    }\n  }\n};\n\nScreen.prototype.postEnter = function() {\n  var self = this;\n  if (this.options.debug) {\n    this.debugLog = new Log({\n      screen: this,\n      parent: this,\n      hidden: true,\n      draggable: true,\n      left: 'center',\n      top: 'center',\n      width: '30%',\n      height: '30%',\n      border: 'line',\n      label: ' {bold}Debug Log{/bold} ',\n      tags: true,\n      keys: true,\n      vi: true,\n      mouse: true,\n      scrollbar: {\n        ch: ' ',\n        track: {\n          bg: 'yellow'\n        },\n        style: {\n          inverse: true\n        }\n      }\n    });\n\n    this.debugLog.toggle = function() {\n      if (self.debugLog.hidden) {\n        self.saveFocus();\n        self.debugLog.show();\n        self.debugLog.setFront();\n        self.debugLog.focus();\n      } else {\n        self.debugLog.hide();\n        self.restoreFocus();\n      }\n      self.render();\n    };\n\n    this.debugLog.key(['q', 'escape'], self.debugLog.toggle);\n    this.key('f12', self.debugLog.toggle);\n  }\n\n  if (this.options.warnings) {\n    this.on('warning', function(text) {\n      var warning = new Box({\n        screen: self,\n        parent: self,\n        left: 'center',\n        top: 'center',\n        width: 'shrink',\n        padding: 1,\n        height: 'shrink',\n        align: 'center',\n        valign: 'middle',\n        border: 'line',\n        label: ' {red-fg}{bold}WARNING{/} ',\n        content: '{bold}' + text + '{/bold}',\n        tags: true\n      });\n      self.render();\n      var timeout = setTimeout(function() {\n        warning.destroy();\n        self.render();\n      }, 1500);\n      if (timeout.unref) {\n        timeout.unref();\n      }\n    });\n  }\n};\n\nScreen.prototype._destroy = Screen.prototype.destroy;\nScreen.prototype.destroy = function() {\n  this.leave();\n\n  var index = Screen.instances.indexOf(this);\n  if (~index) {\n    Screen.instances.splice(index, 1);\n    Screen.total--;\n\n    Screen.global = Screen.instances[0];\n\n    if (Screen.total === 0) {\n      Screen.global = null;\n\n      process.removeListener('uncaughtException', Screen._exceptionHandler);\n      process.removeListener('SIGTERM', Screen._sigtermHandler);\n      process.removeListener('SIGINT', Screen._sigintHandler);\n      process.removeListener('SIGQUIT', Screen._sigquitHandler);\n      process.removeListener('exit', Screen._exitHandler);\n      delete Screen._exceptionHandler;\n      delete Screen._sigtermHandler;\n      delete Screen._sigintHandler;\n      delete Screen._sigquitHandler;\n      delete Screen._exitHandler;\n\n      delete Screen._bound;\n    }\n\n    this.destroyed = true;\n    this.emit('destroy');\n    this._destroy();\n  }\n\n  this.program.destroy();\n};\n\nScreen.prototype.log = function() {\n  return this.program.log.apply(this.program, arguments);\n};\n\nScreen.prototype.debug = function() {\n  if (this.debugLog) {\n    this.debugLog.log.apply(this.debugLog, arguments);\n  }\n  return this.program.debug.apply(this.program, arguments);\n};\n\nScreen.prototype._listenMouse = function(el) {\n  var self = this;\n\n  if (el && !~this.clickable.indexOf(el)) {\n    el.clickable = true;\n    this.clickable.push(el);\n  }\n\n  if (this._listenedMouse) return;\n  this._listenedMouse = true;\n\n  this.program.enableMouse();\n  if (this.options.sendFocus) {\n    this.program.setMouse({ sendFocus: true }, true);\n  }\n\n  this.on('render', function() {\n    self._needsClickableSort = true;\n  });\n\n  this.program.on('mouse', function(data) {\n    if (self.lockKeys) return;\n\n    if (self._needsClickableSort) {\n      self.clickable = helpers.hsort(self.clickable);\n      self._needsClickableSort = false;\n    }\n\n    var i = 0\n      , el\n      , set\n      , pos;\n\n    for (; i < self.clickable.length; i++) {\n      el = self.clickable[i];\n\n      if (el.detached || !el.visible) {\n        continue;\n      }\n\n      // if (self.grabMouse && self.focused !== el\n      //     && !el.hasAncestor(self.focused)) continue;\n\n      pos = el.lpos;\n      if (!pos) continue;\n\n      if (data.x >= pos.xi && data.x < pos.xl\n          && data.y >= pos.yi && data.y < pos.yl) {\n        el.emit('mouse', data);\n        if (data.action === 'mousedown') {\n          self.mouseDown = el;\n        } else if (data.action === 'mouseup') {\n          (self.mouseDown || el).emit('click', data);\n          self.mouseDown = null;\n        } else if (data.action === 'mousemove') {\n          if (self.hover && el.index > self.hover.index) {\n            set = false;\n          }\n          if (self.hover !== el && !set) {\n            if (self.hover) {\n              self.hover.emit('mouseout', data);\n            }\n            el.emit('mouseover', data);\n            self.hover = el;\n          }\n          set = true;\n        }\n        el.emit(data.action, data);\n        break;\n      }\n    }\n\n    // Just mouseover?\n    if ((data.action === 'mousemove'\n        || data.action === 'mousedown'\n        || data.action === 'mouseup')\n        && self.hover\n        && !set) {\n      self.hover.emit('mouseout', data);\n      self.hover = null;\n    }\n\n    self.emit('mouse', data);\n    self.emit(data.action, data);\n  });\n\n  // Autofocus highest element.\n  // this.on('element click', function(el, data) {\n  //   var target;\n  //   do {\n  //     if (el.clickable === true && el.options.autoFocus !== false) {\n  //       target = el;\n  //     }\n  //   } while (el = el.parent);\n  //   if (target) target.focus();\n  // });\n\n  // Autofocus elements with the appropriate option.\n  this.on('element click', function(el) {\n    if (el.clickable === true && el.options.autoFocus !== false) {\n      el.focus();\n    }\n  });\n};\n\nScreen.prototype.enableMouse = function(el) {\n  this._listenMouse(el);\n};\n\nScreen.prototype._listenKeys = function(el) {\n  var self = this;\n\n  if (el && !~this.keyable.indexOf(el)) {\n    el.keyable = true;\n    this.keyable.push(el);\n  }\n\n  if (this._listenedKeys) return;\n  this._listenedKeys = true;\n\n  // NOTE: The event emissions used to be reversed:\n  // element + screen\n  // They are now:\n  // screen + element\n  // After the first keypress emitted, the handler\n  // checks to make sure grabKeys, lockKeys, and focused\n  // weren't changed, and handles those situations appropriately.\n  this.program.on('keypress', function(ch, key) {\n    if (self.lockKeys && !~self.ignoreLocked.indexOf(key.full)) {\n      return;\n    }\n\n    var focused = self.focused\n      , grabKeys = self.grabKeys;\n\n    if (!grabKeys || ~self.ignoreLocked.indexOf(key.full)) {\n      self.emit('keypress', ch, key);\n      self.emit('key ' + key.full, ch, key);\n    }\n\n    // If something changed from the screen key handler, stop.\n    if (self.grabKeys !== grabKeys || self.lockKeys) {\n      return;\n    }\n\n    if (focused && focused.keyable) {\n      focused.emit('keypress', ch, key);\n      focused.emit('key ' + key.full, ch, key);\n    }\n  });\n};\n\nScreen.prototype.enableKeys = function(el) {\n  this._listenKeys(el);\n};\n\nScreen.prototype.enableInput = function(el) {\n  this._listenMouse(el);\n  this._listenKeys(el);\n};\n\nScreen.prototype._initHover = function() {\n  var self = this;\n\n  if (this._hoverText) {\n    return;\n  }\n\n  this._hoverText = new Box({\n    screen: this,\n    left: 0,\n    top: 0,\n    tags: false,\n    height: 'shrink',\n    width: 'shrink',\n    border: 'line',\n    style: {\n      border: {\n        fg: 'default'\n      },\n      bg: 'default',\n      fg: 'default'\n    }\n  });\n\n  this.on('mousemove', function(data) {\n    if (self._hoverText.detached) return;\n    self._hoverText.rleft = data.x + 1;\n    self._hoverText.rtop = data.y;\n    self.render();\n  });\n\n  this.on('element mouseover', function(el, data) {\n    if (!el._hoverOptions) return;\n    self._hoverText.parseTags = el.parseTags;\n    self._hoverText.setContent(el._hoverOptions.text);\n    self.append(self._hoverText);\n    self._hoverText.rleft = data.x + 1;\n    self._hoverText.rtop = data.y;\n    self.render();\n  });\n\n  this.on('element mouseout', function() {\n    if (self._hoverText.detached) return;\n    self._hoverText.detach();\n    self.render();\n  });\n\n  // XXX This can cause problems if the\n  // terminal does not support allMotion.\n  // Workaround: check to see if content is set.\n  this.on('element mouseup', function(el) {\n    if (!self._hoverText.getContent()) return;\n    if (!el._hoverOptions) return;\n    self.append(self._hoverText);\n    self.render();\n  });\n};\n\nScreen.prototype.__defineGetter__('cols', function() {\n  return this.program.cols;\n});\n\nScreen.prototype.__defineGetter__('rows', function() {\n  return this.program.rows;\n});\n\nScreen.prototype.__defineGetter__('width', function() {\n  return this.program.cols;\n});\n\nScreen.prototype.__defineGetter__('height', function() {\n  return this.program.rows;\n});\n\nScreen.prototype.alloc = function(dirty) {\n  var x, y;\n\n  this.lines = [];\n  for (y = 0; y < this.rows; y++) {\n    this.lines[y] = [];\n    for (x = 0; x < this.cols; x++) {\n      this.lines[y][x] = [this.dattr, ' '];\n    }\n    this.lines[y].dirty = !!dirty;\n  }\n\n  this.olines = [];\n  for (y = 0; y < this.rows; y++) {\n    this.olines[y] = [];\n    for (x = 0; x < this.cols; x++) {\n      this.olines[y][x] = [this.dattr, ' '];\n    }\n  }\n\n  this.program.clear();\n};\n\nScreen.prototype.realloc = function() {\n  return this.alloc(true);\n};\n\nScreen.prototype.render = function() {\n  var self = this;\n\n  if (this.destroyed) return;\n\n  this.emit('prerender');\n\n  this._borderStops = {};\n\n  // TODO: Possibly get rid of .dirty altogether.\n  // TODO: Could possibly drop .dirty and just clear the `lines` buffer every\n  // time before a screen.render. This way clearRegion doesn't have to be\n  // called in arbitrary places for the sake of clearing a spot where an\n  // element used to be (e.g. when an element moves or is hidden). There could\n  // be some overhead though.\n  // this.screen.clearRegion(0, this.cols, 0, this.rows);\n  this._ci = 0;\n  this.children.forEach(function(el) {\n    el.index = self._ci++;\n    //el._rendering = true;\n    el.render();\n    //el._rendering = false;\n  });\n  this._ci = -1;\n\n  if (this.screen.dockBorders) {\n    this._dockBorders();\n  }\n\n  this.draw(0, this.lines.length - 1);\n\n  // XXX Workaround to deal with cursor pos before the screen has rendered and\n  // lpos is not reliable (stale).\n  if (this.focused && this.focused._updateCursor) {\n    this.focused._updateCursor(true);\n  }\n\n  this.renders++;\n\n  this.emit('render');\n};\n\nScreen.prototype.blankLine = function(ch, dirty) {\n  var out = [];\n  for (var x = 0; x < this.cols; x++) {\n    out[x] = [this.dattr, ch || ' '];\n  }\n  out.dirty = dirty;\n  return out;\n};\n\nScreen.prototype.insertLine = function(n, y, top, bottom) {\n  // if (y === top) return this.insertLineNC(n, y, top, bottom);\n\n  if (!this.tput.strings.change_scroll_region\n      || !this.tput.strings.delete_line\n      || !this.tput.strings.insert_line) return;\n\n  this._buf += this.tput.csr(top, bottom);\n  this._buf += this.tput.cup(y, 0);\n  this._buf += this.tput.il(n);\n  this._buf += this.tput.csr(0, this.height - 1);\n\n  var j = bottom + 1;\n\n  while (n--) {\n    this.lines.splice(y, 0, this.blankLine());\n    this.lines.splice(j, 1);\n    this.olines.splice(y, 0, this.blankLine());\n    this.olines.splice(j, 1);\n  }\n};\n\nScreen.prototype.deleteLine = function(n, y, top, bottom) {\n  // if (y === top) return this.deleteLineNC(n, y, top, bottom);\n\n  if (!this.tput.strings.change_scroll_region\n      || !this.tput.strings.delete_line\n      || !this.tput.strings.insert_line) return;\n\n  this._buf += this.tput.csr(top, bottom);\n  this._buf += this.tput.cup(y, 0);\n  this._buf += this.tput.dl(n);\n  this._buf += this.tput.csr(0, this.height - 1);\n\n  var j = bottom + 1;\n\n  while (n--) {\n    this.lines.splice(j, 0, this.blankLine());\n    this.lines.splice(y, 1);\n    this.olines.splice(j, 0, this.blankLine());\n    this.olines.splice(y, 1);\n  }\n};\n\n// This is how ncurses does it.\n// Scroll down (up cursor-wise).\n// This will only work for top line deletion as opposed to arbitrary lines.\nScreen.prototype.insertLineNC = function(n, y, top, bottom) {\n  if (!this.tput.strings.change_scroll_region\n      || !this.tput.strings.delete_line) return;\n\n  this._buf += this.tput.csr(top, bottom);\n  this._buf += this.tput.cup(top, 0);\n  this._buf += this.tput.dl(n);\n  this._buf += this.tput.csr(0, this.height - 1);\n\n  var j = bottom + 1;\n\n  while (n--) {\n    this.lines.splice(j, 0, this.blankLine());\n    this.lines.splice(y, 1);\n    this.olines.splice(j, 0, this.blankLine());\n    this.olines.splice(y, 1);\n  }\n};\n\n// This is how ncurses does it.\n// Scroll up (down cursor-wise).\n// This will only work for bottom line deletion as opposed to arbitrary lines.\nScreen.prototype.deleteLineNC = function(n, y, top, bottom) {\n  if (!this.tput.strings.change_scroll_region\n      || !this.tput.strings.delete_line) return;\n\n  this._buf += this.tput.csr(top, bottom);\n  this._buf += this.tput.cup(bottom, 0);\n  this._buf += Array(n + 1).join('\\n');\n  this._buf += this.tput.csr(0, this.height - 1);\n\n  var j = bottom + 1;\n\n  while (n--) {\n    this.lines.splice(j, 0, this.blankLine());\n    this.lines.splice(y, 1);\n    this.olines.splice(j, 0, this.blankLine());\n    this.olines.splice(y, 1);\n  }\n};\n\nScreen.prototype.insertBottom = function(top, bottom) {\n  return this.deleteLine(1, top, top, bottom);\n};\n\nScreen.prototype.insertTop = function(top, bottom) {\n  return this.insertLine(1, top, top, bottom);\n};\n\nScreen.prototype.deleteBottom = function(top, bottom) {\n  return this.clearRegion(0, this.width, bottom, bottom);\n};\n\nScreen.prototype.deleteTop = function(top, bottom) {\n  // Same as: return this.insertBottom(top, bottom);\n  return this.deleteLine(1, top, top, bottom);\n};\n\n// Parse the sides of an element to determine\n// whether an element has uniform cells on\n// both sides. If it does, we can use CSR to\n// optimize scrolling on a scrollable element.\n// Not exactly sure how worthwile this is.\n// This will cause a performance/cpu-usage hit,\n// but will it be less or greater than the\n// performance hit of slow-rendering scrollable\n// boxes with clean sides?\nScreen.prototype.cleanSides = function(el) {\n  var pos = el.lpos;\n\n  if (!pos) {\n    return false;\n  }\n\n  if (pos._cleanSides != null) {\n    return pos._cleanSides;\n  }\n\n  if (pos.xi <= 0 && pos.xl >= this.width) {\n    return pos._cleanSides = true;\n  }\n\n  if (this.options.fastCSR) {\n    // Maybe just do this instead of parsing.\n    if (pos.yi < 0) return pos._cleanSides = false;\n    if (pos.yl > this.height) return pos._cleanSides = false;\n    if (this.width - (pos.xl - pos.xi) < 40) {\n      return pos._cleanSides = true;\n    }\n    return pos._cleanSides = false;\n  }\n\n  if (!this.options.smartCSR) {\n    return false;\n  }\n\n  // The scrollbar can't update properly, and there's also a\n  // chance that the scrollbar may get moved around senselessly.\n  // NOTE: In pratice, this doesn't seem to be the case.\n  // if (this.scrollbar) {\n  //   return pos._cleanSides = false;\n  // }\n\n  // Doesn't matter if we're only a height of 1.\n  // if ((pos.yl - el.ibottom) - (pos.yi + el.itop) <= 1) {\n  //   return pos._cleanSides = false;\n  // }\n\n  var yi = pos.yi + el.itop\n    , yl = pos.yl - el.ibottom\n    , first\n    , ch\n    , x\n    , y;\n\n  if (pos.yi < 0) return pos._cleanSides = false;\n  if (pos.yl > this.height) return pos._cleanSides = false;\n  if (pos.xi - 1 < 0) return pos._cleanSides = true;\n  if (pos.xl > this.width) return pos._cleanSides = true;\n\n  for (x = pos.xi - 1; x >= 0; x--) {\n    if (!this.olines[yi]) break;\n    first = this.olines[yi][x];\n    for (y = yi; y < yl; y++) {\n      if (!this.olines[y] || !this.olines[y][x]) break;\n      ch = this.olines[y][x];\n      if (ch[0] !== first[0] || ch[1] !== first[1]) {\n        return pos._cleanSides = false;\n      }\n    }\n  }\n\n  for (x = pos.xl; x < this.width; x++) {\n    if (!this.olines[yi]) break;\n    first = this.olines[yi][x];\n    for (y = yi; y < yl; y++) {\n      if (!this.olines[y] || !this.olines[y][x]) break;\n      ch = this.olines[y][x];\n      if (ch[0] !== first[0] || ch[1] !== first[1]) {\n        return pos._cleanSides = false;\n      }\n    }\n  }\n\n  return pos._cleanSides = true;\n};\n\nScreen.prototype._dockBorders = function() {\n  var lines = this.lines\n    , stops = this._borderStops\n    , i\n    , y\n    , x\n    , ch;\n\n  // var keys, stop;\n  //\n  // keys = Object.keys(this._borderStops)\n  //   .map(function(k) { return +k; })\n  //   .sort(function(a, b) { return a - b; });\n  //\n  // for (i = 0; i < keys.length; i++) {\n  //   y = keys[i];\n  //   if (!lines[y]) continue;\n  //   stop = this._borderStops[y];\n  //   for (x = stop.xi; x < stop.xl; x++) {\n\n  stops = Object.keys(stops)\n    .map(function(k) { return +k; })\n    .sort(function(a, b) { return a - b; });\n\n  for (i = 0; i < stops.length; i++) {\n    y = stops[i];\n    if (!lines[y]) continue;\n    for (x = 0; x < this.width; x++) {\n      ch = lines[y][x][1];\n      if (angles[ch]) {\n        lines[y][x][1] = this._getAngle(lines, x, y);\n        lines[y].dirty = true;\n      }\n    }\n  }\n};\n\nScreen.prototype._getAngle = function(lines, x, y) {\n  var angle = 0\n    , attr = lines[y][x][0]\n    , ch = lines[y][x][1];\n\n  if (lines[y][x - 1] && langles[lines[y][x - 1][1]]) {\n    if (!this.options.ignoreDockContrast) {\n      if (lines[y][x - 1][0] !== attr) return ch;\n    }\n    angle |= 1 << 3;\n  }\n\n  if (lines[y - 1] && uangles[lines[y - 1][x][1]]) {\n    if (!this.options.ignoreDockContrast) {\n      if (lines[y - 1][x][0] !== attr) return ch;\n    }\n    angle |= 1 << 2;\n  }\n\n  if (lines[y][x + 1] && rangles[lines[y][x + 1][1]]) {\n    if (!this.options.ignoreDockContrast) {\n      if (lines[y][x + 1][0] !== attr) return ch;\n    }\n    angle |= 1 << 1;\n  }\n\n  if (lines[y + 1] && dangles[lines[y + 1][x][1]]) {\n    if (!this.options.ignoreDockContrast) {\n      if (lines[y + 1][x][0] !== attr) return ch;\n    }\n    angle |= 1 << 0;\n  }\n\n  // Experimental: fixes this situation:\n  // +----------+\n  //            | <-- empty space here, should be a T angle\n  // +-------+  |\n  // |       |  |\n  // +-------+  |\n  // |          |\n  // +----------+\n  // if (uangles[lines[y][x][1]]) {\n  //   if (lines[y + 1] && cdangles[lines[y + 1][x][1]]) {\n  //     if (!this.options.ignoreDockContrast) {\n  //       if (lines[y + 1][x][0] !== attr) return ch;\n  //     }\n  //     angle |= 1 << 0;\n  //   }\n  // }\n\n  return angleTable[angle] || ch;\n};\n\nScreen.prototype.draw = function(start, end) {\n  // this.emit('predraw');\n\n  var x\n    , y\n    , line\n    , out\n    , ch\n    , data\n    , attr\n    , fg\n    , bg\n    , flags;\n\n  var main = ''\n    , pre\n    , post;\n\n  var clr\n    , neq\n    , xx;\n\n  var lx = -1\n    , ly = -1\n    , o;\n\n  var acs;\n\n  if (this._buf) {\n    main += this._buf;\n    this._buf = '';\n  }\n\n  for (y = start; y <= end; y++) {\n    line = this.lines[y];\n    o = this.olines[y];\n\n    if (!line.dirty && !(this.cursor.artificial && y === this.program.y)) {\n      continue;\n    }\n    line.dirty = false;\n\n    out = '';\n    attr = this.dattr;\n\n    for (x = 0; x < line.length; x++) {\n      data = line[x][0];\n      ch = line[x][1];\n\n      // Render the artificial cursor.\n      if (this.cursor.artificial\n          && !this.cursor._hidden\n          && this.cursor._state\n          && x === this.program.x\n          && y === this.program.y) {\n        var cattr = this._cursorAttr(this.cursor, data);\n        if (cattr.ch) ch = cattr.ch;\n        data = cattr.attr;\n      }\n\n      // Take advantage of xterm's back_color_erase feature by using a\n      // lookahead. Stop spitting out so many damn spaces. NOTE: Is checking\n      // the bg for non BCE terminals worth the overhead?\n      if (this.options.useBCE\n          && ch === ' '\n          && (this.tput.bools.back_color_erase\n          || (data & 0x1ff) === (this.dattr & 0x1ff))\n          && ((data >> 18) & 8) === ((this.dattr >> 18) & 8)) {\n        clr = true;\n        neq = false;\n\n        for (xx = x; xx < line.length; xx++) {\n          if (line[xx][0] !== data || line[xx][1] !== ' ') {\n            clr = false;\n            break;\n          }\n          if (line[xx][0] !== o[xx][0] || line[xx][1] !== o[xx][1]) {\n            neq = true;\n          }\n        }\n\n        if (clr && neq) {\n          lx = -1, ly = -1;\n          if (data !== attr) {\n            out += this.codeAttr(data);\n            attr = data;\n          }\n          out += this.tput.cup(y, x);\n          out += this.tput.el();\n          for (xx = x; xx < line.length; xx++) {\n            o[xx][0] = data;\n            o[xx][1] = ' ';\n          }\n          break;\n        }\n\n        // If there's more than 10 spaces, use EL regardless\n        // and start over drawing the rest of line. Might\n        // not be worth it. Try to use ECH if the terminal\n        // supports it. Maybe only try to use ECH here.\n        // //if (this.tput.strings.erase_chars)\n        // if (!clr && neq && (xx - x) > 10) {\n        //   lx = -1, ly = -1;\n        //   if (data !== attr) {\n        //     out += this.codeAttr(data);\n        //     attr = data;\n        //   }\n        //   out += this.tput.cup(y, x);\n        //   if (this.tput.strings.erase_chars) {\n        //     // Use erase_chars to avoid erasing the whole line.\n        //     out += this.tput.ech(xx - x);\n        //   } else {\n        //     out += this.tput.el();\n        //   }\n        //   if (this.tput.strings.parm_right_cursor) {\n        //     out += this.tput.cuf(xx - x);\n        //   } else {\n        //     out += this.tput.cup(y, xx);\n        //   }\n        //   this.fillRegion(data, ' ',\n        //     x, this.tput.strings.erase_chars ? xx : line.length,\n        //     y, y + 1);\n        //   x = xx - 1;\n        //   continue;\n        // }\n\n        // Skip to the next line if the\n        // rest of the line is already drawn.\n        // if (!neq) {\n        //   for (; xx < line.length; xx++) {\n        //     if (line[xx][0] !== o[xx][0] || line[xx][1] !== o[xx][1]) {\n        //       neq = true;\n        //       break;\n        //     }\n        //   }\n        //   if (!neq) {\n        //     attr = data;\n        //     break;\n        //   }\n        // }\n      }\n\n      // Optimize by comparing the real output\n      // buffer to the pending output buffer.\n      if (data === o[x][0] && ch === o[x][1]) {\n        if (lx === -1) {\n          lx = x;\n          ly = y;\n        }\n        continue;\n      } else if (lx !== -1) {\n        if (this.tput.strings.parm_right_cursor) {\n          out += y === ly\n            ? this.tput.cuf(x - lx)\n            : this.tput.cup(y, x);\n        } else {\n          out += this.tput.cup(y, x);\n        }\n        lx = -1, ly = -1;\n      }\n      o[x][0] = data;\n      o[x][1] = ch;\n\n      if (data !== attr) {\n        if (attr !== this.dattr) {\n          out += '\\x1b[m';\n        }\n        if (data !== this.dattr) {\n          out += '\\x1b[';\n\n          bg = data & 0x1ff;\n          fg = (data >> 9) & 0x1ff;\n          flags = data >> 18;\n\n          // bold\n          if (flags & 1) {\n            out += '1;';\n          }\n\n          // underline\n          if (flags & 2) {\n            out += '4;';\n          }\n\n          // blink\n          if (flags & 4) {\n            out += '5;';\n          }\n\n          // inverse\n          if (flags & 8) {\n            out += '7;';\n          }\n\n          // invisible\n          if (flags & 16) {\n            out += '8;';\n          }\n\n          if (bg !== 0x1ff) {\n            bg = this._reduceColor(bg);\n            if (bg < 16) {\n              if (bg < 8) {\n                bg += 40;\n              } else if (bg < 16) {\n                bg -= 8;\n                bg += 100;\n              }\n              out += bg + ';';\n            } else {\n              out += '48;5;' + bg + ';';\n            }\n          }\n\n          if (fg !== 0x1ff) {\n            fg = this._reduceColor(fg);\n            if (fg < 16) {\n              if (fg < 8) {\n                fg += 30;\n              } else if (fg < 16) {\n                fg -= 8;\n                fg += 90;\n              }\n              out += fg + ';';\n            } else {\n              out += '38;5;' + fg + ';';\n            }\n          }\n\n          if (out[out.length - 1] === ';') out = out.slice(0, -1);\n\n          out += 'm';\n        }\n      }\n\n      // If we find a double-width char, eat the next character which should be\n      // a space due to parseContent's behavior.\n      if (this.fullUnicode) {\n        // If this is a surrogate pair double-width char, we can ignore it\n        // because parseContent already counted it as length=2.\n        if (unicode.charWidth(line[x][1]) === 2) {\n          // NOTE: At cols=44, the bug that is avoided\n          // by the angles check occurs in widget-unicode:\n          // Might also need: `line[x + 1][0] !== line[x][0]`\n          // for borderless boxes?\n          if (x === line.length - 1 || angles[line[x + 1][1]]) {\n            // If we're at the end, we don't have enough space for a\n            // double-width. Overwrite it with a space and ignore.\n            ch = ' ';\n            o[x][1] = '\\0';\n          } else {\n            // ALWAYS refresh double-width chars because this special cursor\n            // behavior is needed. There may be a more efficient way of doing\n            // this. See above.\n            o[x][1] = '\\0';\n            // Eat the next character by moving forward and marking as a\n            // space (which it is).\n            o[++x][1] = '\\0';\n          }\n        }\n      }\n\n      // Attempt to use ACS for supported characters.\n      // This is not ideal, but it's how ncurses works.\n      // There are a lot of terminals that support ACS\n      // *and UTF8, but do not declare U8. So ACS ends\n      // up being used (slower than utf8). Terminals\n      // that do not support ACS and do not explicitly\n      // support UTF8 get their unicode characters\n      // replaced with really ugly ascii characters.\n      // It is possible there is a terminal out there\n      // somewhere that does not support ACS, but\n      // supports UTF8, but I imagine it's unlikely.\n      // Maybe remove !this.tput.unicode check, however,\n      // this seems to be the way ncurses does it.\n      if (this.tput.strings.enter_alt_charset_mode\n          && !this.tput.brokenACS && (this.tput.acscr[ch] || acs)) {\n        // Fun fact: even if this.tput.brokenACS wasn't checked here,\n        // the linux console would still work fine because the acs\n        // table would fail the check of: this.tput.acscr[ch]\n        if (this.tput.acscr[ch]) {\n          if (acs) {\n            ch = this.tput.acscr[ch];\n          } else {\n            ch = this.tput.smacs()\n              + this.tput.acscr[ch];\n            acs = true;\n          }\n        } else if (acs) {\n          ch = this.tput.rmacs() + ch;\n          acs = false;\n        }\n      } else {\n        // U8 is not consistently correct. Some terminfo's\n        // terminals that do not declare it may actually\n        // support utf8 (e.g. urxvt), but if the terminal\n        // does not declare support for ACS (and U8), chances\n        // are it does not support UTF8. This is probably\n        // the \"safest\" way to do this. Should fix things\n        // like sun-color.\n        // NOTE: It could be the case that the $LANG\n        // is all that matters in some cases:\n        // if (!this.tput.unicode && ch > '~') {\n        if (!this.tput.unicode && this.tput.numbers.U8 !== 1 && ch > '~') {\n          ch = this.tput.utoa[ch] || '?';\n        }\n      }\n\n      out += ch;\n      attr = data;\n    }\n\n    if (attr !== this.dattr) {\n      out += '\\x1b[m';\n    }\n\n    if (out) {\n      main += this.tput.cup(y, 0) + out;\n    }\n  }\n\n  if (acs) {\n    main += this.tput.rmacs();\n    acs = false;\n  }\n\n  if (main) {\n    pre = '';\n    post = '';\n\n    pre += this.tput.sc();\n    post += this.tput.rc();\n\n    if (!this.program.cursorHidden) {\n      pre += this.tput.civis();\n      post += this.tput.cnorm();\n    }\n\n    // this.program.flush();\n    // this.program._owrite(pre + main + post);\n    this.program._write(pre + main + post);\n  }\n\n  // this.emit('draw');\n};\n\nScreen.prototype._reduceColor = function(color) {\n  return colors.reduce(color, this.tput.colors);\n};\n\n// Convert an SGR string to our own attribute format.\nScreen.prototype.attrCode = function(code, cur, def) {\n  var flags = (cur >> 18) & 0x1ff\n    , fg = (cur >> 9) & 0x1ff\n    , bg = cur & 0x1ff\n    , c\n    , i;\n\n  code = code.slice(2, -1).split(';');\n  if (!code[0]) code[0] = '0';\n\n  for (i = 0; i < code.length; i++) {\n    c = +code[i] || 0;\n    switch (c) {\n      case 0: // normal\n        bg = def & 0x1ff;\n        fg = (def >> 9) & 0x1ff;\n        flags = (def >> 18) & 0x1ff;\n        break;\n      case 1: // bold\n        flags |= 1;\n        break;\n      case 22:\n        flags = (def >> 18) & 0x1ff;\n        break;\n      case 4: // underline\n        flags |= 2;\n        break;\n      case 24:\n        flags = (def >> 18) & 0x1ff;\n        break;\n      case 5: // blink\n        flags |= 4;\n        break;\n      case 25:\n        flags = (def >> 18) & 0x1ff;\n        break;\n      case 7: // inverse\n        flags |= 8;\n        break;\n      case 27:\n        flags = (def >> 18) & 0x1ff;\n        break;\n      case 8: // invisible\n        flags |= 16;\n        break;\n      case 28:\n        flags = (def >> 18) & 0x1ff;\n        break;\n      case 39: // default fg\n        fg = (def >> 9) & 0x1ff;\n        break;\n      case 49: // default bg\n        bg = def & 0x1ff;\n        break;\n      case 100: // default fg/bg\n        fg = (def >> 9) & 0x1ff;\n        bg = def & 0x1ff;\n        break;\n      default: // color\n        if (c === 48 && +code[i+1] === 5) {\n          i += 2;\n          bg = +code[i];\n          break;\n        } else if (c === 48 && +code[i+1] === 2) {\n          i += 2;\n          bg = colors.match(+code[i], +code[i+1], +code[i+2]);\n          if (bg === -1) bg = def & 0x1ff;\n          i += 2;\n          break;\n        } else if (c === 38 && +code[i+1] === 5) {\n          i += 2;\n          fg = +code[i];\n          break;\n        } else if (c === 38 && +code[i+1] === 2) {\n          i += 2;\n          fg = colors.match(+code[i], +code[i+1], +code[i+2]);\n          if (fg === -1) fg = (def >> 9) & 0x1ff;\n          i += 2;\n          break;\n        }\n        if (c >= 40 && c <= 47) {\n          bg = c - 40;\n        } else if (c >= 100 && c <= 107) {\n          bg = c - 100;\n          bg += 8;\n        } else if (c === 49) {\n          bg = def & 0x1ff;\n        } else if (c >= 30 && c <= 37) {\n          fg = c - 30;\n        } else if (c >= 90 && c <= 97) {\n          fg = c - 90;\n          fg += 8;\n        } else if (c === 39) {\n          fg = (def >> 9) & 0x1ff;\n        } else if (c === 100) {\n          fg = (def >> 9) & 0x1ff;\n          bg = def & 0x1ff;\n        }\n        break;\n    }\n  }\n\n  return (flags << 18) | (fg << 9) | bg;\n};\n\n// Convert our own attribute format to an SGR string.\nScreen.prototype.codeAttr = function(code) {\n  var flags = (code >> 18) & 0x1ff\n    , fg = (code >> 9) & 0x1ff\n    , bg = code & 0x1ff\n    , out = '';\n\n  // bold\n  if (flags & 1) {\n    out += '1;';\n  }\n\n  // underline\n  if (flags & 2) {\n    out += '4;';\n  }\n\n  // blink\n  if (flags & 4) {\n    out += '5;';\n  }\n\n  // inverse\n  if (flags & 8) {\n    out += '7;';\n  }\n\n  // invisible\n  if (flags & 16) {\n    out += '8;';\n  }\n\n  if (bg !== 0x1ff) {\n    bg = this._reduceColor(bg);\n    if (bg < 16) {\n      if (bg < 8) {\n        bg += 40;\n      } else if (bg < 16) {\n        bg -= 8;\n        bg += 100;\n      }\n      out += bg + ';';\n    } else {\n      out += '48;5;' + bg + ';';\n    }\n  }\n\n  if (fg !== 0x1ff) {\n    fg = this._reduceColor(fg);\n    if (fg < 16) {\n      if (fg < 8) {\n        fg += 30;\n      } else if (fg < 16) {\n        fg -= 8;\n        fg += 90;\n      }\n      out += fg + ';';\n    } else {\n      out += '38;5;' + fg + ';';\n    }\n  }\n\n  if (out[out.length - 1] === ';') out = out.slice(0, -1);\n\n  return '\\x1b[' + out + 'm';\n};\n\nScreen.prototype.focusOffset = function(offset) {\n  var shown = this.keyable.filter(function(el) {\n    return !el.detached && el.visible;\n  }).length;\n\n  if (!shown || !offset) {\n    return;\n  }\n\n  var i = this.keyable.indexOf(this.focused);\n  if (!~i) return;\n\n  if (offset > 0) {\n    while (offset--) {\n      if (++i > this.keyable.length - 1) i = 0;\n      if (this.keyable[i].detached || !this.keyable[i].visible) offset++;\n    }\n  } else {\n    offset = -offset;\n    while (offset--) {\n      if (--i < 0) i = this.keyable.length - 1;\n      if (this.keyable[i].detached || !this.keyable[i].visible) offset++;\n    }\n  }\n\n  return this.keyable[i].focus();\n};\n\nScreen.prototype.focusPrev =\nScreen.prototype.focusPrevious = function() {\n  return this.focusOffset(-1);\n};\n\nScreen.prototype.focusNext = function() {\n  return this.focusOffset(1);\n};\n\nScreen.prototype.focusPush = function(el) {\n  if (!el) return;\n  var old = this.history[this.history.length - 1];\n  if (this.history.length === 10) {\n    this.history.shift();\n  }\n  this.history.push(el);\n  this._focus(el, old);\n};\n\nScreen.prototype.focusPop = function() {\n  var old = this.history.pop();\n  if (this.history.length) {\n    this._focus(this.history[this.history.length - 1], old);\n  }\n  return old;\n};\n\nScreen.prototype.saveFocus = function() {\n  return this._savedFocus = this.focused;\n};\n\nScreen.prototype.restoreFocus = function() {\n  if (!this._savedFocus) return;\n  this._savedFocus.focus();\n  delete this._savedFocus;\n  return this.focused;\n};\n\nScreen.prototype.rewindFocus = function() {\n  var old = this.history.pop()\n    , el;\n\n  while (this.history.length) {\n    el = this.history.pop();\n    if (!el.detached && el.visible) {\n      this.history.push(el);\n      this._focus(el, old);\n      return el;\n    }\n  }\n\n  if (old) {\n    old.emit('blur');\n  }\n};\n\nScreen.prototype._focus = function(self, old) {\n  // Find a scrollable ancestor if we have one.\n  var el = self;\n  while (el = el.parent) {\n    if (el.scrollable) break;\n  }\n\n  // If we're in a scrollable element,\n  // automatically scroll to the focused element.\n  if (el && !el.detached) {\n    // NOTE: This is different from the other \"visible\" values - it needs the\n    // visible height of the scrolling element itself, not the element within\n    // it.\n    var visible = self.screen.height - el.atop - el.itop - el.abottom - el.ibottom;\n    if (self.rtop < el.childBase) {\n      el.scrollTo(self.rtop);\n      self.screen.render();\n    } else if (self.rtop + self.height - self.ibottom > el.childBase + visible) {\n      // Explanation for el.itop here: takes into account scrollable elements\n      // with borders otherwise the element gets covered by the bottom border:\n      el.scrollTo(self.rtop - (el.height - self.height) + el.itop, true);\n      self.screen.render();\n    }\n  }\n\n  if (old) {\n    old.emit('blur', self);\n  }\n\n  self.emit('focus', old);\n};\n\nScreen.prototype.__defineGetter__('focused', function() {\n  return this.history[this.history.length - 1];\n});\n\nScreen.prototype.__defineSetter__('focused', function(el) {\n  return this.focusPush(el);\n});\n\nScreen.prototype.clearRegion = function(xi, xl, yi, yl, override) {\n  return this.fillRegion(this.dattr, ' ', xi, xl, yi, yl, override);\n};\n\nScreen.prototype.fillRegion = function(attr, ch, xi, xl, yi, yl, override) {\n  var lines = this.lines\n    , cell\n    , xx;\n\n  if (xi < 0) xi = 0;\n  if (yi < 0) yi = 0;\n\n  for (; yi < yl; yi++) {\n    if (!lines[yi]) break;\n    for (xx = xi; xx < xl; xx++) {\n      cell = lines[yi][xx];\n      if (!cell) break;\n      if (override || attr !== cell[0] || ch !== cell[1]) {\n        lines[yi][xx][0] = attr;\n        lines[yi][xx][1] = ch;\n        lines[yi].dirty = true;\n      }\n    }\n  }\n};\n\nScreen.prototype.key = function() {\n  return this.program.key.apply(this, arguments);\n};\n\nScreen.prototype.onceKey = function() {\n  return this.program.onceKey.apply(this, arguments);\n};\n\nScreen.prototype.unkey =\nScreen.prototype.removeKey = function() {\n  return this.program.unkey.apply(this, arguments);\n};\n\nScreen.prototype.spawn = function(file, args, options) {\n  if (!Array.isArray(args)) {\n    options = args;\n    args = [];\n  }\n\n  var screen = this\n    , program = screen.program\n    , spawn = require('child_process').spawn\n    , mouse = program.mouseEnabled\n    , ps;\n\n  options = options || {};\n\n  options.stdio = options.stdio || 'inherit';\n\n  program.lsaveCursor('spawn');\n  // program.csr(0, program.rows - 1);\n  program.normalBuffer();\n  program.showCursor();\n  if (mouse) program.disableMouse();\n\n  var write = program.output.write;\n  program.output.write = function() {};\n  program.input.pause();\n  if (program.input.setRawMode) {\n    program.input.setRawMode(false);\n  }\n\n  var resume = function() {\n    if (resume.done) return;\n    resume.done = true;\n\n    if (program.input.setRawMode) {\n      program.input.setRawMode(true);\n    }\n    program.input.resume();\n    program.output.write = write;\n\n    program.alternateBuffer();\n    // program.csr(0, program.rows - 1);\n    if (mouse) {\n      program.enableMouse();\n      if (screen.options.sendFocus) {\n        screen.program.setMouse({ sendFocus: true }, true);\n      }\n    }\n\n    screen.alloc();\n    screen.render();\n\n    screen.program.lrestoreCursor('spawn', true);\n  };\n\n  ps = spawn(file, args, options);\n\n  ps.on('error', resume);\n\n  ps.on('exit', resume);\n\n  return ps;\n};\n\nScreen.prototype.exec = function(file, args, options, callback) {\n  var ps = this.spawn(file, args, options);\n\n  ps.on('error', function(err) {\n    if (!callback) return;\n    return callback(err, false);\n  });\n\n  ps.on('exit', function(code) {\n    if (!callback) return;\n    return callback(null, code === 0);\n  });\n\n  return ps;\n};\n\nScreen.prototype.readEditor = function(options, callback) {\n  if (typeof options === 'string') {\n    options = { editor: options };\n  }\n\n  if (!callback) {\n    callback = options;\n    options = null;\n  }\n\n  if (!callback) {\n    callback = function() {};\n  }\n\n  options = options || {};\n\n  var self = this\n    , editor = options.editor || process.env.EDITOR || 'vi'\n    , name = options.name || process.title || 'blessed'\n    , rnd = Math.random().toString(36).split('.').pop()\n    , file = '/tmp/' + name + '.' + rnd\n    , args = [file]\n    , opt;\n\n  opt = {\n    stdio: 'inherit',\n    env: process.env,\n    cwd: process.env.HOME\n  };\n\n  function writeFile(callback) {\n    if (!options.value) return callback();\n    return fs.writeFile(file, options.value, callback);\n  }\n\n  return writeFile(function(err) {\n    if (err) return callback(err);\n    return self.exec(editor, args, opt, function(err, success) {\n      if (err) return callback(err);\n      return fs.readFile(file, 'utf8', function(err, data) {\n        return fs.unlink(file, function() {\n          if (!success) return callback(new Error('Unsuccessful.'));\n          if (err) return callback(err);\n          return callback(null, data);\n        });\n      });\n    });\n  });\n};\n\nScreen.prototype.displayImage = function(file, callback) {\n  if (!file) {\n    if (!callback) return;\n    return callback(new Error('No image.'));\n  }\n\n  file = path.resolve(process.cwd(), file);\n\n  if (!~file.indexOf('://')) {\n    file = 'file://' + file;\n  }\n\n  var args = ['w3m', '-T', 'text/html'];\n\n  var input = '<title>press q to exit</title>'\n    + '<img align=\"center\" src=\"' + file + '\">';\n\n  var opt = {\n    stdio: ['pipe', 1, 2],\n    env: process.env,\n    cwd: process.env.HOME\n  };\n\n  var ps = this.spawn(args[0], args.slice(1), opt);\n\n  ps.on('error', function(err) {\n    if (!callback) return;\n    return callback(err);\n  });\n\n  ps.on('exit', function(code) {\n    if (!callback) return;\n    if (code !== 0) return callback(new Error('Exit Code: ' + code));\n    return callback(null, code === 0);\n  });\n\n  ps.stdin.write(input + '\\n');\n  ps.stdin.end();\n};\n\nScreen.prototype.setEffects = function(el, fel, over, out, effects, temp) {\n  if (!effects) return;\n\n  var tmp = {};\n  if (temp) el[temp] = tmp;\n\n  if (typeof el !== 'function') {\n    var _el = el;\n    el = function() { return _el; };\n  }\n\n  fel.on(over, function() {\n    var element = el();\n    Object.keys(effects).forEach(function(key) {\n      var val = effects[key];\n      if (val !== null && typeof val === 'object') {\n        tmp[key] = tmp[key] || {};\n        // element.style[key] = element.style[key] || {};\n        Object.keys(val).forEach(function(k) {\n          var v = val[k];\n          tmp[key][k] = element.style[key][k];\n          element.style[key][k] = v;\n        });\n        return;\n      }\n      tmp[key] = element.style[key];\n      element.style[key] = val;\n    });\n    element.screen.render();\n  });\n\n  fel.on(out, function() {\n    var element = el();\n    Object.keys(effects).forEach(function(key) {\n      var val = effects[key];\n      if (val !== null && typeof val === 'object') {\n        tmp[key] = tmp[key] || {};\n        // element.style[key] = element.style[key] || {};\n        Object.keys(val).forEach(function(k) {\n          if (tmp[key].hasOwnProperty(k)) {\n            element.style[key][k] = tmp[key][k];\n          }\n        });\n        return;\n      }\n      if (tmp.hasOwnProperty(key)) {\n        element.style[key] = tmp[key];\n      }\n    });\n    element.screen.render();\n  });\n};\n\nScreen.prototype.sigtstp = function(callback) {\n  var self = this;\n  this.program.sigtstp(function() {\n    self.alloc();\n    self.render();\n    self.program.lrestoreCursor('pause', true);\n    if (callback) callback();\n  });\n};\n\nScreen.prototype.copyToClipboard = function(text) {\n  return this.program.copyToClipboard(text);\n};\n\nScreen.prototype.cursorShape = function(shape, blink) {\n  var self = this;\n\n  this.cursor.shape = shape || 'block';\n  this.cursor.blink = blink || false;\n  this.cursor._set = true;\n\n  if (this.cursor.artificial) {\n    if (!this.program.hideCursor_old) {\n      var hideCursor = this.program.hideCursor;\n      this.program.hideCursor_old = this.program.hideCursor;\n      this.program.hideCursor = function() {\n        hideCursor.call(self.program);\n        self.cursor._hidden = true;\n        if (self.renders) self.render();\n      };\n    }\n    if (!this.program.showCursor_old) {\n      var showCursor = this.program.showCursor;\n      this.program.showCursor_old = this.program.showCursor;\n      this.program.showCursor = function() {\n        self.cursor._hidden = false;\n        if (self.program._exiting) showCursor.call(self.program);\n        if (self.renders) self.render();\n      };\n    }\n    if (!this._cursorBlink) {\n      this._cursorBlink = setInterval(function() {\n        if (!self.cursor.blink) return;\n        self.cursor._state ^= 1;\n        if (self.renders) self.render();\n      }, 500);\n      if (this._cursorBlink.unref) {\n        this._cursorBlink.unref();\n      }\n    }\n    return true;\n  }\n\n  return this.program.cursorShape(this.cursor.shape, this.cursor.blink);\n};\n\nScreen.prototype.cursorColor = function(color) {\n  this.cursor.color = color != null\n    ? colors.convert(color)\n    : null;\n  this.cursor._set = true;\n\n  if (this.cursor.artificial) {\n    return true;\n  }\n\n  return this.program.cursorColor(colors.ncolors[this.cursor.color]);\n};\n\nScreen.prototype.cursorReset =\nScreen.prototype.resetCursor = function() {\n  this.cursor.shape = 'block';\n  this.cursor.blink = false;\n  this.cursor.color = null;\n  this.cursor._set = false;\n\n  if (this.cursor.artificial) {\n    this.cursor.artificial = false;\n    if (this.program.hideCursor_old) {\n      this.program.hideCursor = this.program.hideCursor_old;\n      delete this.program.hideCursor_old;\n    }\n    if (this.program.showCursor_old) {\n      this.program.showCursor = this.program.showCursor_old;\n      delete this.program.showCursor_old;\n    }\n    if (this._cursorBlink) {\n      clearInterval(this._cursorBlink);\n      delete this._cursorBlink;\n    }\n    return true;\n  }\n\n  return this.program.cursorReset();\n};\n\nScreen.prototype._cursorAttr = function(cursor, dattr) {\n  var attr = dattr || this.dattr\n    , cattr\n    , ch;\n\n  if (cursor.shape === 'line') {\n    attr &= ~(0x1ff << 9);\n    attr |= 7 << 9;\n    ch = '\\u2502';\n  } else if (cursor.shape === 'underline') {\n    attr &= ~(0x1ff << 9);\n    attr |= 7 << 9;\n    attr |= 2 << 18;\n  } else if (cursor.shape === 'block') {\n    attr &= ~(0x1ff << 9);\n    attr |= 7 << 9;\n    attr |= 8 << 18;\n  } else if (typeof cursor.shape === 'object' && cursor.shape) {\n    cattr = Element.prototype.sattr.call(cursor, cursor.shape);\n\n    if (cursor.shape.bold || cursor.shape.underline\n        || cursor.shape.blink || cursor.shape.inverse\n        || cursor.shape.invisible) {\n      attr &= ~(0x1ff << 18);\n      attr |= ((cattr >> 18) & 0x1ff) << 18;\n    }\n\n    if (cursor.shape.fg) {\n      attr &= ~(0x1ff << 9);\n      attr |= ((cattr >> 9) & 0x1ff) << 9;\n    }\n\n    if (cursor.shape.bg) {\n      attr &= ~(0x1ff << 0);\n      attr |= cattr & 0x1ff;\n    }\n\n    if (cursor.shape.ch) {\n      ch = cursor.shape.ch;\n    }\n  }\n\n  if (cursor.color != null) {\n    attr &= ~(0x1ff << 9);\n    attr |= cursor.color << 9;\n  }\n\n  return {\n    ch: ch,\n    attr: attr\n  };\n};\n\nScreen.prototype.screenshot = function(xi, xl, yi, yl, term) {\n  if (xi == null) xi = 0;\n  if (xl == null) xl = this.cols;\n  if (yi == null) yi = 0;\n  if (yl == null) yl = this.rows;\n\n  if (xi < 0) xi = 0;\n  if (yi < 0) yi = 0;\n\n  var x\n    , y\n    , line\n    , out\n    , ch\n    , data\n    , attr;\n\n  var sdattr = this.dattr;\n\n  if (term) {\n    this.dattr = term.defAttr;\n  }\n\n  var main = '';\n\n  for (y = yi; y < yl; y++) {\n    line = term\n      ? term.lines[y]\n      : this.lines[y];\n\n    if (!line) break;\n\n    out = '';\n    attr = this.dattr;\n\n    for (x = xi; x < xl; x++) {\n      if (!line[x]) break;\n\n      data = line[x][0];\n      ch = line[x][1];\n\n      if (data !== attr) {\n        if (attr !== this.dattr) {\n          out += '\\x1b[m';\n        }\n        if (data !== this.dattr) {\n          var _data = data;\n          if (term) {\n            if (((_data >> 9) & 0x1ff) === 257) _data |= 0x1ff << 9;\n            if ((_data & 0x1ff) === 256) _data |= 0x1ff;\n          }\n          out += this.codeAttr(_data);\n        }\n      }\n\n      if (this.fullUnicode) {\n        if (unicode.charWidth(line[x][1]) === 2) {\n          if (x === xl - 1) {\n            ch = ' ';\n          } else {\n            x++;\n          }\n        }\n      }\n\n      out += ch;\n      attr = data;\n    }\n\n    if (attr !== this.dattr) {\n      out += '\\x1b[m';\n    }\n\n    if (out) {\n      main += (y > 0 ? '\\n' : '') + out;\n    }\n  }\n\n  main = main.replace(/(?:\\s*\\x1b\\[40m\\s*\\x1b\\[m\\s*)*$/, '') + '\\n';\n\n  if (term) {\n    this.dattr = sdattr;\n  }\n\n  return main;\n};\n\n/**\n * Positioning\n */\n\nScreen.prototype._getPos = function() {\n  return this;\n};\n\n/**\n * Angle Table\n */\n\nvar angles = {\n  '\\u2518': true, // ''\n  '\\u2510': true, // ''\n  '\\u250c': true, // ''\n  '\\u2514': true, // ''\n  '\\u253c': true, // ''\n  '\\u251c': true, // ''\n  '\\u2524': true, // ''\n  '\\u2534': true, // ''\n  '\\u252c': true, // ''\n  '\\u2502': true, // ''\n  '\\u2500': true  // ''\n};\n\nvar langles = {\n  '\\u250c': true, // ''\n  '\\u2514': true, // ''\n  '\\u253c': true, // ''\n  '\\u251c': true, // ''\n  '\\u2534': true, // ''\n  '\\u252c': true, // ''\n  '\\u2500': true  // ''\n};\n\nvar uangles = {\n  '\\u2510': true, // ''\n  '\\u250c': true, // ''\n  '\\u253c': true, // ''\n  '\\u251c': true, // ''\n  '\\u2524': true, // ''\n  '\\u252c': true, // ''\n  '\\u2502': true  // ''\n};\n\nvar rangles = {\n  '\\u2518': true, // ''\n  '\\u2510': true, // ''\n  '\\u253c': true, // ''\n  '\\u2524': true, // ''\n  '\\u2534': true, // ''\n  '\\u252c': true, // ''\n  '\\u2500': true  // ''\n};\n\nvar dangles = {\n  '\\u2518': true, // ''\n  '\\u2514': true, // ''\n  '\\u253c': true, // ''\n  '\\u251c': true, // ''\n  '\\u2524': true, // ''\n  '\\u2534': true, // ''\n  '\\u2502': true  // ''\n};\n\n// var cdangles = {\n//   '\\u250c': true  // ''\n// };\n\n// Every ACS angle character can be\n// represented by 4 bits ordered like this:\n// [langle][uangle][rangle][dangle]\nvar angleTable = {\n  '0000': '', // ?\n  '0001': '\\u2502', // '' // ?\n  '0010': '\\u2500', // '' // ??\n  '0011': '\\u250c', // ''\n  '0100': '\\u2502', // '' // ?\n  '0101': '\\u2502', // ''\n  '0110': '\\u2514', // ''\n  '0111': '\\u251c', // ''\n  '1000': '\\u2500', // '' // ??\n  '1001': '\\u2510', // ''\n  '1010': '\\u2500', // '' // ??\n  '1011': '\\u252c', // ''\n  '1100': '\\u2518', // ''\n  '1101': '\\u2524', // ''\n  '1110': '\\u2534', // ''\n  '1111': '\\u253c'  // ''\n};\n\nObject.keys(angleTable).forEach(function(key) {\n  angleTable[parseInt(key, 2)] = angleTable[key];\n  delete angleTable[key];\n});\n\n/**\n * Expose\n */\n\nmodule.exports = Screen;\n"]},"metadata":{},"sourceType":"script"}