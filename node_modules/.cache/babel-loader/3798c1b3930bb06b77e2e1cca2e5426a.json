{"ast":null,"code":"/**\n * element.js - base element for blessed\n * Copyright (c) 2013-2015, Christopher Jeffrey and contributors (MIT License).\n * https://github.com/chjj/blessed\n */\n\n/**\n * Modules\n */\nvar assert = require('assert');\n\nvar colors = require('../colors'),\n    unicode = require('../unicode');\n\nvar nextTick = global.setImmediate || process.nextTick.bind(process);\n\nvar helpers = require('../helpers');\n\nvar Node = require('./node');\n/**\n * Element\n */\n\n\nfunction Element(options) {\n  var self = this;\n\n  if (!(this instanceof Node)) {\n    return new Element(options);\n  }\n\n  options = options || {}; // Workaround to get a `scrollable` option.\n\n  if (options.scrollable && !this._ignore && this.type !== 'scrollable-box') {\n    var ScrollableBox = require('./scrollablebox');\n\n    Object.getOwnPropertyNames(ScrollableBox.prototype).forEach(function (key) {\n      if (key === 'type') return;\n      Object.defineProperty(this, key, Object.getOwnPropertyDescriptor(ScrollableBox.prototype, key));\n    }, this);\n    this._ignore = true;\n    ScrollableBox.call(this, options);\n    delete this._ignore;\n    return this;\n  }\n\n  Node.call(this, options);\n  this.name = options.name;\n  options.position = options.position || {\n    left: options.left,\n    right: options.right,\n    top: options.top,\n    bottom: options.bottom,\n    width: options.width,\n    height: options.height\n  };\n\n  if (options.position.width === 'shrink' || options.position.height === 'shrink') {\n    if (options.position.width === 'shrink') {\n      delete options.position.width;\n    }\n\n    if (options.position.height === 'shrink') {\n      delete options.position.height;\n    }\n\n    options.shrink = true;\n  }\n\n  this.position = options.position;\n  this.noOverflow = options.noOverflow;\n  this.dockBorders = options.dockBorders;\n  this.shadow = options.shadow;\n  this.style = options.style;\n\n  if (!this.style) {\n    this.style = {};\n    this.style.fg = options.fg;\n    this.style.bg = options.bg;\n    this.style.bold = options.bold;\n    this.style.underline = options.underline;\n    this.style.blink = options.blink;\n    this.style.inverse = options.inverse;\n    this.style.invisible = options.invisible;\n    this.style.transparent = options.transparent;\n  }\n\n  this.hidden = options.hidden || false;\n  this.fixed = options.fixed || false;\n  this.align = options.align || 'left';\n  this.valign = options.valign || 'top';\n  this.wrap = options.wrap !== false;\n  this.shrink = options.shrink;\n  this.fixed = options.fixed;\n  this.ch = options.ch || ' ';\n\n  if (typeof options.padding === 'number' || !options.padding) {\n    options.padding = {\n      left: options.padding,\n      top: options.padding,\n      right: options.padding,\n      bottom: options.padding\n    };\n  }\n\n  this.padding = {\n    left: options.padding.left || 0,\n    top: options.padding.top || 0,\n    right: options.padding.right || 0,\n    bottom: options.padding.bottom || 0\n  };\n  this.border = options.border;\n\n  if (this.border) {\n    if (typeof this.border === 'string') {\n      this.border = {\n        type: this.border\n      };\n    }\n\n    this.border.type = this.border.type || 'bg';\n    if (this.border.type === 'ascii') this.border.type = 'line';\n    this.border.ch = this.border.ch || ' ';\n    this.style.border = this.style.border || this.border.style;\n\n    if (!this.style.border) {\n      this.style.border = {};\n      this.style.border.fg = this.border.fg;\n      this.style.border.bg = this.border.bg;\n    } //this.border.style = this.style.border;\n\n\n    if (this.border.left == null) this.border.left = true;\n    if (this.border.top == null) this.border.top = true;\n    if (this.border.right == null) this.border.right = true;\n    if (this.border.bottom == null) this.border.bottom = true;\n  } // if (options.mouse || options.clickable) {\n\n\n  if (options.clickable) {\n    this.screen._listenMouse(this);\n  }\n\n  if (options.input || options.keyable) {\n    this.screen._listenKeys(this);\n  }\n\n  this.parseTags = options.parseTags || options.tags;\n  this.setContent(options.content || '', true);\n\n  if (options.label) {\n    this.setLabel(options.label);\n  }\n\n  if (options.hoverText) {\n    this.setHover(options.hoverText);\n  } // TODO: Possibly move this to Node for onScreenEvent('mouse', ...).\n\n\n  this.on('newListener', function fn(type) {\n    // type = type.split(' ').slice(1).join(' ');\n    if (type === 'mouse' || type === 'click' || type === 'mouseover' || type === 'mouseout' || type === 'mousedown' || type === 'mouseup' || type === 'mousewheel' || type === 'wheeldown' || type === 'wheelup' || type === 'mousemove') {\n      self.screen._listenMouse(self);\n    } else if (type === 'keypress' || type.indexOf('key ') === 0) {\n      self.screen._listenKeys(self);\n    }\n  });\n  this.on('resize', function () {\n    self.parseContent();\n  });\n  this.on('attach', function () {\n    self.parseContent();\n  });\n  this.on('detach', function () {\n    delete self.lpos;\n  });\n\n  if (options.hoverBg != null) {\n    options.hoverEffects = options.hoverEffects || {};\n    options.hoverEffects.bg = options.hoverBg;\n  }\n\n  if (this.style.hover) {\n    options.hoverEffects = this.style.hover;\n  }\n\n  if (this.style.focus) {\n    options.focusEffects = this.style.focus;\n  }\n\n  if (options.effects) {\n    if (options.effects.hover) options.hoverEffects = options.effects.hover;\n    if (options.effects.focus) options.focusEffects = options.effects.focus;\n  }\n\n  [['hoverEffects', 'mouseover', 'mouseout', '_htemp'], ['focusEffects', 'focus', 'blur', '_ftemp']].forEach(function (props) {\n    var pname = props[0],\n        over = props[1],\n        out = props[2],\n        temp = props[3];\n    self.screen.setEffects(self, self, over, out, self.options[pname], temp);\n  });\n\n  if (this.options.draggable) {\n    this.draggable = true;\n  }\n\n  if (options.focused) {\n    this.focus();\n  }\n}\n\nElement.prototype.__proto__ = Node.prototype;\nElement.prototype.type = 'element';\n\nElement.prototype.__defineGetter__('focused', function () {\n  return this.screen.focused === this;\n});\n\nElement.prototype.sattr = function (style, fg, bg) {\n  var bold = style.bold,\n      underline = style.underline,\n      blink = style.blink,\n      inverse = style.inverse,\n      invisible = style.invisible; // if (arguments.length === 1) {\n\n  if (fg == null && bg == null) {\n    fg = style.fg;\n    bg = style.bg;\n  } // This used to be a loop, but I decided\n  // to unroll it for performance's sake.\n\n\n  if (typeof bold === 'function') bold = bold(this);\n  if (typeof underline === 'function') underline = underline(this);\n  if (typeof blink === 'function') blink = blink(this);\n  if (typeof inverse === 'function') inverse = inverse(this);\n  if (typeof invisible === 'function') invisible = invisible(this);\n  if (typeof fg === 'function') fg = fg(this);\n  if (typeof bg === 'function') bg = bg(this); // return (this.uid << 24)\n  //   | ((this.dockBorders ? 32 : 0) << 18)\n\n  return (invisible ? 16 : 0) << 18 | (inverse ? 8 : 0) << 18 | (blink ? 4 : 0) << 18 | (underline ? 2 : 0) << 18 | (bold ? 1 : 0) << 18 | colors.convert(fg) << 9 | colors.convert(bg);\n};\n\nElement.prototype.onScreenEvent = function (type, handler) {\n  var listeners = this._slisteners = this._slisteners || [];\n  listeners.push({\n    type: type,\n    handler: handler\n  });\n  this.screen.on(type, handler);\n};\n\nElement.prototype.onceScreenEvent = function (type, handler) {\n  var listeners = this._slisteners = this._slisteners || [];\n  var entry = {\n    type: type,\n    handler: handler\n  };\n  listeners.push(entry);\n  this.screen.once(type, function () {\n    var i = listeners.indexOf(entry);\n    if (~i) listeners.splice(i, 1);\n    return handler.apply(this, arguments);\n  });\n};\n\nElement.prototype.removeScreenEvent = function (type, handler) {\n  var listeners = this._slisteners = this._slisteners || [];\n\n  for (var i = 0; i < listeners.length; i++) {\n    var listener = listeners[i];\n\n    if (listener.type === type && listener.handler === handler) {\n      listeners.splice(i, 1);\n\n      if (this._slisteners.length === 0) {\n        delete this._slisteners;\n      }\n\n      break;\n    }\n  }\n\n  this.screen.removeListener(type, handler);\n};\n\nElement.prototype.free = function () {\n  var listeners = this._slisteners = this._slisteners || [];\n\n  for (var i = 0; i < listeners.length; i++) {\n    var listener = listeners[i];\n    this.screen.removeListener(listener.type, listener.handler);\n  }\n\n  delete this._slisteners;\n};\n\nElement.prototype.hide = function () {\n  if (this.hidden) return;\n  this.clearPos();\n  this.hidden = true;\n  this.emit('hide');\n\n  if (this.screen.focused === this) {\n    this.screen.rewindFocus();\n  }\n};\n\nElement.prototype.show = function () {\n  if (!this.hidden) return;\n  this.hidden = false;\n  this.emit('show');\n};\n\nElement.prototype.toggle = function () {\n  return this.hidden ? this.show() : this.hide();\n};\n\nElement.prototype.focus = function () {\n  return this.screen.focused = this;\n};\n\nElement.prototype.setContent = function (content, noClear, noTags) {\n  if (!noClear) this.clearPos();\n  this.content = content || '';\n  this.parseContent(noTags);\n  this.emit('set content');\n};\n\nElement.prototype.getContent = function () {\n  if (!this._clines) return '';\n  return this._clines.fake.join('\\n');\n};\n\nElement.prototype.setText = function (content, noClear) {\n  content = content || '';\n  content = content.replace(/\\x1b\\[[\\d;]*m/g, '');\n  return this.setContent(content, noClear, true);\n};\n\nElement.prototype.getText = function () {\n  return this.getContent().replace(/\\x1b\\[[\\d;]*m/g, '');\n};\n\nElement.prototype.parseContent = function (noTags) {\n  if (this.detached) return false;\n  var width = this.width - this.iwidth;\n\n  if (this._clines == null || this._clines.width !== width || this._clines.content !== this.content) {\n    var content = this.content;\n    content = content.replace(/[\\x00-\\x08\\x0b-\\x0c\\x0e-\\x1a\\x1c-\\x1f\\x7f]/g, '').replace(/\\x1b(?!\\[[\\d;]*m)/g, '').replace(/\\r\\n|\\r/g, '\\n').replace(/\\t/g, this.screen.tabc);\n\n    if (this.screen.fullUnicode) {\n      // double-width chars will eat the next char after render. create a\n      // blank character after it so it doesn't eat the real next char.\n      content = content.replace(unicode.chars.all, '$1\\x03'); // iTerm2 cannot render combining characters properly.\n\n      if (this.screen.program.isiTerm2) {\n        content = content.replace(unicode.chars.combining, '');\n      }\n    } else {\n      // no double-width: replace them with question-marks.\n      content = content.replace(unicode.chars.all, '??'); // delete combining characters since they're 0-width anyway.\n      // NOTE: We could drop this, the non-surrogates would get changed to ? by\n      // the unicode filter, and surrogates changed to ? by the surrogate\n      // regex. however, the user might expect them to be 0-width.\n      // NOTE: Might be better for performance to drop!\n\n      content = content.replace(unicode.chars.combining, ''); // no surrogate pairs: replace them with question-marks.\n\n      content = content.replace(unicode.chars.surrogate, '?'); // XXX Deduplicate code here:\n      // content = helpers.dropUnicode(content);\n    }\n\n    if (!noTags) {\n      content = this._parseTags(content);\n    }\n\n    this._clines = this._wrapContent(content, width);\n    this._clines.width = width;\n    this._clines.content = this.content;\n    this._clines.attr = this._parseAttr(this._clines);\n    this._clines.ci = [];\n\n    this._clines.reduce(function (total, line) {\n      this._clines.ci.push(total);\n\n      return total + line.length + 1;\n    }.bind(this), 0);\n\n    this._pcontent = this._clines.join('\\n');\n    this.emit('parsed content');\n    return true;\n  } // Need to calculate this every time because the default fg/bg may change.\n\n\n  this._clines.attr = this._parseAttr(this._clines) || this._clines.attr;\n  return false;\n}; // Convert `{red-fg}foo{/red-fg}` to `\\x1b[31mfoo\\x1b[39m`.\n\n\nElement.prototype._parseTags = function (text) {\n  if (!this.parseTags) return text;\n  if (!/{\\/?[\\w\\-,;!#]*}/.test(text)) return text;\n  var program = this.screen.program,\n      out = '',\n      state,\n      bg = [],\n      fg = [],\n      flag = [],\n      cap,\n      slash,\n      param,\n      attr,\n      esc;\n\n  for (;;) {\n    if (!esc && (cap = /^{escape}/.exec(text))) {\n      text = text.substring(cap[0].length);\n      esc = true;\n      continue;\n    }\n\n    if (esc && (cap = /^([\\s\\S]+?){\\/escape}/.exec(text))) {\n      text = text.substring(cap[0].length);\n      out += cap[1];\n      esc = false;\n      continue;\n    }\n\n    if (esc) {\n      // throw new Error('Unterminated escape tag.');\n      out += text;\n      break;\n    }\n\n    if (cap = /^{(\\/?)([\\w\\-,;!#]*)}/.exec(text)) {\n      text = text.substring(cap[0].length);\n      slash = cap[1] === '/';\n      param = cap[2].replace(/-/g, ' ');\n\n      if (param === 'open') {\n        out += '{';\n        continue;\n      } else if (param === 'close') {\n        out += '}';\n        continue;\n      }\n\n      if (param.slice(-3) === ' bg') state = bg;else if (param.slice(-3) === ' fg') state = fg;else state = flag;\n\n      if (slash) {\n        if (!param) {\n          out += program._attr('normal');\n          bg.length = 0;\n          fg.length = 0;\n          flag.length = 0;\n        } else {\n          attr = program._attr(param, false);\n\n          if (attr == null) {\n            out += cap[0];\n          } else {\n            // if (param !== state[state.length - 1]) {\n            //   throw new Error('Misnested tags.');\n            // }\n            state.pop();\n\n            if (state.length) {\n              out += program._attr(state[state.length - 1]);\n            } else {\n              out += attr;\n            }\n          }\n        }\n      } else {\n        if (!param) {\n          out += cap[0];\n        } else {\n          attr = program._attr(param);\n\n          if (attr == null) {\n            out += cap[0];\n          } else {\n            state.push(param);\n            out += attr;\n          }\n        }\n      }\n\n      continue;\n    }\n\n    if (cap = /^[\\s\\S]+?(?={\\/?[\\w\\-,;!#]*})/.exec(text)) {\n      text = text.substring(cap[0].length);\n      out += cap[0];\n      continue;\n    }\n\n    out += text;\n    break;\n  }\n\n  return out;\n};\n\nElement.prototype._parseAttr = function (lines) {\n  var dattr = this.sattr(this.style),\n      attr = dattr,\n      attrs = [],\n      line,\n      i,\n      j,\n      c;\n\n  if (lines[0].attr === attr) {\n    return;\n  }\n\n  for (j = 0; j < lines.length; j++) {\n    line = lines[j];\n    attrs[j] = attr;\n\n    for (i = 0; i < line.length; i++) {\n      if (line[i] === '\\x1b') {\n        if (c = /^\\x1b\\[[\\d;]*m/.exec(line.substring(i))) {\n          attr = this.screen.attrCode(c[0], attr, dattr);\n          i += c[0].length - 1;\n        }\n      }\n    }\n  }\n\n  return attrs;\n};\n\nElement.prototype._align = function (line, width, align) {\n  if (!align) return line; //if (!align && !~line.indexOf('{|}')) return line;\n\n  var cline = line.replace(/\\x1b\\[[\\d;]*m/g, ''),\n      len = cline.length,\n      s = width - len;\n\n  if (this.shrink) {\n    s = 0;\n  }\n\n  if (len === 0) return line;\n  if (s < 0) return line;\n\n  if (align === 'center') {\n    s = Array((s / 2 | 0) + 1).join(' ');\n    return s + line + s;\n  } else if (align === 'right') {\n    s = Array(s + 1).join(' ');\n    return s + line;\n  } else if (this.parseTags && ~line.indexOf('{|}')) {\n    var parts = line.split('{|}');\n    var cparts = cline.split('{|}');\n    s = Math.max(width - cparts[0].length - cparts[1].length, 0);\n    s = Array(s + 1).join(' ');\n    return parts[0] + s + parts[1];\n  }\n\n  return line;\n};\n\nElement.prototype._wrapContent = function (content, width) {\n  var tags = this.parseTags,\n      state = this.align,\n      wrap = this.wrap,\n      margin = 0,\n      rtof = [],\n      ftor = [],\n      out = [],\n      no = 0,\n      line,\n      align,\n      cap,\n      total,\n      i,\n      part,\n      j,\n      lines,\n      rest;\n  lines = content.split('\\n');\n\n  if (!content) {\n    out.push(content);\n    out.rtof = [0];\n    out.ftor = [[0]];\n    out.fake = lines;\n    out.real = out;\n    out.mwidth = 0;\n    return out;\n  }\n\n  if (this.scrollbar) margin++;\n  if (this.type === 'textarea') margin++;\n  if (width > margin) width -= margin;\n\n  main: for (; no < lines.length; no++) {\n    line = lines[no];\n    align = state;\n    ftor.push([]); // Handle alignment tags.\n\n    if (tags) {\n      if (cap = /^{(left|center|right)}/.exec(line)) {\n        line = line.substring(cap[0].length);\n        align = state = cap[1] !== 'left' ? cap[1] : null;\n      }\n\n      if (cap = /{\\/(left|center|right)}$/.exec(line)) {\n        line = line.slice(0, -cap[0].length); //state = null;\n\n        state = this.align;\n      }\n    } // If the string is apparently too long, wrap it.\n\n\n    while (line.length > width) {\n      // Measure the real width of the string.\n      for (i = 0, total = 0; i < line.length; i++) {\n        while (line[i] === '\\x1b') {\n          while (line[i] && line[i++] !== 'm');\n        }\n\n        if (!line[i]) break;\n\n        if (++total === width) {\n          // If we're not wrapping the text, we have to finish up the rest of\n          // the control sequences before cutting off the line.\n          i++;\n\n          if (!wrap) {\n            rest = line.substring(i).match(/\\x1b\\[[^m]*m/g);\n            rest = rest ? rest.join('') : '';\n            out.push(this._align(line.substring(0, i) + rest, width, align));\n            ftor[no].push(out.length - 1);\n            rtof.push(no);\n            continue main;\n          }\n\n          if (!this.screen.fullUnicode) {\n            // Try to find a space to break on.\n            if (i !== line.length) {\n              j = i;\n\n              while (j > i - 10 && j > 0 && line[--j] !== ' ');\n\n              if (line[j] === ' ') i = j + 1;\n            }\n          } else {\n            // Try to find a character to break on.\n            if (i !== line.length) {\n              // <XXX>\n              // Compensate for surrogate length\n              // counts on wrapping (experimental):\n              // NOTE: Could optimize this by putting\n              // it in the parent for loop.\n              if (unicode.isSurrogate(line, i)) i--;\n\n              for (var s = 0, n = 0; n < i; n++) {\n                if (unicode.isSurrogate(line, n)) s++, n++;\n              }\n\n              i += s; // </XXX>\n\n              j = i; // Break _past_ space.\n              // Break _past_ double-width chars.\n              // Break _past_ surrogate pairs.\n              // Break _past_ combining chars.\n\n              while (j > i - 10 && j > 0) {\n                j--;\n\n                if (line[j] === ' ' || line[j] === '\\x03' || unicode.isSurrogate(line, j - 1) && line[j + 1] !== '\\x03' || unicode.isCombining(line, j)) {\n                  break;\n                }\n              }\n\n              if (line[j] === ' ' || line[j] === '\\x03' || unicode.isSurrogate(line, j - 1) && line[j + 1] !== '\\x03' || unicode.isCombining(line, j)) {\n                i = j + 1;\n              }\n            }\n          }\n\n          break;\n        }\n      }\n\n      part = line.substring(0, i);\n      line = line.substring(i);\n      out.push(this._align(part, width, align));\n      ftor[no].push(out.length - 1);\n      rtof.push(no); // Make sure we didn't wrap the line to the very end, otherwise\n      // we get a pointless empty line after a newline.\n\n      if (line === '') continue main; // If only an escape code got cut off, at it to `part`.\n\n      if (/^(?:\\x1b[\\[\\d;]*m)+$/.test(line)) {\n        out[out.length - 1] += line;\n        continue main;\n      }\n    }\n\n    out.push(this._align(line, width, align));\n    ftor[no].push(out.length - 1);\n    rtof.push(no);\n  }\n\n  out.rtof = rtof;\n  out.ftor = ftor;\n  out.fake = lines;\n  out.real = out;\n  out.mwidth = out.reduce(function (current, line) {\n    line = line.replace(/\\x1b\\[[\\d;]*m/g, '');\n    return line.length > current ? line.length : current;\n  }, 0);\n  return out;\n};\n\nElement.prototype.__defineGetter__('visible', function () {\n  var el = this;\n\n  do {\n    if (el.detached) return false;\n    if (el.hidden) return false; // if (!el.lpos) return false;\n    // if (el.position.width === 0 || el.position.height === 0) return false;\n  } while (el = el.parent);\n\n  return true;\n});\n\nElement.prototype.__defineGetter__('_detached', function () {\n  var el = this;\n\n  do {\n    if (el.type === 'screen') return false;\n    if (!el.parent) return true;\n  } while (el = el.parent);\n\n  return false;\n});\n\nElement.prototype.enableMouse = function () {\n  this.screen._listenMouse(this);\n};\n\nElement.prototype.enableKeys = function () {\n  this.screen._listenKeys(this);\n};\n\nElement.prototype.enableInput = function () {\n  this.screen._listenMouse(this);\n\n  this.screen._listenKeys(this);\n};\n\nElement.prototype.__defineGetter__('draggable', function () {\n  return this._draggable === true;\n});\n\nElement.prototype.__defineSetter__('draggable', function (draggable) {\n  return draggable ? this.enableDrag(draggable) : this.disableDrag();\n});\n\nElement.prototype.enableDrag = function (verify) {\n  var self = this;\n  if (this._draggable) return true;\n\n  if (typeof verify !== 'function') {\n    verify = function () {\n      return true;\n    };\n  }\n\n  this.enableMouse();\n  this.on('mousedown', this._dragMD = function (data) {\n    if (self.screen._dragging) return;\n    if (!verify(data)) return;\n    self.screen._dragging = self;\n    self._drag = {\n      x: data.x - self.aleft,\n      y: data.y - self.atop\n    };\n    self.setFront();\n  });\n  this.onScreenEvent('mouse', this._dragM = function (data) {\n    if (self.screen._dragging !== self) return;\n\n    if (data.action !== 'mousedown' && data.action !== 'mousemove') {\n      delete self.screen._dragging;\n      delete self._drag;\n      return;\n    } // This can happen in edge cases where the user is\n    // already dragging and element when it is detached.\n\n\n    if (!self.parent) return;\n    var ox = self._drag.x,\n        oy = self._drag.y,\n        px = self.parent.aleft,\n        py = self.parent.atop,\n        x = data.x - px - ox,\n        y = data.y - py - oy;\n\n    if (self.position.right != null) {\n      if (self.position.left != null) {\n        self.width = '100%-' + (self.parent.width - self.width);\n      }\n\n      self.position.right = null;\n    }\n\n    if (self.position.bottom != null) {\n      if (self.position.top != null) {\n        self.height = '100%-' + (self.parent.height - self.height);\n      }\n\n      self.position.bottom = null;\n    }\n\n    self.rleft = x;\n    self.rtop = y;\n    self.screen.render();\n  });\n  return this._draggable = true;\n};\n\nElement.prototype.disableDrag = function () {\n  if (!this._draggable) return false;\n  delete this.screen._dragging;\n  delete this._drag;\n  this.removeListener('mousedown', this._dragMD);\n  this.removeScreenEvent('mouse', this._dragM);\n  return this._draggable = false;\n};\n\nElement.prototype.key = function () {\n  return this.screen.program.key.apply(this, arguments);\n};\n\nElement.prototype.onceKey = function () {\n  return this.screen.program.onceKey.apply(this, arguments);\n};\n\nElement.prototype.unkey = Element.prototype.removeKey = function () {\n  return this.screen.program.unkey.apply(this, arguments);\n};\n\nElement.prototype.setIndex = function (index) {\n  if (!this.parent) return;\n\n  if (index < 0) {\n    index = this.parent.children.length + index;\n  }\n\n  index = Math.max(index, 0);\n  index = Math.min(index, this.parent.children.length - 1);\n  var i = this.parent.children.indexOf(this);\n  if (!~i) return;\n  var item = this.parent.children.splice(i, 1)[0];\n  this.parent.children.splice(index, 0, item);\n};\n\nElement.prototype.setFront = function () {\n  return this.setIndex(-1);\n};\n\nElement.prototype.setBack = function () {\n  return this.setIndex(0);\n};\n\nElement.prototype.clearPos = function (get, override) {\n  if (this.detached) return;\n\n  var lpos = this._getCoords(get);\n\n  if (!lpos) return;\n  this.screen.clearRegion(lpos.xi, lpos.xl, lpos.yi, lpos.yl, override);\n};\n\nElement.prototype.setLabel = function (options) {\n  var self = this;\n\n  var Box = require('./box');\n\n  if (typeof options === 'string') {\n    options = {\n      text: options\n    };\n  }\n\n  if (this._label) {\n    this._label.setContent(options.text);\n\n    if (options.side !== 'right') {\n      this._label.rleft = 2 + (this.border ? -1 : 0);\n      this._label.position.right = undefined;\n\n      if (!this.screen.autoPadding) {\n        this._label.rleft = 2;\n      }\n    } else {\n      this._label.rright = 2 + (this.border ? -1 : 0);\n      this._label.position.left = undefined;\n\n      if (!this.screen.autoPadding) {\n        this._label.rright = 2;\n      }\n    }\n\n    return;\n  }\n\n  this._label = new Box({\n    screen: this.screen,\n    parent: this,\n    content: options.text,\n    top: -this.itop,\n    tags: this.parseTags,\n    shrink: true,\n    style: this.style.label\n  });\n\n  if (options.side !== 'right') {\n    this._label.rleft = 2 - this.ileft;\n  } else {\n    this._label.rright = 2 - this.iright;\n  }\n\n  this._label._isLabel = true;\n\n  if (!this.screen.autoPadding) {\n    if (options.side !== 'right') {\n      this._label.rleft = 2;\n    } else {\n      this._label.rright = 2;\n    }\n\n    this._label.rtop = 0;\n  }\n\n  var reposition = function () {\n    self._label.rtop = (self.childBase || 0) - self.itop;\n\n    if (!self.screen.autoPadding) {\n      self._label.rtop = self.childBase || 0;\n    }\n\n    self.screen.render();\n  };\n\n  this.on('scroll', this._labelScroll = function () {\n    reposition();\n  });\n  this.on('resize', this._labelResize = function () {\n    nextTick(function () {\n      reposition();\n    });\n  });\n};\n\nElement.prototype.removeLabel = function () {\n  if (!this._label) return;\n  this.removeListener('scroll', this._labelScroll);\n  this.removeListener('resize', this._labelResize);\n\n  this._label.detach();\n\n  delete this._labelScroll;\n  delete this._labelResize;\n  delete this._label;\n};\n\nElement.prototype.setHover = function (options) {\n  if (typeof options === 'string') {\n    options = {\n      text: options\n    };\n  }\n\n  this._hoverOptions = options;\n  this.enableMouse();\n\n  this.screen._initHover();\n};\n\nElement.prototype.removeHover = function () {\n  delete this._hoverOptions;\n  if (!this.screen._hoverText || this.screen._hoverText.detached) return;\n\n  this.screen._hoverText.detach();\n\n  this.screen.render();\n};\n/**\n * Positioning\n */\n// The below methods are a bit confusing: basically\n// whenever Box.render is called `lpos` gets set on\n// the element, an object containing the rendered\n// coordinates. Since these don't update if the\n// element is moved somehow, they're unreliable in\n// that situation. However, if we can guarantee that\n// lpos is good and up to date, it can be more\n// accurate than the calculated positions below.\n// In this case, if the element is being rendered,\n// it's guaranteed that the parent will have been\n// rendered first, in which case we can use the\n// parant's lpos instead of recalculating it's\n// position (since that might be wrong because\n// it doesn't handle content shrinkage).\n\n\nElement.prototype._getPos = function () {\n  var pos = this.lpos;\n  assert.ok(pos);\n  if (pos.aleft != null) return pos;\n  pos.aleft = pos.xi;\n  pos.atop = pos.yi;\n  pos.aright = this.screen.cols - pos.xl;\n  pos.abottom = this.screen.rows - pos.yl;\n  pos.width = pos.xl - pos.xi;\n  pos.height = pos.yl - pos.yi;\n  return pos;\n};\n/**\n * Position Getters\n */\n\n\nElement.prototype._getWidth = function (get) {\n  var parent = get ? this.parent._getPos() : this.parent,\n      width = this.position.width,\n      left,\n      expr;\n\n  if (typeof width === 'string') {\n    if (width === 'half') width = '50%';\n    expr = width.split(/(?=\\+|-)/);\n    width = expr[0];\n    width = +width.slice(0, -1) / 100;\n    width = parent.width * width | 0;\n    width += +(expr[1] || 0);\n    return width;\n  } // This is for if the element is being streched or shrunken.\n  // Although the width for shrunken elements is calculated\n  // in the render function, it may be calculated based on\n  // the content width, and the content width is initially\n  // decided by the width the element, so it needs to be\n  // calculated here.\n\n\n  if (width == null) {\n    left = this.position.left || 0;\n\n    if (typeof left === 'string') {\n      if (left === 'center') left = '50%';\n      expr = left.split(/(?=\\+|-)/);\n      left = expr[0];\n      left = +left.slice(0, -1) / 100;\n      left = parent.width * left | 0;\n      left += +(expr[1] || 0);\n    }\n\n    width = parent.width - (this.position.right || 0) - left;\n\n    if (this.screen.autoPadding) {\n      if ((this.position.left != null || this.position.right == null) && this.position.left !== 'center') {\n        width -= this.parent.ileft;\n      }\n\n      width -= this.parent.iright;\n    }\n  }\n\n  return width;\n};\n\nElement.prototype.__defineGetter__('width', function () {\n  return this._getWidth(false);\n});\n\nElement.prototype._getHeight = function (get) {\n  var parent = get ? this.parent._getPos() : this.parent,\n      height = this.position.height,\n      top,\n      expr;\n\n  if (typeof height === 'string') {\n    if (height === 'half') height = '50%';\n    expr = height.split(/(?=\\+|-)/);\n    height = expr[0];\n    height = +height.slice(0, -1) / 100;\n    height = parent.height * height | 0;\n    height += +(expr[1] || 0);\n    return height;\n  } // This is for if the element is being streched or shrunken.\n  // Although the width for shrunken elements is calculated\n  // in the render function, it may be calculated based on\n  // the content width, and the content width is initially\n  // decided by the width the element, so it needs to be\n  // calculated here.\n\n\n  if (height == null) {\n    top = this.position.top || 0;\n\n    if (typeof top === 'string') {\n      if (top === 'center') top = '50%';\n      expr = top.split(/(?=\\+|-)/);\n      top = expr[0];\n      top = +top.slice(0, -1) / 100;\n      top = parent.height * top | 0;\n      top += +(expr[1] || 0);\n    }\n\n    height = parent.height - (this.position.bottom || 0) - top;\n\n    if (this.screen.autoPadding) {\n      if ((this.position.top != null || this.position.bottom == null) && this.position.top !== 'center') {\n        height -= this.parent.itop;\n      }\n\n      height -= this.parent.ibottom;\n    }\n  }\n\n  return height;\n};\n\nElement.prototype.__defineGetter__('height', function () {\n  return this._getHeight(false);\n});\n\nElement.prototype._getLeft = function (get) {\n  var parent = get ? this.parent._getPos() : this.parent,\n      left = this.position.left || 0,\n      expr;\n\n  if (typeof left === 'string') {\n    if (left === 'center') left = '50%';\n    expr = left.split(/(?=\\+|-)/);\n    left = expr[0];\n    left = +left.slice(0, -1) / 100;\n    left = parent.width * left | 0;\n    left += +(expr[1] || 0);\n\n    if (this.position.left === 'center') {\n      left -= this._getWidth(get) / 2 | 0;\n    }\n  }\n\n  if (this.position.left == null && this.position.right != null) {\n    return this.screen.cols - this._getWidth(get) - this._getRight(get);\n  }\n\n  if (this.screen.autoPadding) {\n    if ((this.position.left != null || this.position.right == null) && this.position.left !== 'center') {\n      left += this.parent.ileft;\n    }\n  }\n\n  return (parent.aleft || 0) + left;\n};\n\nElement.prototype.__defineGetter__('aleft', function () {\n  return this._getLeft(false);\n});\n\nElement.prototype._getRight = function (get) {\n  var parent = get ? this.parent._getPos() : this.parent,\n      right;\n\n  if (this.position.right == null && this.position.left != null) {\n    right = this.screen.cols - (this._getLeft(get) + this._getWidth(get));\n\n    if (this.screen.autoPadding) {\n      right += this.parent.iright;\n    }\n\n    return right;\n  }\n\n  right = (parent.aright || 0) + (this.position.right || 0);\n\n  if (this.screen.autoPadding) {\n    right += this.parent.iright;\n  }\n\n  return right;\n};\n\nElement.prototype.__defineGetter__('aright', function () {\n  return this._getRight(false);\n});\n\nElement.prototype._getTop = function (get) {\n  var parent = get ? this.parent._getPos() : this.parent,\n      top = this.position.top || 0,\n      expr;\n\n  if (typeof top === 'string') {\n    if (top === 'center') top = '50%';\n    expr = top.split(/(?=\\+|-)/);\n    top = expr[0];\n    top = +top.slice(0, -1) / 100;\n    top = parent.height * top | 0;\n    top += +(expr[1] || 0);\n\n    if (this.position.top === 'center') {\n      top -= this._getHeight(get) / 2 | 0;\n    }\n  }\n\n  if (this.position.top == null && this.position.bottom != null) {\n    return this.screen.rows - this._getHeight(get) - this._getBottom(get);\n  }\n\n  if (this.screen.autoPadding) {\n    if ((this.position.top != null || this.position.bottom == null) && this.position.top !== 'center') {\n      top += this.parent.itop;\n    }\n  }\n\n  return (parent.atop || 0) + top;\n};\n\nElement.prototype.__defineGetter__('atop', function () {\n  return this._getTop(false);\n});\n\nElement.prototype._getBottom = function (get) {\n  var parent = get ? this.parent._getPos() : this.parent,\n      bottom;\n\n  if (this.position.bottom == null && this.position.top != null) {\n    bottom = this.screen.rows - (this._getTop(get) + this._getHeight(get));\n\n    if (this.screen.autoPadding) {\n      bottom += this.parent.ibottom;\n    }\n\n    return bottom;\n  }\n\n  bottom = (parent.abottom || 0) + (this.position.bottom || 0);\n\n  if (this.screen.autoPadding) {\n    bottom += this.parent.ibottom;\n  }\n\n  return bottom;\n};\n\nElement.prototype.__defineGetter__('abottom', function () {\n  return this._getBottom(false);\n});\n\nElement.prototype.__defineGetter__('rleft', function () {\n  return this.aleft - this.parent.aleft;\n});\n\nElement.prototype.__defineGetter__('rright', function () {\n  return this.aright - this.parent.aright;\n});\n\nElement.prototype.__defineGetter__('rtop', function () {\n  return this.atop - this.parent.atop;\n});\n\nElement.prototype.__defineGetter__('rbottom', function () {\n  return this.abottom - this.parent.abottom;\n});\n/**\n * Position Setters\n */\n// NOTE:\n// For aright, abottom, right, and bottom:\n// If position.bottom is null, we could simply set top instead.\n// But it wouldn't replicate bottom behavior appropriately if\n// the parent was resized, etc.\n\n\nElement.prototype.__defineSetter__('width', function (val) {\n  if (this.position.width === val) return;\n  if (/^\\d+$/.test(val)) val = +val;\n  this.emit('resize');\n  this.clearPos();\n  return this.position.width = val;\n});\n\nElement.prototype.__defineSetter__('height', function (val) {\n  if (this.position.height === val) return;\n  if (/^\\d+$/.test(val)) val = +val;\n  this.emit('resize');\n  this.clearPos();\n  return this.position.height = val;\n});\n\nElement.prototype.__defineSetter__('aleft', function (val) {\n  var expr;\n\n  if (typeof val === 'string') {\n    if (val === 'center') {\n      val = this.screen.width / 2 | 0;\n      val -= this.width / 2 | 0;\n    } else {\n      expr = val.split(/(?=\\+|-)/);\n      val = expr[0];\n      val = +val.slice(0, -1) / 100;\n      val = this.screen.width * val | 0;\n      val += +(expr[1] || 0);\n    }\n  }\n\n  val -= this.parent.aleft;\n  if (this.position.left === val) return;\n  this.emit('move');\n  this.clearPos();\n  return this.position.left = val;\n});\n\nElement.prototype.__defineSetter__('aright', function (val) {\n  val -= this.parent.aright;\n  if (this.position.right === val) return;\n  this.emit('move');\n  this.clearPos();\n  return this.position.right = val;\n});\n\nElement.prototype.__defineSetter__('atop', function (val) {\n  var expr;\n\n  if (typeof val === 'string') {\n    if (val === 'center') {\n      val = this.screen.height / 2 | 0;\n      val -= this.height / 2 | 0;\n    } else {\n      expr = val.split(/(?=\\+|-)/);\n      val = expr[0];\n      val = +val.slice(0, -1) / 100;\n      val = this.screen.height * val | 0;\n      val += +(expr[1] || 0);\n    }\n  }\n\n  val -= this.parent.atop;\n  if (this.position.top === val) return;\n  this.emit('move');\n  this.clearPos();\n  return this.position.top = val;\n});\n\nElement.prototype.__defineSetter__('abottom', function (val) {\n  val -= this.parent.abottom;\n  if (this.position.bottom === val) return;\n  this.emit('move');\n  this.clearPos();\n  return this.position.bottom = val;\n});\n\nElement.prototype.__defineSetter__('rleft', function (val) {\n  if (this.position.left === val) return;\n  if (/^\\d+$/.test(val)) val = +val;\n  this.emit('move');\n  this.clearPos();\n  return this.position.left = val;\n});\n\nElement.prototype.__defineSetter__('rright', function (val) {\n  if (this.position.right === val) return;\n  this.emit('move');\n  this.clearPos();\n  return this.position.right = val;\n});\n\nElement.prototype.__defineSetter__('rtop', function (val) {\n  if (this.position.top === val) return;\n  if (/^\\d+$/.test(val)) val = +val;\n  this.emit('move');\n  this.clearPos();\n  return this.position.top = val;\n});\n\nElement.prototype.__defineSetter__('rbottom', function (val) {\n  if (this.position.bottom === val) return;\n  this.emit('move');\n  this.clearPos();\n  return this.position.bottom = val;\n});\n\nElement.prototype.__defineGetter__('ileft', function () {\n  return (this.border ? 1 : 0) + this.padding.left; // return (this.border && this.border.left ? 1 : 0) + this.padding.left;\n});\n\nElement.prototype.__defineGetter__('itop', function () {\n  return (this.border ? 1 : 0) + this.padding.top; // return (this.border && this.border.top ? 1 : 0) + this.padding.top;\n});\n\nElement.prototype.__defineGetter__('iright', function () {\n  return (this.border ? 1 : 0) + this.padding.right; // return (this.border && this.border.right ? 1 : 0) + this.padding.right;\n});\n\nElement.prototype.__defineGetter__('ibottom', function () {\n  return (this.border ? 1 : 0) + this.padding.bottom; // return (this.border && this.border.bottom ? 1 : 0) + this.padding.bottom;\n});\n\nElement.prototype.__defineGetter__('iwidth', function () {\n  // return (this.border\n  //   ? ((this.border.left ? 1 : 0) + (this.border.right ? 1 : 0)) : 0)\n  //   + this.padding.left + this.padding.right;\n  return (this.border ? 2 : 0) + this.padding.left + this.padding.right;\n});\n\nElement.prototype.__defineGetter__('iheight', function () {\n  // return (this.border\n  //   ? ((this.border.top ? 1 : 0) + (this.border.bottom ? 1 : 0)) : 0)\n  //   + this.padding.top + this.padding.bottom;\n  return (this.border ? 2 : 0) + this.padding.top + this.padding.bottom;\n});\n\nElement.prototype.__defineGetter__('tpadding', function () {\n  return this.padding.left + this.padding.top + this.padding.right + this.padding.bottom;\n});\n/**\n * Relative coordinates as default properties\n */\n\n\nElement.prototype.__defineGetter__('left', function () {\n  return this.rleft;\n});\n\nElement.prototype.__defineGetter__('right', function () {\n  return this.rright;\n});\n\nElement.prototype.__defineGetter__('top', function () {\n  return this.rtop;\n});\n\nElement.prototype.__defineGetter__('bottom', function () {\n  return this.rbottom;\n});\n\nElement.prototype.__defineSetter__('left', function (val) {\n  return this.rleft = val;\n});\n\nElement.prototype.__defineSetter__('right', function (val) {\n  return this.rright = val;\n});\n\nElement.prototype.__defineSetter__('top', function (val) {\n  return this.rtop = val;\n});\n\nElement.prototype.__defineSetter__('bottom', function (val) {\n  return this.rbottom = val;\n});\n/**\n * Rendering - here be dragons\n */\n\n\nElement.prototype._getShrinkBox = function (xi, xl, yi, yl, get) {\n  if (!this.children.length) {\n    return {\n      xi: xi,\n      xl: xi + 1,\n      yi: yi,\n      yl: yi + 1\n    };\n  }\n\n  var i,\n      el,\n      ret,\n      mxi = xi,\n      mxl = xi + 1,\n      myi = yi,\n      myl = yi + 1; // This is a chicken and egg problem. We need to determine how the children\n  // will render in order to determine how this element renders, but it in\n  // order to figure out how the children will render, they need to know\n  // exactly how their parent renders, so, we can give them what we have so\n  // far.\n\n  var _lpos;\n\n  if (get) {\n    _lpos = this.lpos;\n    this.lpos = {\n      xi: xi,\n      xl: xl,\n      yi: yi,\n      yl: yl\n    }; //this.shrink = false;\n  }\n\n  for (i = 0; i < this.children.length; i++) {\n    el = this.children[i];\n    ret = el._getCoords(get); // Or just (seemed to work, but probably not good):\n    // ret = el.lpos || this.lpos;\n\n    if (!ret) continue; // Since the parent element is shrunk, and the child elements think it's\n    // going to take up as much space as possible, an element anchored to the\n    // right or bottom will inadvertantly make the parent's shrunken size as\n    // large as possible. So, we can just use the height and/or width the of\n    // element.\n    // if (get) {\n\n    if (el.position.left == null && el.position.right != null) {\n      ret.xl = xi + (ret.xl - ret.xi);\n      ret.xi = xi;\n\n      if (this.screen.autoPadding) {\n        // Maybe just do this no matter what.\n        ret.xl += this.ileft;\n        ret.xi += this.ileft;\n      }\n    }\n\n    if (el.position.top == null && el.position.bottom != null) {\n      ret.yl = yi + (ret.yl - ret.yi);\n      ret.yi = yi;\n\n      if (this.screen.autoPadding) {\n        // Maybe just do this no matter what.\n        ret.yl += this.itop;\n        ret.yi += this.itop;\n      }\n    }\n\n    if (ret.xi < mxi) mxi = ret.xi;\n    if (ret.xl > mxl) mxl = ret.xl;\n    if (ret.yi < myi) myi = ret.yi;\n    if (ret.yl > myl) myl = ret.yl;\n  }\n\n  if (get) {\n    this.lpos = _lpos; //this.shrink = true;\n  }\n\n  if (this.position.width == null && (this.position.left == null || this.position.right == null)) {\n    if (this.position.left == null && this.position.right != null) {\n      xi = xl - (mxl - mxi);\n\n      if (!this.screen.autoPadding) {\n        xi -= this.padding.left + this.padding.right;\n      } else {\n        xi -= this.ileft;\n      }\n    } else {\n      xl = mxl;\n\n      if (!this.screen.autoPadding) {\n        xl += this.padding.left + this.padding.right; // XXX Temporary workaround until we decide to make autoPadding default.\n        // See widget-listtable.js for an example of why this is necessary.\n        // XXX Maybe just to this for all this being that this would affect\n        // width shrunken normal shrunken lists as well.\n        // if (this._isList) {\n\n        if (this.type === 'list-table') {\n          xl -= this.padding.left + this.padding.right;\n          xl += this.iright;\n        }\n      } else {\n        //xl += this.padding.right;\n        xl += this.iright;\n      }\n    }\n  }\n\n  if (this.position.height == null && (this.position.top == null || this.position.bottom == null) && (!this.scrollable || this._isList)) {\n    // NOTE: Lists get special treatment if they are shrunken - assume they\n    // want all list items showing. This is one case we can calculate the\n    // height based on items/boxes.\n    if (this._isList) {\n      myi = 0 - this.itop;\n      myl = this.items.length + this.ibottom;\n    }\n\n    if (this.position.top == null && this.position.bottom != null) {\n      yi = yl - (myl - myi);\n\n      if (!this.screen.autoPadding) {\n        yi -= this.padding.top + this.padding.bottom;\n      } else {\n        yi -= this.itop;\n      }\n    } else {\n      yl = myl;\n\n      if (!this.screen.autoPadding) {\n        yl += this.padding.top + this.padding.bottom;\n      } else {\n        yl += this.ibottom;\n      }\n    }\n  }\n\n  return {\n    xi: xi,\n    xl: xl,\n    yi: yi,\n    yl: yl\n  };\n};\n\nElement.prototype._getShrinkContent = function (xi, xl, yi, yl) {\n  var h = this._clines.length,\n      w = this._clines.mwidth || 1;\n\n  if (this.position.width == null && (this.position.left == null || this.position.right == null)) {\n    if (this.position.left == null && this.position.right != null) {\n      xi = xl - w - this.iwidth;\n    } else {\n      xl = xi + w + this.iwidth;\n    }\n  }\n\n  if (this.position.height == null && (this.position.top == null || this.position.bottom == null) && (!this.scrollable || this._isList)) {\n    if (this.position.top == null && this.position.bottom != null) {\n      yi = yl - h - this.iheight;\n    } else {\n      yl = yi + h + this.iheight;\n    }\n  }\n\n  return {\n    xi: xi,\n    xl: xl,\n    yi: yi,\n    yl: yl\n  };\n};\n\nElement.prototype._getShrink = function (xi, xl, yi, yl, get) {\n  var shrinkBox = this._getShrinkBox(xi, xl, yi, yl, get),\n      shrinkContent = this._getShrinkContent(xi, xl, yi, yl, get),\n      xll = xl,\n      yll = yl; // Figure out which one is bigger and use it.\n\n\n  if (shrinkBox.xl - shrinkBox.xi > shrinkContent.xl - shrinkContent.xi) {\n    xi = shrinkBox.xi;\n    xl = shrinkBox.xl;\n  } else {\n    xi = shrinkContent.xi;\n    xl = shrinkContent.xl;\n  }\n\n  if (shrinkBox.yl - shrinkBox.yi > shrinkContent.yl - shrinkContent.yi) {\n    yi = shrinkBox.yi;\n    yl = shrinkBox.yl;\n  } else {\n    yi = shrinkContent.yi;\n    yl = shrinkContent.yl;\n  } // Recenter shrunken elements.\n\n\n  if (xl < xll && this.position.left === 'center') {\n    xll = (xll - xl) / 2 | 0;\n    xi += xll;\n    xl += xll;\n  }\n\n  if (yl < yll && this.position.top === 'center') {\n    yll = (yll - yl) / 2 | 0;\n    yi += yll;\n    yl += yll;\n  }\n\n  return {\n    xi: xi,\n    xl: xl,\n    yi: yi,\n    yl: yl\n  };\n};\n\nElement.prototype._getCoords = function (get, noscroll) {\n  if (this.hidden) return; // if (this.parent._rendering) {\n  //   get = true;\n  // }\n\n  var xi = this._getLeft(get),\n      xl = xi + this._getWidth(get),\n      yi = this._getTop(get),\n      yl = yi + this._getHeight(get),\n      base = this.childBase || 0,\n      el = this,\n      fixed = this.fixed,\n      coords,\n      v,\n      noleft,\n      noright,\n      notop,\n      nobot,\n      ppos,\n      b; // Attempt to shrink the element base on the\n  // size of the content and child elements.\n\n\n  if (this.shrink) {\n    coords = this._getShrink(xi, xl, yi, yl, get);\n    xi = coords.xi, xl = coords.xl;\n    yi = coords.yi, yl = coords.yl;\n  } // Find a scrollable ancestor if we have one.\n\n\n  while (el = el.parent) {\n    if (el.scrollable) {\n      if (fixed) {\n        fixed = false;\n        continue;\n      }\n\n      break;\n    }\n  } // Check to make sure we're visible and\n  // inside of the visible scroll area.\n  // NOTE: Lists have a property where only\n  // the list items are obfuscated.\n  // Old way of doing things, this would not render right if a shrunken element\n  // with lots of boxes in it was within a scrollable element.\n  // See: $ node test/widget-shrink-fail.js\n  // var thisparent = this.parent;\n\n\n  var thisparent = el;\n\n  if (el && !noscroll) {\n    ppos = thisparent.lpos; // The shrink option can cause a stack overflow\n    // by calling _getCoords on the child again.\n    // if (!get && !thisparent.shrink) {\n    //   ppos = thisparent._getCoords();\n    // }\n\n    if (!ppos) return; // TODO: Figure out how to fix base (and cbase to only\n    // take into account the *parent's* padding.\n\n    yi -= ppos.base;\n    yl -= ppos.base;\n    b = thisparent.border ? 1 : 0; // XXX\n    // Fixes non-`fixed` labels to work with scrolling (they're ON the border):\n    // if (this.position.left < 0\n    //     || this.position.right < 0\n    //     || this.position.top < 0\n    //     || this.position.bottom < 0) {\n\n    if (this._isLabel) {\n      b = 0;\n    }\n\n    if (yi < ppos.yi + b) {\n      if (yl - 1 < ppos.yi + b) {\n        // Is above.\n        return;\n      } else {\n        // Is partially covered above.\n        notop = true;\n        v = ppos.yi - yi;\n        if (this.border) v--;\n        if (thisparent.border) v++;\n        base += v;\n        yi += v;\n      }\n    } else if (yl > ppos.yl - b) {\n      if (yi > ppos.yl - 1 - b) {\n        // Is below.\n        return;\n      } else {\n        // Is partially covered below.\n        nobot = true;\n        v = yl - ppos.yl;\n        if (this.border) v--;\n        if (thisparent.border) v++;\n        yl -= v;\n      }\n    } // Shouldn't be necessary.\n    // assert.ok(yi < yl);\n\n\n    if (yi >= yl) return; // Could allow overlapping stuff in scrolling elements\n    // if we cleared the pending buffer before every draw.\n\n    if (xi < el.lpos.xi) {\n      xi = el.lpos.xi;\n      noleft = true;\n      if (this.border) xi--;\n      if (thisparent.border) xi++;\n    }\n\n    if (xl > el.lpos.xl) {\n      xl = el.lpos.xl;\n      noright = true;\n      if (this.border) xl++;\n      if (thisparent.border) xl--;\n    } //if (xi > xl) return;\n\n\n    if (xi >= xl) return;\n  }\n\n  if (this.noOverflow && this.parent.lpos) {\n    if (xi < this.parent.lpos.xi + this.parent.ileft) {\n      xi = this.parent.lpos.xi + this.parent.ileft;\n    }\n\n    if (xl > this.parent.lpos.xl - this.parent.iright) {\n      xl = this.parent.lpos.xl - this.parent.iright;\n    }\n\n    if (yi < this.parent.lpos.yi + this.parent.itop) {\n      yi = this.parent.lpos.yi + this.parent.itop;\n    }\n\n    if (yl > this.parent.lpos.yl - this.parent.ibottom) {\n      yl = this.parent.lpos.yl - this.parent.ibottom;\n    }\n  } // if (this.parent.lpos) {\n  //   this.parent.lpos._scrollBottom = Math.max(\n  //     this.parent.lpos._scrollBottom, yl);\n  // }\n\n\n  return {\n    xi: xi,\n    xl: xl,\n    yi: yi,\n    yl: yl,\n    base: base,\n    noleft: noleft,\n    noright: noright,\n    notop: notop,\n    nobot: nobot,\n    renders: this.screen.renders\n  };\n};\n\nElement.prototype.render = function () {\n  this._emit('prerender');\n\n  this.parseContent();\n\n  var coords = this._getCoords(true);\n\n  if (!coords) {\n    delete this.lpos;\n    return;\n  }\n\n  if (coords.xl - coords.xi <= 0) {\n    coords.xl = Math.max(coords.xl, coords.xi);\n    return;\n  }\n\n  if (coords.yl - coords.yi <= 0) {\n    coords.yl = Math.max(coords.yl, coords.yi);\n    return;\n  }\n\n  var lines = this.screen.lines,\n      xi = coords.xi,\n      xl = coords.xl,\n      yi = coords.yi,\n      yl = coords.yl,\n      x,\n      y,\n      cell,\n      attr,\n      ch,\n      content = this._pcontent,\n      ci = this._clines.ci[coords.base],\n      battr,\n      dattr,\n      c,\n      visible,\n      i,\n      bch = this.ch; // Clip content if it's off the edge of the screen\n  // if (xi + this.ileft < 0 || yi + this.itop < 0) {\n  //   var clines = this._clines.slice();\n  //   if (xi + this.ileft < 0) {\n  //     for (var i = 0; i < clines.length; i++) {\n  //       var t = 0;\n  //       var csi = '';\n  //       var csis = '';\n  //       for (var j = 0; j < clines[i].length; j++) {\n  //         while (clines[i][j] === '\\x1b') {\n  //           csi = '\\x1b';\n  //           while (clines[i][j++] !== 'm') csi += clines[i][j];\n  //           csis += csi;\n  //         }\n  //         if (++t === -(xi + this.ileft) + 1) break;\n  //       }\n  //       clines[i] = csis + clines[i].substring(j);\n  //     }\n  //   }\n  //   if (yi + this.itop < 0) {\n  //     clines = clines.slice(-(yi + this.itop));\n  //   }\n  //   content = clines.join('\\n');\n  // }\n\n  if (coords.base >= this._clines.ci.length) {\n    ci = this._pcontent.length;\n  }\n\n  this.lpos = coords;\n\n  if (this.border && this.border.type === 'line') {\n    this.screen._borderStops[coords.yi] = true;\n    this.screen._borderStops[coords.yl - 1] = true; // if (!this.screen._borderStops[coords.yi]) {\n    //   this.screen._borderStops[coords.yi] = { xi: coords.xi, xl: coords.xl };\n    // } else {\n    //   if (this.screen._borderStops[coords.yi].xi > coords.xi) {\n    //     this.screen._borderStops[coords.yi].xi = coords.xi;\n    //   }\n    //   if (this.screen._borderStops[coords.yi].xl < coords.xl) {\n    //     this.screen._borderStops[coords.yi].xl = coords.xl;\n    //   }\n    // }\n    // this.screen._borderStops[coords.yl - 1] = this.screen._borderStops[coords.yi];\n  }\n\n  dattr = this.sattr(this.style);\n  attr = dattr; // If we're in a scrollable text box, check to\n  // see which attributes this line starts with.\n\n  if (ci > 0) {\n    attr = this._clines.attr[Math.min(coords.base, this._clines.length - 1)];\n  }\n\n  if (this.border) xi++, xl--, yi++, yl--; // If we have padding/valign, that means the\n  // content-drawing loop will skip a few cells/lines.\n  // To deal with this, we can just fill the whole thing\n  // ahead of time. This could be optimized.\n\n  if (this.tpadding || this.valign && this.valign !== 'top') {\n    if (this.style.transparent) {\n      for (y = Math.max(yi, 0); y < yl; y++) {\n        if (!lines[y]) break;\n\n        for (x = Math.max(xi, 0); x < xl; x++) {\n          if (!lines[y][x]) break;\n          lines[y][x][0] = colors.blend(attr, lines[y][x][0]); // lines[y][x][1] = bch;\n\n          lines[y].dirty = true;\n        }\n      }\n    } else {\n      this.screen.fillRegion(dattr, bch, xi, xl, yi, yl);\n    }\n  }\n\n  if (this.tpadding) {\n    xi += this.padding.left, xl -= this.padding.right;\n    yi += this.padding.top, yl -= this.padding.bottom;\n  } // Determine where to place the text if it's vertically aligned.\n\n\n  if (this.valign === 'middle' || this.valign === 'bottom') {\n    visible = yl - yi;\n\n    if (this._clines.length < visible) {\n      if (this.valign === 'middle') {\n        visible = visible / 2 | 0;\n        visible -= this._clines.length / 2 | 0;\n      } else if (this.valign === 'bottom') {\n        visible -= this._clines.length;\n      }\n\n      ci -= visible * (xl - xi);\n    }\n  } // Draw the content and background.\n\n\n  for (y = yi; y < yl; y++) {\n    if (!lines[y]) {\n      if (y >= this.screen.height || yl < this.ibottom) {\n        break;\n      } else {\n        continue;\n      }\n    }\n\n    for (x = xi; x < xl; x++) {\n      cell = lines[y][x];\n\n      if (!cell) {\n        if (x >= this.screen.width || xl < this.iright) {\n          break;\n        } else {\n          continue;\n        }\n      }\n\n      ch = content[ci++] || bch; // if (!content[ci] && !coords._contentEnd) {\n      //   coords._contentEnd = { x: x - xi, y: y - yi };\n      // }\n      // Handle escape codes.\n\n      while (ch === '\\x1b') {\n        if (c = /^\\x1b\\[[\\d;]*m/.exec(content.substring(ci - 1))) {\n          ci += c[0].length - 1;\n          attr = this.screen.attrCode(c[0], attr, dattr); // Ignore foreground changes for selected items.\n\n          if (this.parent._isList && this.parent.interactive && this.parent.items[this.parent.selected] === this && this.parent.options.invertSelected !== false) {\n            attr = attr & ~(0x1ff << 9) | dattr & 0x1ff << 9;\n          }\n\n          ch = content[ci] || bch;\n          ci++;\n        } else {\n          break;\n        }\n      } // Handle newlines.\n\n\n      if (ch === '\\t') ch = bch;\n\n      if (ch === '\\n') {\n        // If we're on the first cell and we find a newline and the last cell\n        // of the last line was not a newline, let's just treat this like the\n        // newline was already \"counted\".\n        if (x === xi && y !== yi && content[ci - 2] !== '\\n') {\n          x--;\n          continue;\n        } // We could use fillRegion here, name the\n        // outer loop, and continue to it instead.\n\n\n        ch = bch;\n\n        for (; x < xl; x++) {\n          cell = lines[y][x];\n          if (!cell) break;\n\n          if (this.style.transparent) {\n            lines[y][x][0] = colors.blend(attr, lines[y][x][0]);\n            if (content[ci]) lines[y][x][1] = ch;\n            lines[y].dirty = true;\n          } else {\n            if (attr !== cell[0] || ch !== cell[1]) {\n              lines[y][x][0] = attr;\n              lines[y][x][1] = ch;\n              lines[y].dirty = true;\n            }\n          }\n        }\n\n        continue;\n      }\n\n      if (this.screen.fullUnicode && content[ci - 1]) {\n        var point = unicode.codePointAt(content, ci - 1); // Handle combining chars:\n        // Make sure they get in the same cell and are counted as 0.\n\n        if (unicode.combining[point]) {\n          if (point > 0x00ffff) {\n            ch = content[ci - 1] + content[ci];\n            ci++;\n          }\n\n          if (x - 1 >= xi) {\n            lines[y][x - 1][1] += ch;\n          } else if (y - 1 >= yi) {\n            lines[y - 1][xl - 1][1] += ch;\n          }\n\n          x--;\n          continue;\n        } // Handle surrogate pairs:\n        // Make sure we put surrogate pair chars in one cell.\n\n\n        if (point > 0x00ffff) {\n          ch = content[ci - 1] + content[ci];\n          ci++;\n        }\n      }\n\n      if (this._noFill) continue;\n\n      if (this.style.transparent) {\n        lines[y][x][0] = colors.blend(attr, lines[y][x][0]);\n        if (content[ci]) lines[y][x][1] = ch;\n        lines[y].dirty = true;\n      } else {\n        if (attr !== cell[0] || ch !== cell[1]) {\n          lines[y][x][0] = attr;\n          lines[y][x][1] = ch;\n          lines[y].dirty = true;\n        }\n      }\n    }\n  } // Draw the scrollbar.\n  // Could possibly draw this after all child elements.\n\n\n  if (this.scrollbar) {\n    // XXX\n    // i = this.getScrollHeight();\n    i = Math.max(this._clines.length, this._scrollBottom());\n  }\n\n  if (coords.notop || coords.nobot) i = -Infinity;\n\n  if (this.scrollbar && yl - yi < i) {\n    x = xl - 1;\n    if (this.scrollbar.ignoreBorder && this.border) x++;\n\n    if (this.alwaysScroll) {\n      y = this.childBase / (i - (yl - yi));\n    } else {\n      y = (this.childBase + this.childOffset) / (i - 1);\n    }\n\n    y = yi + ((yl - yi) * y | 0);\n    if (y >= yl) y = yl - 1;\n    cell = lines[y] && lines[y][x];\n\n    if (cell) {\n      if (this.track) {\n        ch = this.track.ch || ' ';\n        attr = this.sattr(this.style.track, this.style.track.fg || this.style.fg, this.style.track.bg || this.style.bg);\n        this.screen.fillRegion(attr, ch, x, x + 1, yi, yl);\n      }\n\n      ch = this.scrollbar.ch || ' ';\n      attr = this.sattr(this.style.scrollbar, this.style.scrollbar.fg || this.style.fg, this.style.scrollbar.bg || this.style.bg);\n\n      if (attr !== cell[0] || ch !== cell[1]) {\n        lines[y][x][0] = attr;\n        lines[y][x][1] = ch;\n        lines[y].dirty = true;\n      }\n    }\n  }\n\n  if (this.border) xi--, xl++, yi--, yl++;\n\n  if (this.tpadding) {\n    xi -= this.padding.left, xl += this.padding.right;\n    yi -= this.padding.top, yl += this.padding.bottom;\n  } // Draw the border.\n\n\n  if (this.border) {\n    battr = this.sattr(this.style.border);\n    y = yi;\n    if (coords.notop) y = -1;\n\n    for (x = xi; x < xl; x++) {\n      if (!lines[y]) break;\n      if (coords.noleft && x === xi) continue;\n      if (coords.noright && x === xl - 1) continue;\n      cell = lines[y][x];\n      if (!cell) continue;\n\n      if (this.border.type === 'line') {\n        if (x === xi) {\n          ch = '\\u250c'; // '┌'\n\n          if (!this.border.left) {\n            if (this.border.top) {\n              ch = '\\u2500'; // '─'\n            } else {\n              continue;\n            }\n          } else {\n            if (!this.border.top) {\n              ch = '\\u2502'; // '│'\n            }\n          }\n        } else if (x === xl - 1) {\n          ch = '\\u2510'; // '┐'\n\n          if (!this.border.right) {\n            if (this.border.top) {\n              ch = '\\u2500'; // '─'\n            } else {\n              continue;\n            }\n          } else {\n            if (!this.border.top) {\n              ch = '\\u2502'; // '│'\n            }\n          }\n        } else {\n          ch = '\\u2500'; // '─'\n        }\n      } else if (this.border.type === 'bg') {\n        ch = this.border.ch;\n      }\n\n      if (!this.border.top && x !== xi && x !== xl - 1) {\n        ch = ' ';\n\n        if (dattr !== cell[0] || ch !== cell[1]) {\n          lines[y][x][0] = dattr;\n          lines[y][x][1] = ch;\n          lines[y].dirty = true;\n          continue;\n        }\n      }\n\n      if (battr !== cell[0] || ch !== cell[1]) {\n        lines[y][x][0] = battr;\n        lines[y][x][1] = ch;\n        lines[y].dirty = true;\n      }\n    }\n\n    y = yi + 1;\n\n    for (; y < yl - 1; y++) {\n      if (!lines[y]) continue;\n      cell = lines[y][xi];\n\n      if (cell) {\n        if (this.border.left) {\n          if (this.border.type === 'line') {\n            ch = '\\u2502'; // '│'\n          } else if (this.border.type === 'bg') {\n            ch = this.border.ch;\n          }\n\n          if (!coords.noleft) if (battr !== cell[0] || ch !== cell[1]) {\n            lines[y][xi][0] = battr;\n            lines[y][xi][1] = ch;\n            lines[y].dirty = true;\n          }\n        } else {\n          ch = ' ';\n\n          if (dattr !== cell[0] || ch !== cell[1]) {\n            lines[y][xi][0] = dattr;\n            lines[y][xi][1] = ch;\n            lines[y].dirty = true;\n          }\n        }\n      }\n\n      cell = lines[y][xl - 1];\n\n      if (cell) {\n        if (this.border.right) {\n          if (this.border.type === 'line') {\n            ch = '\\u2502'; // '│'\n          } else if (this.border.type === 'bg') {\n            ch = this.border.ch;\n          }\n\n          if (!coords.noright) if (battr !== cell[0] || ch !== cell[1]) {\n            lines[y][xl - 1][0] = battr;\n            lines[y][xl - 1][1] = ch;\n            lines[y].dirty = true;\n          }\n        } else {\n          ch = ' ';\n\n          if (dattr !== cell[0] || ch !== cell[1]) {\n            lines[y][xl - 1][0] = dattr;\n            lines[y][xl - 1][1] = ch;\n            lines[y].dirty = true;\n          }\n        }\n      }\n    }\n\n    y = yl - 1;\n    if (coords.nobot) y = -1;\n\n    for (x = xi; x < xl; x++) {\n      if (!lines[y]) break;\n      if (coords.noleft && x === xi) continue;\n      if (coords.noright && x === xl - 1) continue;\n      cell = lines[y][x];\n      if (!cell) continue;\n\n      if (this.border.type === 'line') {\n        if (x === xi) {\n          ch = '\\u2514'; // '└'\n\n          if (!this.border.left) {\n            if (this.border.bottom) {\n              ch = '\\u2500'; // '─'\n            } else {\n              continue;\n            }\n          } else {\n            if (!this.border.bottom) {\n              ch = '\\u2502'; // '│'\n            }\n          }\n        } else if (x === xl - 1) {\n          ch = '\\u2518'; // '┘'\n\n          if (!this.border.right) {\n            if (this.border.bottom) {\n              ch = '\\u2500'; // '─'\n            } else {\n              continue;\n            }\n          } else {\n            if (!this.border.bottom) {\n              ch = '\\u2502'; // '│'\n            }\n          }\n        } else {\n          ch = '\\u2500'; // '─'\n        }\n      } else if (this.border.type === 'bg') {\n        ch = this.border.ch;\n      }\n\n      if (!this.border.bottom && x !== xi && x !== xl - 1) {\n        ch = ' ';\n\n        if (dattr !== cell[0] || ch !== cell[1]) {\n          lines[y][x][0] = dattr;\n          lines[y][x][1] = ch;\n          lines[y].dirty = true;\n        }\n\n        continue;\n      }\n\n      if (battr !== cell[0] || ch !== cell[1]) {\n        lines[y][x][0] = battr;\n        lines[y][x][1] = ch;\n        lines[y].dirty = true;\n      }\n    }\n  }\n\n  if (this.shadow) {\n    // right\n    y = Math.max(yi + 1, 0);\n\n    for (; y < yl + 1; y++) {\n      if (!lines[y]) break;\n      x = xl;\n\n      for (; x < xl + 2; x++) {\n        if (!lines[y][x]) break; // lines[y][x][0] = colors.blend(this.dattr, lines[y][x][0]);\n\n        lines[y][x][0] = colors.blend(lines[y][x][0]);\n        lines[y].dirty = true;\n      }\n    } // bottom\n\n\n    y = yl;\n\n    for (; y < yl + 1; y++) {\n      if (!lines[y]) break;\n\n      for (x = Math.max(xi + 1, 0); x < xl; x++) {\n        if (!lines[y][x]) break; // lines[y][x][0] = colors.blend(this.dattr, lines[y][x][0]);\n\n        lines[y][x][0] = colors.blend(lines[y][x][0]);\n        lines[y].dirty = true;\n      }\n    }\n  }\n\n  this.children.forEach(function (el) {\n    if (el.screen._ci !== -1) {\n      el.index = el.screen._ci++;\n    } // if (el.screen._rendering) {\n    //   el._rendering = true;\n    // }\n\n\n    el.render(); // if (el.screen._rendering) {\n    //   el._rendering = false;\n    // }\n  });\n\n  this._emit('render', [coords]);\n\n  return coords;\n};\n\nElement.prototype._render = Element.prototype.render;\n/**\n * Content Methods\n */\n\nElement.prototype.insertLine = function (i, line) {\n  if (typeof line === 'string') line = line.split('\\n');\n\n  if (i !== i || i == null) {\n    i = this._clines.ftor.length;\n  }\n\n  i = Math.max(i, 0);\n\n  while (this._clines.fake.length < i) {\n    this._clines.fake.push('');\n\n    this._clines.ftor.push([this._clines.push('') - 1]);\n\n    this._clines.rtof(this._clines.fake.length - 1);\n  } // NOTE: Could possibly compare the first and last ftor line numbers to see\n  // if they're the same, or if they fit in the visible region entirely.\n\n\n  var start = this._clines.length,\n      diff,\n      real;\n\n  if (i >= this._clines.ftor.length) {\n    real = this._clines.ftor[this._clines.ftor.length - 1];\n    real = real[real.length - 1] + 1;\n  } else {\n    real = this._clines.ftor[i][0];\n  }\n\n  for (var j = 0; j < line.length; j++) {\n    this._clines.fake.splice(i + j, 0, line[j]);\n  }\n\n  this.setContent(this._clines.fake.join('\\n'), true);\n  diff = this._clines.length - start;\n\n  if (diff > 0) {\n    var pos = this._getCoords();\n\n    if (!pos) return;\n    var height = pos.yl - pos.yi - this.iheight,\n        base = this.childBase || 0,\n        visible = real >= base && real - base < height;\n\n    if (pos && visible && this.screen.cleanSides(this)) {\n      this.screen.insertLine(diff, pos.yi + this.itop + real - base, pos.yi, pos.yl - this.ibottom - 1);\n    }\n  }\n};\n\nElement.prototype.deleteLine = function (i, n) {\n  n = n || 1;\n\n  if (i !== i || i == null) {\n    i = this._clines.ftor.length - 1;\n  }\n\n  i = Math.max(i, 0);\n  i = Math.min(i, this._clines.ftor.length - 1); // NOTE: Could possibly compare the first and last ftor line numbers to see\n  // if they're the same, or if they fit in the visible region entirely.\n\n  var start = this._clines.length,\n      diff,\n      real = this._clines.ftor[i][0];\n\n  while (n--) {\n    this._clines.fake.splice(i, 1);\n  }\n\n  this.setContent(this._clines.fake.join('\\n'), true);\n  diff = start - this._clines.length; // XXX clearPos() without diff statement?\n\n  var height = 0;\n\n  if (diff > 0) {\n    var pos = this._getCoords();\n\n    if (!pos) return;\n    height = pos.yl - pos.yi - this.iheight;\n    var base = this.childBase || 0,\n        visible = real >= base && real - base < height;\n\n    if (pos && visible && this.screen.cleanSides(this)) {\n      this.screen.deleteLine(diff, pos.yi + this.itop + real - base, pos.yi, pos.yl - this.ibottom - 1);\n    }\n  }\n\n  if (this._clines.length < height) {\n    this.clearPos();\n  }\n};\n\nElement.prototype.insertTop = function (line) {\n  var fake = this._clines.rtof[this.childBase || 0];\n  return this.insertLine(fake, line);\n};\n\nElement.prototype.insertBottom = function (line) {\n  var h = (this.childBase || 0) + this.height - this.iheight,\n      i = Math.min(h, this._clines.length),\n      fake = this._clines.rtof[i - 1] + 1;\n  return this.insertLine(fake, line);\n};\n\nElement.prototype.deleteTop = function (n) {\n  var fake = this._clines.rtof[this.childBase || 0];\n  return this.deleteLine(fake, n);\n};\n\nElement.prototype.deleteBottom = function (n) {\n  var h = (this.childBase || 0) + this.height - 1 - this.iheight,\n      i = Math.min(h, this._clines.length - 1),\n      fake = this._clines.rtof[i];\n  n = n || 1;\n  return this.deleteLine(fake - (n - 1), n);\n};\n\nElement.prototype.setLine = function (i, line) {\n  i = Math.max(i, 0);\n\n  while (this._clines.fake.length < i) {\n    this._clines.fake.push('');\n  }\n\n  this._clines.fake[i] = line;\n  return this.setContent(this._clines.fake.join('\\n'), true);\n};\n\nElement.prototype.setBaseLine = function (i, line) {\n  var fake = this._clines.rtof[this.childBase || 0];\n  return this.setLine(fake + i, line);\n};\n\nElement.prototype.getLine = function (i) {\n  i = Math.max(i, 0);\n  i = Math.min(i, this._clines.fake.length - 1);\n  return this._clines.fake[i];\n};\n\nElement.prototype.getBaseLine = function (i) {\n  var fake = this._clines.rtof[this.childBase || 0];\n  return this.getLine(fake + i);\n};\n\nElement.prototype.clearLine = function (i) {\n  i = Math.min(i, this._clines.fake.length - 1);\n  return this.setLine(i, '');\n};\n\nElement.prototype.clearBaseLine = function (i) {\n  var fake = this._clines.rtof[this.childBase || 0];\n  return this.clearLine(fake + i);\n};\n\nElement.prototype.unshiftLine = function (line) {\n  return this.insertLine(0, line);\n};\n\nElement.prototype.shiftLine = function (n) {\n  return this.deleteLine(0, n);\n};\n\nElement.prototype.pushLine = function (line) {\n  if (!this.content) return this.setLine(0, line);\n  return this.insertLine(this._clines.fake.length, line);\n};\n\nElement.prototype.popLine = function (n) {\n  return this.deleteLine(this._clines.fake.length - 1, n);\n};\n\nElement.prototype.getLines = function () {\n  return this._clines.fake.slice();\n};\n\nElement.prototype.getScreenLines = function () {\n  return this._clines.slice();\n};\n\nElement.prototype.strWidth = function (text) {\n  text = this.parseTags ? helpers.stripTags(text) : text;\n  return this.screen.fullUnicode ? unicode.strWidth(text) : helpers.dropUnicode(text).length;\n};\n\nElement.prototype.screenshot = function (xi, xl, yi, yl) {\n  xi = this.lpos.xi + this.ileft + (xi || 0);\n\n  if (xl != null) {\n    xl = this.lpos.xi + this.ileft + (xl || 0);\n  } else {\n    xl = this.lpos.xl - this.iright;\n  }\n\n  yi = this.lpos.yi + this.itop + (yi || 0);\n\n  if (yl != null) {\n    yl = this.lpos.yi + this.itop + (yl || 0);\n  } else {\n    yl = this.lpos.yl - this.ibottom;\n  }\n\n  return this.screen.screenshot(xi, xl, yi, yl);\n};\n/**\n * Expose\n */\n\n\nmodule.exports = Element;","map":{"version":3,"sources":["/Users/samianki/node_modules/blessed/lib/widgets/element.js"],"names":["assert","require","colors","unicode","nextTick","global","setImmediate","process","bind","helpers","Node","Element","options","self","scrollable","_ignore","type","ScrollableBox","Object","getOwnPropertyNames","prototype","forEach","key","defineProperty","getOwnPropertyDescriptor","call","name","position","left","right","top","bottom","width","height","shrink","noOverflow","dockBorders","shadow","style","fg","bg","bold","underline","blink","inverse","invisible","transparent","hidden","fixed","align","valign","wrap","ch","padding","border","clickable","screen","_listenMouse","input","keyable","_listenKeys","parseTags","tags","setContent","content","label","setLabel","hoverText","setHover","on","fn","indexOf","parseContent","lpos","hoverBg","hoverEffects","hover","focus","focusEffects","effects","props","pname","over","out","temp","setEffects","draggable","focused","__proto__","__defineGetter__","sattr","convert","onScreenEvent","handler","listeners","_slisteners","push","onceScreenEvent","entry","once","i","splice","apply","arguments","removeScreenEvent","length","listener","removeListener","free","hide","clearPos","emit","rewindFocus","show","toggle","noClear","noTags","getContent","_clines","fake","join","setText","replace","getText","detached","iwidth","tabc","fullUnicode","chars","all","program","isiTerm2","combining","surrogate","_parseTags","_wrapContent","attr","_parseAttr","ci","reduce","total","line","_pcontent","text","test","state","flag","cap","slash","param","esc","exec","substring","slice","_attr","pop","lines","dattr","attrs","j","c","attrCode","_align","cline","len","s","Array","parts","split","cparts","Math","max","margin","rtof","ftor","no","part","rest","real","mwidth","scrollbar","main","match","isSurrogate","n","isCombining","current","el","parent","enableMouse","enableKeys","enableInput","_draggable","__defineSetter__","enableDrag","disableDrag","verify","_dragMD","data","_dragging","_drag","x","aleft","y","atop","setFront","_dragM","action","ox","oy","px","py","rleft","rtop","render","onceKey","unkey","removeKey","setIndex","index","children","min","item","setBack","get","override","_getCoords","clearRegion","xi","xl","yi","yl","Box","_label","side","undefined","autoPadding","rright","itop","ileft","iright","_isLabel","reposition","childBase","_labelScroll","_labelResize","removeLabel","detach","_hoverOptions","_initHover","removeHover","_hoverText","_getPos","pos","ok","aright","cols","abottom","rows","_getWidth","expr","_getHeight","ibottom","_getLeft","_getRight","_getTop","_getBottom","val","rbottom","_getShrinkBox","ret","mxi","mxl","myi","myl","_lpos","_isList","items","_getShrinkContent","h","w","iheight","_getShrink","shrinkBox","shrinkContent","xll","yll","noscroll","base","coords","v","noleft","noright","notop","nobot","ppos","b","thisparent","renders","_emit","cell","battr","visible","bch","_borderStops","tpadding","blend","dirty","fillRegion","interactive","selected","invertSelected","point","codePointAt","_noFill","_scrollBottom","Infinity","ignoreBorder","alwaysScroll","childOffset","track","_ci","_render","insertLine","start","diff","cleanSides","deleteLine","insertTop","insertBottom","deleteTop","deleteBottom","setLine","setBaseLine","getLine","getBaseLine","clearLine","clearBaseLine","unshiftLine","shiftLine","pushLine","popLine","getLines","getScreenLines","strWidth","stripTags","dropUnicode","screenshot","module","exports"],"mappings":"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","sourcesContent":["/**\n * element.js - base element for blessed\n * Copyright (c) 2013-2015, Christopher Jeffrey and contributors (MIT License).\n * https://github.com/chjj/blessed\n */\n\n/**\n * Modules\n */\n\nvar assert = require('assert');\n\nvar colors = require('../colors')\n  , unicode = require('../unicode');\n\nvar nextTick = global.setImmediate || process.nextTick.bind(process);\n\nvar helpers = require('../helpers');\n\nvar Node = require('./node');\n\n/**\n * Element\n */\n\nfunction Element(options) {\n  var self = this;\n\n  if (!(this instanceof Node)) {\n    return new Element(options);\n  }\n\n  options = options || {};\n\n  // Workaround to get a `scrollable` option.\n  if (options.scrollable && !this._ignore && this.type !== 'scrollable-box') {\n    var ScrollableBox = require('./scrollablebox');\n    Object.getOwnPropertyNames(ScrollableBox.prototype).forEach(function(key) {\n      if (key === 'type') return;\n      Object.defineProperty(this, key,\n        Object.getOwnPropertyDescriptor(ScrollableBox.prototype, key));\n    }, this);\n    this._ignore = true;\n    ScrollableBox.call(this, options);\n    delete this._ignore;\n    return this;\n  }\n\n  Node.call(this, options);\n\n  this.name = options.name;\n\n  options.position = options.position || {\n    left: options.left,\n    right: options.right,\n    top: options.top,\n    bottom: options.bottom,\n    width: options.width,\n    height: options.height\n  };\n\n  if (options.position.width === 'shrink'\n      || options.position.height === 'shrink') {\n    if (options.position.width === 'shrink') {\n      delete options.position.width;\n    }\n    if (options.position.height === 'shrink') {\n      delete options.position.height;\n    }\n    options.shrink = true;\n  }\n\n  this.position = options.position;\n\n  this.noOverflow = options.noOverflow;\n  this.dockBorders = options.dockBorders;\n  this.shadow = options.shadow;\n\n  this.style = options.style;\n\n  if (!this.style) {\n    this.style = {};\n    this.style.fg = options.fg;\n    this.style.bg = options.bg;\n    this.style.bold = options.bold;\n    this.style.underline = options.underline;\n    this.style.blink = options.blink;\n    this.style.inverse = options.inverse;\n    this.style.invisible = options.invisible;\n    this.style.transparent = options.transparent;\n  }\n\n  this.hidden = options.hidden || false;\n  this.fixed = options.fixed || false;\n  this.align = options.align || 'left';\n  this.valign = options.valign || 'top';\n  this.wrap = options.wrap !== false;\n  this.shrink = options.shrink;\n  this.fixed = options.fixed;\n  this.ch = options.ch || ' ';\n\n  if (typeof options.padding === 'number' || !options.padding) {\n    options.padding = {\n      left: options.padding,\n      top: options.padding,\n      right: options.padding,\n      bottom: options.padding\n    };\n  }\n\n  this.padding = {\n    left: options.padding.left || 0,\n    top: options.padding.top || 0,\n    right: options.padding.right || 0,\n    bottom: options.padding.bottom || 0\n  };\n\n  this.border = options.border;\n  if (this.border) {\n    if (typeof this.border === 'string') {\n      this.border = { type: this.border };\n    }\n    this.border.type = this.border.type || 'bg';\n    if (this.border.type === 'ascii') this.border.type = 'line';\n    this.border.ch = this.border.ch || ' ';\n    this.style.border = this.style.border || this.border.style;\n    if (!this.style.border) {\n      this.style.border = {};\n      this.style.border.fg = this.border.fg;\n      this.style.border.bg = this.border.bg;\n    }\n    //this.border.style = this.style.border;\n    if (this.border.left == null) this.border.left = true;\n    if (this.border.top == null) this.border.top = true;\n    if (this.border.right == null) this.border.right = true;\n    if (this.border.bottom == null) this.border.bottom = true;\n  }\n\n  // if (options.mouse || options.clickable) {\n  if (options.clickable) {\n    this.screen._listenMouse(this);\n  }\n\n  if (options.input || options.keyable) {\n    this.screen._listenKeys(this);\n  }\n\n  this.parseTags = options.parseTags || options.tags;\n\n  this.setContent(options.content || '', true);\n\n  if (options.label) {\n    this.setLabel(options.label);\n  }\n\n  if (options.hoverText) {\n    this.setHover(options.hoverText);\n  }\n\n  // TODO: Possibly move this to Node for onScreenEvent('mouse', ...).\n  this.on('newListener', function fn(type) {\n    // type = type.split(' ').slice(1).join(' ');\n    if (type === 'mouse'\n      || type === 'click'\n      || type === 'mouseover'\n      || type === 'mouseout'\n      || type === 'mousedown'\n      || type === 'mouseup'\n      || type === 'mousewheel'\n      || type === 'wheeldown'\n      || type === 'wheelup'\n      || type === 'mousemove') {\n      self.screen._listenMouse(self);\n    } else if (type === 'keypress' || type.indexOf('key ') === 0) {\n      self.screen._listenKeys(self);\n    }\n  });\n\n  this.on('resize', function() {\n    self.parseContent();\n  });\n\n  this.on('attach', function() {\n    self.parseContent();\n  });\n\n  this.on('detach', function() {\n    delete self.lpos;\n  });\n\n  if (options.hoverBg != null) {\n    options.hoverEffects = options.hoverEffects || {};\n    options.hoverEffects.bg = options.hoverBg;\n  }\n\n  if (this.style.hover) {\n    options.hoverEffects = this.style.hover;\n  }\n\n  if (this.style.focus) {\n    options.focusEffects = this.style.focus;\n  }\n\n  if (options.effects) {\n    if (options.effects.hover) options.hoverEffects = options.effects.hover;\n    if (options.effects.focus) options.focusEffects = options.effects.focus;\n  }\n\n  [['hoverEffects', 'mouseover', 'mouseout', '_htemp'],\n   ['focusEffects', 'focus', 'blur', '_ftemp']].forEach(function(props) {\n    var pname = props[0], over = props[1], out = props[2], temp = props[3];\n    self.screen.setEffects(self, self, over, out, self.options[pname], temp);\n  });\n\n  if (this.options.draggable) {\n    this.draggable = true;\n  }\n\n  if (options.focused) {\n    this.focus();\n  }\n}\n\nElement.prototype.__proto__ = Node.prototype;\n\nElement.prototype.type = 'element';\n\nElement.prototype.__defineGetter__('focused', function() {\n  return this.screen.focused === this;\n});\n\nElement.prototype.sattr = function(style, fg, bg) {\n  var bold = style.bold\n    , underline = style.underline\n    , blink = style.blink\n    , inverse = style.inverse\n    , invisible = style.invisible;\n\n  // if (arguments.length === 1) {\n  if (fg == null && bg == null) {\n    fg = style.fg;\n    bg = style.bg;\n  }\n\n  // This used to be a loop, but I decided\n  // to unroll it for performance's sake.\n  if (typeof bold === 'function') bold = bold(this);\n  if (typeof underline === 'function') underline = underline(this);\n  if (typeof blink === 'function') blink = blink(this);\n  if (typeof inverse === 'function') inverse = inverse(this);\n  if (typeof invisible === 'function') invisible = invisible(this);\n\n  if (typeof fg === 'function') fg = fg(this);\n  if (typeof bg === 'function') bg = bg(this);\n\n  // return (this.uid << 24)\n  //   | ((this.dockBorders ? 32 : 0) << 18)\n  return ((invisible ? 16 : 0) << 18)\n    | ((inverse ? 8 : 0) << 18)\n    | ((blink ? 4 : 0) << 18)\n    | ((underline ? 2 : 0) << 18)\n    | ((bold ? 1 : 0) << 18)\n    | (colors.convert(fg) << 9)\n    | colors.convert(bg);\n};\n\nElement.prototype.onScreenEvent = function(type, handler) {\n  var listeners = this._slisteners = this._slisteners || [];\n  listeners.push({ type: type, handler: handler });\n  this.screen.on(type, handler);\n};\n\nElement.prototype.onceScreenEvent = function(type, handler) {\n  var listeners = this._slisteners = this._slisteners || [];\n  var entry = { type: type, handler: handler };\n  listeners.push(entry);\n  this.screen.once(type, function() {\n    var i = listeners.indexOf(entry);\n    if (~i) listeners.splice(i, 1);\n    return handler.apply(this, arguments);\n  });\n};\n\nElement.prototype.removeScreenEvent = function(type, handler) {\n  var listeners = this._slisteners = this._slisteners || [];\n  for (var i = 0; i < listeners.length; i++) {\n    var listener = listeners[i];\n    if (listener.type === type && listener.handler === handler) {\n      listeners.splice(i, 1);\n      if (this._slisteners.length === 0) {\n        delete this._slisteners;\n      }\n      break;\n    }\n  }\n  this.screen.removeListener(type, handler);\n};\n\nElement.prototype.free = function() {\n  var listeners = this._slisteners = this._slisteners || [];\n  for (var i = 0; i < listeners.length; i++) {\n    var listener = listeners[i];\n    this.screen.removeListener(listener.type, listener.handler);\n  }\n  delete this._slisteners;\n};\n\nElement.prototype.hide = function() {\n  if (this.hidden) return;\n  this.clearPos();\n  this.hidden = true;\n  this.emit('hide');\n  if (this.screen.focused === this) {\n    this.screen.rewindFocus();\n  }\n};\n\nElement.prototype.show = function() {\n  if (!this.hidden) return;\n  this.hidden = false;\n  this.emit('show');\n};\n\nElement.prototype.toggle = function() {\n  return this.hidden ? this.show() : this.hide();\n};\n\nElement.prototype.focus = function() {\n  return this.screen.focused = this;\n};\n\nElement.prototype.setContent = function(content, noClear, noTags) {\n  if (!noClear) this.clearPos();\n  this.content = content || '';\n  this.parseContent(noTags);\n  this.emit('set content');\n};\n\nElement.prototype.getContent = function() {\n  if (!this._clines) return '';\n  return this._clines.fake.join('\\n');\n};\n\nElement.prototype.setText = function(content, noClear) {\n  content = content || '';\n  content = content.replace(/\\x1b\\[[\\d;]*m/g, '');\n  return this.setContent(content, noClear, true);\n};\n\nElement.prototype.getText = function() {\n  return this.getContent().replace(/\\x1b\\[[\\d;]*m/g, '');\n};\n\nElement.prototype.parseContent = function(noTags) {\n  if (this.detached) return false;\n\n  var width = this.width - this.iwidth;\n  if (this._clines == null\n      || this._clines.width !== width\n      || this._clines.content !== this.content) {\n    var content = this.content;\n\n    content = content\n      .replace(/[\\x00-\\x08\\x0b-\\x0c\\x0e-\\x1a\\x1c-\\x1f\\x7f]/g, '')\n      .replace(/\\x1b(?!\\[[\\d;]*m)/g, '')\n      .replace(/\\r\\n|\\r/g, '\\n')\n      .replace(/\\t/g, this.screen.tabc);\n\n    if (this.screen.fullUnicode) {\n      // double-width chars will eat the next char after render. create a\n      // blank character after it so it doesn't eat the real next char.\n      content = content.replace(unicode.chars.all, '$1\\x03');\n      // iTerm2 cannot render combining characters properly.\n      if (this.screen.program.isiTerm2) {\n        content = content.replace(unicode.chars.combining, '');\n      }\n    } else {\n      // no double-width: replace them with question-marks.\n      content = content.replace(unicode.chars.all, '??');\n      // delete combining characters since they're 0-width anyway.\n      // NOTE: We could drop this, the non-surrogates would get changed to ? by\n      // the unicode filter, and surrogates changed to ? by the surrogate\n      // regex. however, the user might expect them to be 0-width.\n      // NOTE: Might be better for performance to drop!\n      content = content.replace(unicode.chars.combining, '');\n      // no surrogate pairs: replace them with question-marks.\n      content = content.replace(unicode.chars.surrogate, '?');\n      // XXX Deduplicate code here:\n      // content = helpers.dropUnicode(content);\n    }\n\n    if (!noTags) {\n      content = this._parseTags(content);\n    }\n\n    this._clines = this._wrapContent(content, width);\n    this._clines.width = width;\n    this._clines.content = this.content;\n    this._clines.attr = this._parseAttr(this._clines);\n    this._clines.ci = [];\n    this._clines.reduce(function(total, line) {\n      this._clines.ci.push(total);\n      return total + line.length + 1;\n    }.bind(this), 0);\n\n    this._pcontent = this._clines.join('\\n');\n    this.emit('parsed content');\n\n    return true;\n  }\n\n  // Need to calculate this every time because the default fg/bg may change.\n  this._clines.attr = this._parseAttr(this._clines) || this._clines.attr;\n\n  return false;\n};\n\n// Convert `{red-fg}foo{/red-fg}` to `\\x1b[31mfoo\\x1b[39m`.\nElement.prototype._parseTags = function(text) {\n  if (!this.parseTags) return text;\n  if (!/{\\/?[\\w\\-,;!#]*}/.test(text)) return text;\n\n  var program = this.screen.program\n    , out = ''\n    , state\n    , bg = []\n    , fg = []\n    , flag = []\n    , cap\n    , slash\n    , param\n    , attr\n    , esc;\n\n  for (;;) {\n    if (!esc && (cap = /^{escape}/.exec(text))) {\n      text = text.substring(cap[0].length);\n      esc = true;\n      continue;\n    }\n\n    if (esc && (cap = /^([\\s\\S]+?){\\/escape}/.exec(text))) {\n      text = text.substring(cap[0].length);\n      out += cap[1];\n      esc = false;\n      continue;\n    }\n\n    if (esc) {\n      // throw new Error('Unterminated escape tag.');\n      out += text;\n      break;\n    }\n\n    if (cap = /^{(\\/?)([\\w\\-,;!#]*)}/.exec(text)) {\n      text = text.substring(cap[0].length);\n      slash = cap[1] === '/';\n      param = cap[2].replace(/-/g, ' ');\n\n      if (param === 'open') {\n        out += '{';\n        continue;\n      } else if (param === 'close') {\n        out += '}';\n        continue;\n      }\n\n      if (param.slice(-3) === ' bg') state = bg;\n      else if (param.slice(-3) === ' fg') state = fg;\n      else state = flag;\n\n      if (slash) {\n        if (!param) {\n          out += program._attr('normal');\n          bg.length = 0;\n          fg.length = 0;\n          flag.length = 0;\n        } else {\n          attr = program._attr(param, false);\n          if (attr == null) {\n            out += cap[0];\n          } else {\n            // if (param !== state[state.length - 1]) {\n            //   throw new Error('Misnested tags.');\n            // }\n            state.pop();\n            if (state.length) {\n              out += program._attr(state[state.length - 1]);\n            } else {\n              out += attr;\n            }\n          }\n        }\n      } else {\n        if (!param) {\n          out += cap[0];\n        } else {\n          attr = program._attr(param);\n          if (attr == null) {\n            out += cap[0];\n          } else {\n            state.push(param);\n            out += attr;\n          }\n        }\n      }\n\n      continue;\n    }\n\n    if (cap = /^[\\s\\S]+?(?={\\/?[\\w\\-,;!#]*})/.exec(text)) {\n      text = text.substring(cap[0].length);\n      out += cap[0];\n      continue;\n    }\n\n    out += text;\n    break;\n  }\n\n  return out;\n};\n\nElement.prototype._parseAttr = function(lines) {\n  var dattr = this.sattr(this.style)\n    , attr = dattr\n    , attrs = []\n    , line\n    , i\n    , j\n    , c;\n\n  if (lines[0].attr === attr) {\n    return;\n  }\n\n  for (j = 0; j < lines.length; j++) {\n    line = lines[j];\n    attrs[j] = attr;\n    for (i = 0; i < line.length; i++) {\n      if (line[i] === '\\x1b') {\n        if (c = /^\\x1b\\[[\\d;]*m/.exec(line.substring(i))) {\n          attr = this.screen.attrCode(c[0], attr, dattr);\n          i += c[0].length - 1;\n        }\n      }\n    }\n  }\n\n  return attrs;\n};\n\nElement.prototype._align = function(line, width, align) {\n  if (!align) return line;\n  //if (!align && !~line.indexOf('{|}')) return line;\n\n  var cline = line.replace(/\\x1b\\[[\\d;]*m/g, '')\n    , len = cline.length\n    , s = width - len;\n\n  if (this.shrink) {\n    s = 0;\n  }\n\n  if (len === 0) return line;\n  if (s < 0) return line;\n\n  if (align === 'center') {\n    s = Array(((s / 2) | 0) + 1).join(' ');\n    return s + line + s;\n  } else if (align === 'right') {\n    s = Array(s + 1).join(' ');\n    return s + line;\n  } else if (this.parseTags && ~line.indexOf('{|}')) {\n    var parts = line.split('{|}');\n    var cparts = cline.split('{|}');\n    s = Math.max(width - cparts[0].length - cparts[1].length, 0);\n    s = Array(s + 1).join(' ');\n    return parts[0] + s + parts[1];\n  }\n\n  return line;\n};\n\nElement.prototype._wrapContent = function(content, width) {\n  var tags = this.parseTags\n    , state = this.align\n    , wrap = this.wrap\n    , margin = 0\n    , rtof = []\n    , ftor = []\n    , out = []\n    , no = 0\n    , line\n    , align\n    , cap\n    , total\n    , i\n    , part\n    , j\n    , lines\n    , rest;\n\n  lines = content.split('\\n');\n\n  if (!content) {\n    out.push(content);\n    out.rtof = [0];\n    out.ftor = [[0]];\n    out.fake = lines;\n    out.real = out;\n    out.mwidth = 0;\n    return out;\n  }\n\n  if (this.scrollbar) margin++;\n  if (this.type === 'textarea') margin++;\n  if (width > margin) width -= margin;\n\nmain:\n  for (; no < lines.length; no++) {\n    line = lines[no];\n    align = state;\n\n    ftor.push([]);\n\n    // Handle alignment tags.\n    if (tags) {\n      if (cap = /^{(left|center|right)}/.exec(line)) {\n        line = line.substring(cap[0].length);\n        align = state = cap[1] !== 'left'\n          ? cap[1]\n          : null;\n      }\n      if (cap = /{\\/(left|center|right)}$/.exec(line)) {\n        line = line.slice(0, -cap[0].length);\n        //state = null;\n        state = this.align;\n      }\n    }\n\n    // If the string is apparently too long, wrap it.\n    while (line.length > width) {\n      // Measure the real width of the string.\n      for (i = 0, total = 0; i < line.length; i++) {\n        while (line[i] === '\\x1b') {\n          while (line[i] && line[i++] !== 'm');\n        }\n        if (!line[i]) break;\n        if (++total === width) {\n          // If we're not wrapping the text, we have to finish up the rest of\n          // the control sequences before cutting off the line.\n          i++;\n          if (!wrap) {\n            rest = line.substring(i).match(/\\x1b\\[[^m]*m/g);\n            rest = rest ? rest.join('') : '';\n            out.push(this._align(line.substring(0, i) + rest, width, align));\n            ftor[no].push(out.length - 1);\n            rtof.push(no);\n            continue main;\n          }\n          if (!this.screen.fullUnicode) {\n            // Try to find a space to break on.\n            if (i !== line.length) {\n              j = i;\n              while (j > i - 10 && j > 0 && line[--j] !== ' ');\n              if (line[j] === ' ') i = j + 1;\n            }\n          } else {\n            // Try to find a character to break on.\n            if (i !== line.length) {\n              // <XXX>\n              // Compensate for surrogate length\n              // counts on wrapping (experimental):\n              // NOTE: Could optimize this by putting\n              // it in the parent for loop.\n              if (unicode.isSurrogate(line, i)) i--;\n              for (var s = 0, n = 0; n < i; n++) {\n                if (unicode.isSurrogate(line, n)) s++, n++;\n              }\n              i += s;\n              // </XXX>\n              j = i;\n              // Break _past_ space.\n              // Break _past_ double-width chars.\n              // Break _past_ surrogate pairs.\n              // Break _past_ combining chars.\n              while (j > i - 10 && j > 0) {\n                j--;\n                if (line[j] === ' '\n                    || line[j] === '\\x03'\n                    || (unicode.isSurrogate(line, j - 1) && line[j + 1] !== '\\x03')\n                    || unicode.isCombining(line, j)) {\n                  break;\n                }\n              }\n              if (line[j] === ' '\n                  || line[j] === '\\x03'\n                  || (unicode.isSurrogate(line, j - 1) && line[j + 1] !== '\\x03')\n                  || unicode.isCombining(line, j)) {\n                i = j + 1;\n              }\n            }\n          }\n          break;\n        }\n      }\n\n      part = line.substring(0, i);\n      line = line.substring(i);\n\n      out.push(this._align(part, width, align));\n      ftor[no].push(out.length - 1);\n      rtof.push(no);\n\n      // Make sure we didn't wrap the line to the very end, otherwise\n      // we get a pointless empty line after a newline.\n      if (line === '') continue main;\n\n      // If only an escape code got cut off, at it to `part`.\n      if (/^(?:\\x1b[\\[\\d;]*m)+$/.test(line)) {\n        out[out.length - 1] += line;\n        continue main;\n      }\n    }\n\n    out.push(this._align(line, width, align));\n    ftor[no].push(out.length - 1);\n    rtof.push(no);\n  }\n\n  out.rtof = rtof;\n  out.ftor = ftor;\n  out.fake = lines;\n  out.real = out;\n\n  out.mwidth = out.reduce(function(current, line) {\n    line = line.replace(/\\x1b\\[[\\d;]*m/g, '');\n    return line.length > current\n      ? line.length\n      : current;\n  }, 0);\n\n  return out;\n};\n\nElement.prototype.__defineGetter__('visible', function() {\n  var el = this;\n  do {\n    if (el.detached) return false;\n    if (el.hidden) return false;\n    // if (!el.lpos) return false;\n    // if (el.position.width === 0 || el.position.height === 0) return false;\n  } while (el = el.parent);\n  return true;\n});\n\nElement.prototype.__defineGetter__('_detached', function() {\n  var el = this;\n  do {\n    if (el.type === 'screen') return false;\n    if (!el.parent) return true;\n  } while (el = el.parent);\n  return false;\n});\n\nElement.prototype.enableMouse = function() {\n  this.screen._listenMouse(this);\n};\n\nElement.prototype.enableKeys = function() {\n  this.screen._listenKeys(this);\n};\n\nElement.prototype.enableInput = function() {\n  this.screen._listenMouse(this);\n  this.screen._listenKeys(this);\n};\n\nElement.prototype.__defineGetter__('draggable', function() {\n  return this._draggable === true;\n});\n\nElement.prototype.__defineSetter__('draggable', function(draggable) {\n  return draggable ? this.enableDrag(draggable) : this.disableDrag();\n});\n\nElement.prototype.enableDrag = function(verify) {\n  var self = this;\n\n  if (this._draggable) return true;\n\n  if (typeof verify !== 'function') {\n    verify = function() { return true; };\n  }\n\n  this.enableMouse();\n\n  this.on('mousedown', this._dragMD = function(data) {\n    if (self.screen._dragging) return;\n    if (!verify(data)) return;\n    self.screen._dragging = self;\n    self._drag = {\n      x: data.x - self.aleft,\n      y: data.y - self.atop\n    };\n    self.setFront();\n  });\n\n  this.onScreenEvent('mouse', this._dragM = function(data) {\n    if (self.screen._dragging !== self) return;\n\n    if (data.action !== 'mousedown' && data.action !== 'mousemove') {\n      delete self.screen._dragging;\n      delete self._drag;\n      return;\n    }\n\n    // This can happen in edge cases where the user is\n    // already dragging and element when it is detached.\n    if (!self.parent) return;\n\n    var ox = self._drag.x\n      , oy = self._drag.y\n      , px = self.parent.aleft\n      , py = self.parent.atop\n      , x = data.x - px - ox\n      , y = data.y - py - oy;\n\n    if (self.position.right != null) {\n      if (self.position.left != null) {\n        self.width = '100%-' + (self.parent.width - self.width);\n      }\n      self.position.right = null;\n    }\n\n    if (self.position.bottom != null) {\n      if (self.position.top != null) {\n        self.height = '100%-' + (self.parent.height - self.height);\n      }\n      self.position.bottom = null;\n    }\n\n    self.rleft = x;\n    self.rtop = y;\n\n    self.screen.render();\n  });\n\n  return this._draggable = true;\n};\n\nElement.prototype.disableDrag = function() {\n  if (!this._draggable) return false;\n  delete this.screen._dragging;\n  delete this._drag;\n  this.removeListener('mousedown', this._dragMD);\n  this.removeScreenEvent('mouse', this._dragM);\n  return this._draggable = false;\n};\n\nElement.prototype.key = function() {\n  return this.screen.program.key.apply(this, arguments);\n};\n\nElement.prototype.onceKey = function() {\n  return this.screen.program.onceKey.apply(this, arguments);\n};\n\nElement.prototype.unkey =\nElement.prototype.removeKey = function() {\n  return this.screen.program.unkey.apply(this, arguments);\n};\n\nElement.prototype.setIndex = function(index) {\n  if (!this.parent) return;\n\n  if (index < 0) {\n    index = this.parent.children.length + index;\n  }\n\n  index = Math.max(index, 0);\n  index = Math.min(index, this.parent.children.length - 1);\n\n  var i = this.parent.children.indexOf(this);\n  if (!~i) return;\n\n  var item = this.parent.children.splice(i, 1)[0];\n  this.parent.children.splice(index, 0, item);\n};\n\nElement.prototype.setFront = function() {\n  return this.setIndex(-1);\n};\n\nElement.prototype.setBack = function() {\n  return this.setIndex(0);\n};\n\nElement.prototype.clearPos = function(get, override) {\n  if (this.detached) return;\n  var lpos = this._getCoords(get);\n  if (!lpos) return;\n  this.screen.clearRegion(\n    lpos.xi, lpos.xl,\n    lpos.yi, lpos.yl,\n    override);\n};\n\nElement.prototype.setLabel = function(options) {\n  var self = this;\n  var Box = require('./box');\n\n  if (typeof options === 'string') {\n    options = { text: options };\n  }\n\n  if (this._label) {\n    this._label.setContent(options.text);\n    if (options.side !== 'right') {\n      this._label.rleft = 2 + (this.border ? -1 : 0);\n      this._label.position.right = undefined;\n      if (!this.screen.autoPadding) {\n        this._label.rleft = 2;\n      }\n    } else {\n      this._label.rright = 2 + (this.border ? -1 : 0);\n      this._label.position.left = undefined;\n      if (!this.screen.autoPadding) {\n        this._label.rright = 2;\n      }\n    }\n    return;\n  }\n\n  this._label = new Box({\n    screen: this.screen,\n    parent: this,\n    content: options.text,\n    top: -this.itop,\n    tags: this.parseTags,\n    shrink: true,\n    style: this.style.label\n  });\n\n  if (options.side !== 'right') {\n    this._label.rleft = 2 - this.ileft;\n  } else {\n    this._label.rright = 2 - this.iright;\n  }\n\n  this._label._isLabel = true;\n\n  if (!this.screen.autoPadding) {\n    if (options.side !== 'right') {\n      this._label.rleft = 2;\n    } else {\n      this._label.rright = 2;\n    }\n    this._label.rtop = 0;\n  }\n\n  var reposition = function() {\n    self._label.rtop = (self.childBase || 0) - self.itop;\n    if (!self.screen.autoPadding) {\n      self._label.rtop = (self.childBase || 0);\n    }\n    self.screen.render();\n  };\n\n  this.on('scroll', this._labelScroll = function() {\n    reposition();\n  });\n\n  this.on('resize', this._labelResize = function() {\n    nextTick(function() {\n      reposition();\n    });\n  });\n};\n\nElement.prototype.removeLabel = function() {\n  if (!this._label) return;\n  this.removeListener('scroll', this._labelScroll);\n  this.removeListener('resize', this._labelResize);\n  this._label.detach();\n  delete this._labelScroll;\n  delete this._labelResize;\n  delete this._label;\n};\n\nElement.prototype.setHover = function(options) {\n  if (typeof options === 'string') {\n    options = { text: options };\n  }\n\n  this._hoverOptions = options;\n  this.enableMouse();\n  this.screen._initHover();\n};\n\nElement.prototype.removeHover = function() {\n  delete this._hoverOptions;\n  if (!this.screen._hoverText || this.screen._hoverText.detached) return;\n  this.screen._hoverText.detach();\n  this.screen.render();\n};\n\n/**\n * Positioning\n */\n\n// The below methods are a bit confusing: basically\n// whenever Box.render is called `lpos` gets set on\n// the element, an object containing the rendered\n// coordinates. Since these don't update if the\n// element is moved somehow, they're unreliable in\n// that situation. However, if we can guarantee that\n// lpos is good and up to date, it can be more\n// accurate than the calculated positions below.\n// In this case, if the element is being rendered,\n// it's guaranteed that the parent will have been\n// rendered first, in which case we can use the\n// parant's lpos instead of recalculating it's\n// position (since that might be wrong because\n// it doesn't handle content shrinkage).\n\nElement.prototype._getPos = function() {\n  var pos = this.lpos;\n\n  assert.ok(pos);\n\n  if (pos.aleft != null) return pos;\n\n  pos.aleft = pos.xi;\n  pos.atop = pos.yi;\n  pos.aright = this.screen.cols - pos.xl;\n  pos.abottom = this.screen.rows - pos.yl;\n  pos.width = pos.xl - pos.xi;\n  pos.height = pos.yl - pos.yi;\n\n  return pos;\n};\n\n/**\n * Position Getters\n */\n\nElement.prototype._getWidth = function(get) {\n  var parent = get ? this.parent._getPos() : this.parent\n    , width = this.position.width\n    , left\n    , expr;\n\n  if (typeof width === 'string') {\n    if (width === 'half') width = '50%';\n    expr = width.split(/(?=\\+|-)/);\n    width = expr[0];\n    width = +width.slice(0, -1) / 100;\n    width = parent.width * width | 0;\n    width += +(expr[1] || 0);\n    return width;\n  }\n\n  // This is for if the element is being streched or shrunken.\n  // Although the width for shrunken elements is calculated\n  // in the render function, it may be calculated based on\n  // the content width, and the content width is initially\n  // decided by the width the element, so it needs to be\n  // calculated here.\n  if (width == null) {\n    left = this.position.left || 0;\n    if (typeof left === 'string') {\n      if (left === 'center') left = '50%';\n      expr = left.split(/(?=\\+|-)/);\n      left = expr[0];\n      left = +left.slice(0, -1) / 100;\n      left = parent.width * left | 0;\n      left += +(expr[1] || 0);\n    }\n    width = parent.width - (this.position.right || 0) - left;\n    if (this.screen.autoPadding) {\n      if ((this.position.left != null || this.position.right == null)\n          && this.position.left !== 'center') {\n        width -= this.parent.ileft;\n      }\n      width -= this.parent.iright;\n    }\n  }\n\n  return width;\n};\n\nElement.prototype.__defineGetter__('width', function() {\n  return this._getWidth(false);\n});\n\nElement.prototype._getHeight = function(get) {\n  var parent = get ? this.parent._getPos() : this.parent\n    , height = this.position.height\n    , top\n    , expr;\n\n  if (typeof height === 'string') {\n    if (height === 'half') height = '50%';\n    expr = height.split(/(?=\\+|-)/);\n    height = expr[0];\n    height = +height.slice(0, -1) / 100;\n    height = parent.height * height | 0;\n    height += +(expr[1] || 0);\n    return height;\n  }\n\n  // This is for if the element is being streched or shrunken.\n  // Although the width for shrunken elements is calculated\n  // in the render function, it may be calculated based on\n  // the content width, and the content width is initially\n  // decided by the width the element, so it needs to be\n  // calculated here.\n  if (height == null) {\n    top = this.position.top || 0;\n    if (typeof top === 'string') {\n      if (top === 'center') top = '50%';\n      expr = top.split(/(?=\\+|-)/);\n      top = expr[0];\n      top = +top.slice(0, -1) / 100;\n      top = parent.height * top | 0;\n      top += +(expr[1] || 0);\n    }\n    height = parent.height - (this.position.bottom || 0) - top;\n    if (this.screen.autoPadding) {\n      if ((this.position.top != null\n          || this.position.bottom == null)\n          && this.position.top !== 'center') {\n        height -= this.parent.itop;\n      }\n      height -= this.parent.ibottom;\n    }\n  }\n\n  return height;\n};\n\nElement.prototype.__defineGetter__('height', function() {\n  return this._getHeight(false);\n});\n\nElement.prototype._getLeft = function(get) {\n  var parent = get ? this.parent._getPos() : this.parent\n    , left = this.position.left || 0\n    , expr;\n\n  if (typeof left === 'string') {\n    if (left === 'center') left = '50%';\n    expr = left.split(/(?=\\+|-)/);\n    left = expr[0];\n    left = +left.slice(0, -1) / 100;\n    left = parent.width * left | 0;\n    left += +(expr[1] || 0);\n    if (this.position.left === 'center') {\n      left -= this._getWidth(get) / 2 | 0;\n    }\n  }\n\n  if (this.position.left == null && this.position.right != null) {\n    return this.screen.cols - this._getWidth(get) - this._getRight(get);\n  }\n\n  if (this.screen.autoPadding) {\n    if ((this.position.left != null\n        || this.position.right == null)\n        && this.position.left !== 'center') {\n      left += this.parent.ileft;\n    }\n  }\n\n  return (parent.aleft || 0) + left;\n};\n\nElement.prototype.__defineGetter__('aleft', function() {\n  return this._getLeft(false);\n});\n\nElement.prototype._getRight = function(get) {\n  var parent = get ? this.parent._getPos() : this.parent\n    , right;\n\n  if (this.position.right == null && this.position.left != null) {\n    right = this.screen.cols - (this._getLeft(get) + this._getWidth(get));\n    if (this.screen.autoPadding) {\n      right += this.parent.iright;\n    }\n    return right;\n  }\n\n  right = (parent.aright || 0) + (this.position.right || 0);\n\n  if (this.screen.autoPadding) {\n    right += this.parent.iright;\n  }\n\n  return right;\n};\n\nElement.prototype.__defineGetter__('aright', function() {\n  return this._getRight(false);\n});\n\nElement.prototype._getTop = function(get) {\n  var parent = get ? this.parent._getPos() : this.parent\n    , top = this.position.top || 0\n    , expr;\n\n  if (typeof top === 'string') {\n    if (top === 'center') top = '50%';\n    expr = top.split(/(?=\\+|-)/);\n    top = expr[0];\n    top = +top.slice(0, -1) / 100;\n    top = parent.height * top | 0;\n    top += +(expr[1] || 0);\n    if (this.position.top === 'center') {\n      top -= this._getHeight(get) / 2 | 0;\n    }\n  }\n\n  if (this.position.top == null && this.position.bottom != null) {\n    return this.screen.rows - this._getHeight(get) - this._getBottom(get);\n  }\n\n  if (this.screen.autoPadding) {\n    if ((this.position.top != null\n        || this.position.bottom == null)\n        && this.position.top !== 'center') {\n      top += this.parent.itop;\n    }\n  }\n\n  return (parent.atop || 0) + top;\n};\n\nElement.prototype.__defineGetter__('atop', function() {\n  return this._getTop(false);\n});\n\nElement.prototype._getBottom = function(get) {\n  var parent = get ? this.parent._getPos() : this.parent\n    , bottom;\n\n  if (this.position.bottom == null && this.position.top != null) {\n    bottom = this.screen.rows - (this._getTop(get) + this._getHeight(get));\n    if (this.screen.autoPadding) {\n      bottom += this.parent.ibottom;\n    }\n    return bottom;\n  }\n\n  bottom = (parent.abottom || 0) + (this.position.bottom || 0);\n\n  if (this.screen.autoPadding) {\n    bottom += this.parent.ibottom;\n  }\n\n  return bottom;\n};\n\nElement.prototype.__defineGetter__('abottom', function() {\n  return this._getBottom(false);\n});\n\nElement.prototype.__defineGetter__('rleft', function() {\n  return this.aleft - this.parent.aleft;\n});\n\nElement.prototype.__defineGetter__('rright', function() {\n  return this.aright - this.parent.aright;\n});\n\nElement.prototype.__defineGetter__('rtop', function() {\n  return this.atop - this.parent.atop;\n});\n\nElement.prototype.__defineGetter__('rbottom', function() {\n  return this.abottom - this.parent.abottom;\n});\n\n/**\n * Position Setters\n */\n\n// NOTE:\n// For aright, abottom, right, and bottom:\n// If position.bottom is null, we could simply set top instead.\n// But it wouldn't replicate bottom behavior appropriately if\n// the parent was resized, etc.\nElement.prototype.__defineSetter__('width', function(val) {\n  if (this.position.width === val) return;\n  if (/^\\d+$/.test(val)) val = +val;\n  this.emit('resize');\n  this.clearPos();\n  return this.position.width = val;\n});\n\nElement.prototype.__defineSetter__('height', function(val) {\n  if (this.position.height === val) return;\n  if (/^\\d+$/.test(val)) val = +val;\n  this.emit('resize');\n  this.clearPos();\n  return this.position.height = val;\n});\n\nElement.prototype.__defineSetter__('aleft', function(val) {\n  var expr;\n  if (typeof val === 'string') {\n    if (val === 'center') {\n      val = this.screen.width / 2 | 0;\n      val -= this.width / 2 | 0;\n    } else {\n      expr = val.split(/(?=\\+|-)/);\n      val = expr[0];\n      val = +val.slice(0, -1) / 100;\n      val = this.screen.width * val | 0;\n      val += +(expr[1] || 0);\n    }\n  }\n  val -= this.parent.aleft;\n  if (this.position.left === val) return;\n  this.emit('move');\n  this.clearPos();\n  return this.position.left = val;\n});\n\nElement.prototype.__defineSetter__('aright', function(val) {\n  val -= this.parent.aright;\n  if (this.position.right === val) return;\n  this.emit('move');\n  this.clearPos();\n  return this.position.right = val;\n});\n\nElement.prototype.__defineSetter__('atop', function(val) {\n  var expr;\n  if (typeof val === 'string') {\n    if (val === 'center') {\n      val = this.screen.height / 2 | 0;\n      val -= this.height / 2 | 0;\n    } else {\n      expr = val.split(/(?=\\+|-)/);\n      val = expr[0];\n      val = +val.slice(0, -1) / 100;\n      val = this.screen.height * val | 0;\n      val += +(expr[1] || 0);\n    }\n  }\n  val -= this.parent.atop;\n  if (this.position.top === val) return;\n  this.emit('move');\n  this.clearPos();\n  return this.position.top = val;\n});\n\nElement.prototype.__defineSetter__('abottom', function(val) {\n  val -= this.parent.abottom;\n  if (this.position.bottom === val) return;\n  this.emit('move');\n  this.clearPos();\n  return this.position.bottom = val;\n});\n\nElement.prototype.__defineSetter__('rleft', function(val) {\n  if (this.position.left === val) return;\n  if (/^\\d+$/.test(val)) val = +val;\n  this.emit('move');\n  this.clearPos();\n  return this.position.left = val;\n});\n\nElement.prototype.__defineSetter__('rright', function(val) {\n  if (this.position.right === val) return;\n  this.emit('move');\n  this.clearPos();\n  return this.position.right = val;\n});\n\nElement.prototype.__defineSetter__('rtop', function(val) {\n  if (this.position.top === val) return;\n  if (/^\\d+$/.test(val)) val = +val;\n  this.emit('move');\n  this.clearPos();\n  return this.position.top = val;\n});\n\nElement.prototype.__defineSetter__('rbottom', function(val) {\n  if (this.position.bottom === val) return;\n  this.emit('move');\n  this.clearPos();\n  return this.position.bottom = val;\n});\n\nElement.prototype.__defineGetter__('ileft', function() {\n  return (this.border ? 1 : 0) + this.padding.left;\n  // return (this.border && this.border.left ? 1 : 0) + this.padding.left;\n});\n\nElement.prototype.__defineGetter__('itop', function() {\n  return (this.border ? 1 : 0) + this.padding.top;\n  // return (this.border && this.border.top ? 1 : 0) + this.padding.top;\n});\n\nElement.prototype.__defineGetter__('iright', function() {\n  return (this.border ? 1 : 0) + this.padding.right;\n  // return (this.border && this.border.right ? 1 : 0) + this.padding.right;\n});\n\nElement.prototype.__defineGetter__('ibottom', function() {\n  return (this.border ? 1 : 0) + this.padding.bottom;\n  // return (this.border && this.border.bottom ? 1 : 0) + this.padding.bottom;\n});\n\nElement.prototype.__defineGetter__('iwidth', function() {\n  // return (this.border\n  //   ? ((this.border.left ? 1 : 0) + (this.border.right ? 1 : 0)) : 0)\n  //   + this.padding.left + this.padding.right;\n  return (this.border ? 2 : 0) + this.padding.left + this.padding.right;\n});\n\nElement.prototype.__defineGetter__('iheight', function() {\n  // return (this.border\n  //   ? ((this.border.top ? 1 : 0) + (this.border.bottom ? 1 : 0)) : 0)\n  //   + this.padding.top + this.padding.bottom;\n  return (this.border ? 2 : 0) + this.padding.top + this.padding.bottom;\n});\n\nElement.prototype.__defineGetter__('tpadding', function() {\n  return this.padding.left + this.padding.top\n    + this.padding.right + this.padding.bottom;\n});\n\n/**\n * Relative coordinates as default properties\n */\n\nElement.prototype.__defineGetter__('left', function() {\n  return this.rleft;\n});\n\nElement.prototype.__defineGetter__('right', function() {\n  return this.rright;\n});\n\nElement.prototype.__defineGetter__('top', function() {\n  return this.rtop;\n});\n\nElement.prototype.__defineGetter__('bottom', function() {\n  return this.rbottom;\n});\n\nElement.prototype.__defineSetter__('left', function(val) {\n  return this.rleft = val;\n});\n\nElement.prototype.__defineSetter__('right', function(val) {\n  return this.rright = val;\n});\n\nElement.prototype.__defineSetter__('top', function(val) {\n  return this.rtop = val;\n});\n\nElement.prototype.__defineSetter__('bottom', function(val) {\n  return this.rbottom = val;\n});\n\n/**\n * Rendering - here be dragons\n */\n\nElement.prototype._getShrinkBox = function(xi, xl, yi, yl, get) {\n  if (!this.children.length) {\n    return { xi: xi, xl: xi + 1, yi: yi, yl: yi + 1 };\n  }\n\n  var i, el, ret, mxi = xi, mxl = xi + 1, myi = yi, myl = yi + 1;\n\n  // This is a chicken and egg problem. We need to determine how the children\n  // will render in order to determine how this element renders, but it in\n  // order to figure out how the children will render, they need to know\n  // exactly how their parent renders, so, we can give them what we have so\n  // far.\n  var _lpos;\n  if (get) {\n    _lpos = this.lpos;\n    this.lpos = { xi: xi, xl: xl, yi: yi, yl: yl };\n    //this.shrink = false;\n  }\n\n  for (i = 0; i < this.children.length; i++) {\n    el = this.children[i];\n\n    ret = el._getCoords(get);\n\n    // Or just (seemed to work, but probably not good):\n    // ret = el.lpos || this.lpos;\n\n    if (!ret) continue;\n\n    // Since the parent element is shrunk, and the child elements think it's\n    // going to take up as much space as possible, an element anchored to the\n    // right or bottom will inadvertantly make the parent's shrunken size as\n    // large as possible. So, we can just use the height and/or width the of\n    // element.\n    // if (get) {\n    if (el.position.left == null && el.position.right != null) {\n      ret.xl = xi + (ret.xl - ret.xi);\n      ret.xi = xi;\n      if (this.screen.autoPadding) {\n        // Maybe just do this no matter what.\n        ret.xl += this.ileft;\n        ret.xi += this.ileft;\n      }\n    }\n    if (el.position.top == null && el.position.bottom != null) {\n      ret.yl = yi + (ret.yl - ret.yi);\n      ret.yi = yi;\n      if (this.screen.autoPadding) {\n        // Maybe just do this no matter what.\n        ret.yl += this.itop;\n        ret.yi += this.itop;\n      }\n    }\n\n    if (ret.xi < mxi) mxi = ret.xi;\n    if (ret.xl > mxl) mxl = ret.xl;\n    if (ret.yi < myi) myi = ret.yi;\n    if (ret.yl > myl) myl = ret.yl;\n  }\n\n  if (get) {\n    this.lpos = _lpos;\n    //this.shrink = true;\n  }\n\n  if (this.position.width == null\n      && (this.position.left == null\n      || this.position.right == null)) {\n    if (this.position.left == null && this.position.right != null) {\n      xi = xl - (mxl - mxi);\n      if (!this.screen.autoPadding) {\n        xi -= this.padding.left + this.padding.right;\n      } else {\n        xi -= this.ileft;\n      }\n    } else {\n      xl = mxl;\n      if (!this.screen.autoPadding) {\n        xl += this.padding.left + this.padding.right;\n        // XXX Temporary workaround until we decide to make autoPadding default.\n        // See widget-listtable.js for an example of why this is necessary.\n        // XXX Maybe just to this for all this being that this would affect\n        // width shrunken normal shrunken lists as well.\n        // if (this._isList) {\n        if (this.type === 'list-table') {\n          xl -= this.padding.left + this.padding.right;\n          xl += this.iright;\n        }\n      } else {\n        //xl += this.padding.right;\n        xl += this.iright;\n      }\n    }\n  }\n\n  if (this.position.height == null\n      && (this.position.top == null\n      || this.position.bottom == null)\n      && (!this.scrollable || this._isList)) {\n    // NOTE: Lists get special treatment if they are shrunken - assume they\n    // want all list items showing. This is one case we can calculate the\n    // height based on items/boxes.\n    if (this._isList) {\n      myi = 0 - this.itop;\n      myl = this.items.length + this.ibottom;\n    }\n    if (this.position.top == null && this.position.bottom != null) {\n      yi = yl - (myl - myi);\n      if (!this.screen.autoPadding) {\n        yi -= this.padding.top + this.padding.bottom;\n      } else {\n        yi -= this.itop;\n      }\n    } else {\n      yl = myl;\n      if (!this.screen.autoPadding) {\n        yl += this.padding.top + this.padding.bottom;\n      } else {\n        yl += this.ibottom;\n      }\n    }\n  }\n\n  return { xi: xi, xl: xl, yi: yi, yl: yl };\n};\n\nElement.prototype._getShrinkContent = function(xi, xl, yi, yl) {\n  var h = this._clines.length\n    , w = this._clines.mwidth || 1;\n\n  if (this.position.width == null\n      && (this.position.left == null\n      || this.position.right == null)) {\n    if (this.position.left == null && this.position.right != null) {\n      xi = xl - w - this.iwidth;\n    } else {\n      xl = xi + w + this.iwidth;\n    }\n  }\n\n  if (this.position.height == null\n      && (this.position.top == null\n      || this.position.bottom == null)\n      && (!this.scrollable || this._isList)) {\n    if (this.position.top == null && this.position.bottom != null) {\n      yi = yl - h - this.iheight;\n    } else {\n      yl = yi + h + this.iheight;\n    }\n  }\n\n  return { xi: xi, xl: xl, yi: yi, yl: yl };\n};\n\nElement.prototype._getShrink = function(xi, xl, yi, yl, get) {\n  var shrinkBox = this._getShrinkBox(xi, xl, yi, yl, get)\n    , shrinkContent = this._getShrinkContent(xi, xl, yi, yl, get)\n    , xll = xl\n    , yll = yl;\n\n  // Figure out which one is bigger and use it.\n  if (shrinkBox.xl - shrinkBox.xi > shrinkContent.xl - shrinkContent.xi) {\n    xi = shrinkBox.xi;\n    xl = shrinkBox.xl;\n  } else {\n    xi = shrinkContent.xi;\n    xl = shrinkContent.xl;\n  }\n\n  if (shrinkBox.yl - shrinkBox.yi > shrinkContent.yl - shrinkContent.yi) {\n    yi = shrinkBox.yi;\n    yl = shrinkBox.yl;\n  } else {\n    yi = shrinkContent.yi;\n    yl = shrinkContent.yl;\n  }\n\n  // Recenter shrunken elements.\n  if (xl < xll && this.position.left === 'center') {\n    xll = (xll - xl) / 2 | 0;\n    xi += xll;\n    xl += xll;\n  }\n\n  if (yl < yll && this.position.top === 'center') {\n    yll = (yll - yl) / 2 | 0;\n    yi += yll;\n    yl += yll;\n  }\n\n  return { xi: xi, xl: xl, yi: yi, yl: yl };\n};\n\nElement.prototype._getCoords = function(get, noscroll) {\n  if (this.hidden) return;\n\n  // if (this.parent._rendering) {\n  //   get = true;\n  // }\n\n  var xi = this._getLeft(get)\n    , xl = xi + this._getWidth(get)\n    , yi = this._getTop(get)\n    , yl = yi + this._getHeight(get)\n    , base = this.childBase || 0\n    , el = this\n    , fixed = this.fixed\n    , coords\n    , v\n    , noleft\n    , noright\n    , notop\n    , nobot\n    , ppos\n    , b;\n\n  // Attempt to shrink the element base on the\n  // size of the content and child elements.\n  if (this.shrink) {\n    coords = this._getShrink(xi, xl, yi, yl, get);\n    xi = coords.xi, xl = coords.xl;\n    yi = coords.yi, yl = coords.yl;\n  }\n\n  // Find a scrollable ancestor if we have one.\n  while (el = el.parent) {\n    if (el.scrollable) {\n      if (fixed) {\n        fixed = false;\n        continue;\n      }\n      break;\n    }\n  }\n\n  // Check to make sure we're visible and\n  // inside of the visible scroll area.\n  // NOTE: Lists have a property where only\n  // the list items are obfuscated.\n\n  // Old way of doing things, this would not render right if a shrunken element\n  // with lots of boxes in it was within a scrollable element.\n  // See: $ node test/widget-shrink-fail.js\n  // var thisparent = this.parent;\n\n  var thisparent = el;\n  if (el && !noscroll) {\n    ppos = thisparent.lpos;\n\n    // The shrink option can cause a stack overflow\n    // by calling _getCoords on the child again.\n    // if (!get && !thisparent.shrink) {\n    //   ppos = thisparent._getCoords();\n    // }\n\n    if (!ppos) return;\n\n    // TODO: Figure out how to fix base (and cbase to only\n    // take into account the *parent's* padding.\n\n    yi -= ppos.base;\n    yl -= ppos.base;\n\n    b = thisparent.border ? 1 : 0;\n\n    // XXX\n    // Fixes non-`fixed` labels to work with scrolling (they're ON the border):\n    // if (this.position.left < 0\n    //     || this.position.right < 0\n    //     || this.position.top < 0\n    //     || this.position.bottom < 0) {\n    if (this._isLabel) {\n      b = 0;\n    }\n\n    if (yi < ppos.yi + b) {\n      if (yl - 1 < ppos.yi + b) {\n        // Is above.\n        return;\n      } else {\n        // Is partially covered above.\n        notop = true;\n        v = ppos.yi - yi;\n        if (this.border) v--;\n        if (thisparent.border) v++;\n        base += v;\n        yi += v;\n      }\n    } else if (yl > ppos.yl - b) {\n      if (yi > ppos.yl - 1 - b) {\n        // Is below.\n        return;\n      } else {\n        // Is partially covered below.\n        nobot = true;\n        v = yl - ppos.yl;\n        if (this.border) v--;\n        if (thisparent.border) v++;\n        yl -= v;\n      }\n    }\n\n    // Shouldn't be necessary.\n    // assert.ok(yi < yl);\n    if (yi >= yl) return;\n\n    // Could allow overlapping stuff in scrolling elements\n    // if we cleared the pending buffer before every draw.\n    if (xi < el.lpos.xi) {\n      xi = el.lpos.xi;\n      noleft = true;\n      if (this.border) xi--;\n      if (thisparent.border) xi++;\n    }\n    if (xl > el.lpos.xl) {\n      xl = el.lpos.xl;\n      noright = true;\n      if (this.border) xl++;\n      if (thisparent.border) xl--;\n    }\n    //if (xi > xl) return;\n    if (xi >= xl) return;\n  }\n\n  if (this.noOverflow && this.parent.lpos) {\n    if (xi < this.parent.lpos.xi + this.parent.ileft) {\n      xi = this.parent.lpos.xi + this.parent.ileft;\n    }\n    if (xl > this.parent.lpos.xl - this.parent.iright) {\n      xl = this.parent.lpos.xl - this.parent.iright;\n    }\n    if (yi < this.parent.lpos.yi + this.parent.itop) {\n      yi = this.parent.lpos.yi + this.parent.itop;\n    }\n    if (yl > this.parent.lpos.yl - this.parent.ibottom) {\n      yl = this.parent.lpos.yl - this.parent.ibottom;\n    }\n  }\n\n  // if (this.parent.lpos) {\n  //   this.parent.lpos._scrollBottom = Math.max(\n  //     this.parent.lpos._scrollBottom, yl);\n  // }\n\n  return {\n    xi: xi,\n    xl: xl,\n    yi: yi,\n    yl: yl,\n    base: base,\n    noleft: noleft,\n    noright: noright,\n    notop: notop,\n    nobot: nobot,\n    renders: this.screen.renders\n  };\n};\n\nElement.prototype.render = function() {\n  this._emit('prerender');\n\n  this.parseContent();\n\n  var coords = this._getCoords(true);\n  if (!coords) {\n    delete this.lpos;\n    return;\n  }\n\n  if (coords.xl - coords.xi <= 0) {\n    coords.xl = Math.max(coords.xl, coords.xi);\n    return;\n  }\n\n  if (coords.yl - coords.yi <= 0) {\n    coords.yl = Math.max(coords.yl, coords.yi);\n    return;\n  }\n\n  var lines = this.screen.lines\n    , xi = coords.xi\n    , xl = coords.xl\n    , yi = coords.yi\n    , yl = coords.yl\n    , x\n    , y\n    , cell\n    , attr\n    , ch\n    , content = this._pcontent\n    , ci = this._clines.ci[coords.base]\n    , battr\n    , dattr\n    , c\n    , visible\n    , i\n    , bch = this.ch;\n\n  // Clip content if it's off the edge of the screen\n  // if (xi + this.ileft < 0 || yi + this.itop < 0) {\n  //   var clines = this._clines.slice();\n  //   if (xi + this.ileft < 0) {\n  //     for (var i = 0; i < clines.length; i++) {\n  //       var t = 0;\n  //       var csi = '';\n  //       var csis = '';\n  //       for (var j = 0; j < clines[i].length; j++) {\n  //         while (clines[i][j] === '\\x1b') {\n  //           csi = '\\x1b';\n  //           while (clines[i][j++] !== 'm') csi += clines[i][j];\n  //           csis += csi;\n  //         }\n  //         if (++t === -(xi + this.ileft) + 1) break;\n  //       }\n  //       clines[i] = csis + clines[i].substring(j);\n  //     }\n  //   }\n  //   if (yi + this.itop < 0) {\n  //     clines = clines.slice(-(yi + this.itop));\n  //   }\n  //   content = clines.join('\\n');\n  // }\n\n  if (coords.base >= this._clines.ci.length) {\n    ci = this._pcontent.length;\n  }\n\n  this.lpos = coords;\n\n  if (this.border && this.border.type === 'line') {\n    this.screen._borderStops[coords.yi] = true;\n    this.screen._borderStops[coords.yl - 1] = true;\n    // if (!this.screen._borderStops[coords.yi]) {\n    //   this.screen._borderStops[coords.yi] = { xi: coords.xi, xl: coords.xl };\n    // } else {\n    //   if (this.screen._borderStops[coords.yi].xi > coords.xi) {\n    //     this.screen._borderStops[coords.yi].xi = coords.xi;\n    //   }\n    //   if (this.screen._borderStops[coords.yi].xl < coords.xl) {\n    //     this.screen._borderStops[coords.yi].xl = coords.xl;\n    //   }\n    // }\n    // this.screen._borderStops[coords.yl - 1] = this.screen._borderStops[coords.yi];\n  }\n\n  dattr = this.sattr(this.style);\n  attr = dattr;\n\n  // If we're in a scrollable text box, check to\n  // see which attributes this line starts with.\n  if (ci > 0) {\n    attr = this._clines.attr[Math.min(coords.base, this._clines.length - 1)];\n  }\n\n  if (this.border) xi++, xl--, yi++, yl--;\n\n  // If we have padding/valign, that means the\n  // content-drawing loop will skip a few cells/lines.\n  // To deal with this, we can just fill the whole thing\n  // ahead of time. This could be optimized.\n  if (this.tpadding || (this.valign && this.valign !== 'top')) {\n    if (this.style.transparent) {\n      for (y = Math.max(yi, 0); y < yl; y++) {\n        if (!lines[y]) break;\n        for (x = Math.max(xi, 0); x < xl; x++) {\n          if (!lines[y][x]) break;\n          lines[y][x][0] = colors.blend(attr, lines[y][x][0]);\n          // lines[y][x][1] = bch;\n          lines[y].dirty = true;\n        }\n      }\n    } else {\n      this.screen.fillRegion(dattr, bch, xi, xl, yi, yl);\n    }\n  }\n\n  if (this.tpadding) {\n    xi += this.padding.left, xl -= this.padding.right;\n    yi += this.padding.top, yl -= this.padding.bottom;\n  }\n\n  // Determine where to place the text if it's vertically aligned.\n  if (this.valign === 'middle' || this.valign === 'bottom') {\n    visible = yl - yi;\n    if (this._clines.length < visible) {\n      if (this.valign === 'middle') {\n        visible = visible / 2 | 0;\n        visible -= this._clines.length / 2 | 0;\n      } else if (this.valign === 'bottom') {\n        visible -= this._clines.length;\n      }\n      ci -= visible * (xl - xi);\n    }\n  }\n\n  // Draw the content and background.\n  for (y = yi; y < yl; y++) {\n    if (!lines[y]) {\n      if (y >= this.screen.height || yl < this.ibottom) {\n        break;\n      } else {\n        continue;\n      }\n    }\n    for (x = xi; x < xl; x++) {\n      cell = lines[y][x];\n      if (!cell) {\n        if (x >= this.screen.width || xl < this.iright) {\n          break;\n        } else {\n          continue;\n        }\n      }\n\n      ch = content[ci++] || bch;\n\n      // if (!content[ci] && !coords._contentEnd) {\n      //   coords._contentEnd = { x: x - xi, y: y - yi };\n      // }\n\n      // Handle escape codes.\n      while (ch === '\\x1b') {\n        if (c = /^\\x1b\\[[\\d;]*m/.exec(content.substring(ci - 1))) {\n          ci += c[0].length - 1;\n          attr = this.screen.attrCode(c[0], attr, dattr);\n          // Ignore foreground changes for selected items.\n          if (this.parent._isList && this.parent.interactive\n              && this.parent.items[this.parent.selected] === this\n              && this.parent.options.invertSelected !== false) {\n            attr = (attr & ~(0x1ff << 9)) | (dattr & (0x1ff << 9));\n          }\n          ch = content[ci] || bch;\n          ci++;\n        } else {\n          break;\n        }\n      }\n\n      // Handle newlines.\n      if (ch === '\\t') ch = bch;\n      if (ch === '\\n') {\n        // If we're on the first cell and we find a newline and the last cell\n        // of the last line was not a newline, let's just treat this like the\n        // newline was already \"counted\".\n        if (x === xi && y !== yi && content[ci - 2] !== '\\n') {\n          x--;\n          continue;\n        }\n        // We could use fillRegion here, name the\n        // outer loop, and continue to it instead.\n        ch = bch;\n        for (; x < xl; x++) {\n          cell = lines[y][x];\n          if (!cell) break;\n          if (this.style.transparent) {\n            lines[y][x][0] = colors.blend(attr, lines[y][x][0]);\n            if (content[ci]) lines[y][x][1] = ch;\n            lines[y].dirty = true;\n          } else {\n            if (attr !== cell[0] || ch !== cell[1]) {\n              lines[y][x][0] = attr;\n              lines[y][x][1] = ch;\n              lines[y].dirty = true;\n            }\n          }\n        }\n        continue;\n      }\n\n      if (this.screen.fullUnicode && content[ci - 1]) {\n        var point = unicode.codePointAt(content, ci - 1);\n        // Handle combining chars:\n        // Make sure they get in the same cell and are counted as 0.\n        if (unicode.combining[point]) {\n          if (point > 0x00ffff) {\n            ch = content[ci - 1] + content[ci];\n            ci++;\n          }\n          if (x - 1 >= xi) {\n            lines[y][x - 1][1] += ch;\n          } else if (y - 1 >= yi) {\n            lines[y - 1][xl - 1][1] += ch;\n          }\n          x--;\n          continue;\n        }\n        // Handle surrogate pairs:\n        // Make sure we put surrogate pair chars in one cell.\n        if (point > 0x00ffff) {\n          ch = content[ci - 1] + content[ci];\n          ci++;\n        }\n      }\n\n      if (this._noFill) continue;\n\n      if (this.style.transparent) {\n        lines[y][x][0] = colors.blend(attr, lines[y][x][0]);\n        if (content[ci]) lines[y][x][1] = ch;\n        lines[y].dirty = true;\n      } else {\n        if (attr !== cell[0] || ch !== cell[1]) {\n          lines[y][x][0] = attr;\n          lines[y][x][1] = ch;\n          lines[y].dirty = true;\n        }\n      }\n    }\n  }\n\n  // Draw the scrollbar.\n  // Could possibly draw this after all child elements.\n  if (this.scrollbar) {\n    // XXX\n    // i = this.getScrollHeight();\n    i = Math.max(this._clines.length, this._scrollBottom());\n  }\n  if (coords.notop || coords.nobot) i = -Infinity;\n  if (this.scrollbar && (yl - yi) < i) {\n    x = xl - 1;\n    if (this.scrollbar.ignoreBorder && this.border) x++;\n    if (this.alwaysScroll) {\n      y = this.childBase / (i - (yl - yi));\n    } else {\n      y = (this.childBase + this.childOffset) / (i - 1);\n    }\n    y = yi + ((yl - yi) * y | 0);\n    if (y >= yl) y = yl - 1;\n    cell = lines[y] && lines[y][x];\n    if (cell) {\n      if (this.track) {\n        ch = this.track.ch || ' ';\n        attr = this.sattr(this.style.track,\n          this.style.track.fg || this.style.fg,\n          this.style.track.bg || this.style.bg);\n        this.screen.fillRegion(attr, ch, x, x + 1, yi, yl);\n      }\n      ch = this.scrollbar.ch || ' ';\n      attr = this.sattr(this.style.scrollbar,\n        this.style.scrollbar.fg || this.style.fg,\n        this.style.scrollbar.bg || this.style.bg);\n      if (attr !== cell[0] || ch !== cell[1]) {\n        lines[y][x][0] = attr;\n        lines[y][x][1] = ch;\n        lines[y].dirty = true;\n      }\n    }\n  }\n\n  if (this.border) xi--, xl++, yi--, yl++;\n\n  if (this.tpadding) {\n    xi -= this.padding.left, xl += this.padding.right;\n    yi -= this.padding.top, yl += this.padding.bottom;\n  }\n\n  // Draw the border.\n  if (this.border) {\n    battr = this.sattr(this.style.border);\n    y = yi;\n    if (coords.notop) y = -1;\n    for (x = xi; x < xl; x++) {\n      if (!lines[y]) break;\n      if (coords.noleft && x === xi) continue;\n      if (coords.noright && x === xl - 1) continue;\n      cell = lines[y][x];\n      if (!cell) continue;\n      if (this.border.type === 'line') {\n        if (x === xi) {\n          ch = '\\u250c'; // '┌'\n          if (!this.border.left) {\n            if (this.border.top) {\n              ch = '\\u2500'; // '─'\n            } else {\n              continue;\n            }\n          } else {\n            if (!this.border.top) {\n              ch = '\\u2502'; // '│'\n            }\n          }\n        } else if (x === xl - 1) {\n          ch = '\\u2510'; // '┐'\n          if (!this.border.right) {\n            if (this.border.top) {\n              ch = '\\u2500'; // '─'\n            } else {\n              continue;\n            }\n          } else {\n            if (!this.border.top) {\n              ch = '\\u2502'; // '│'\n            }\n          }\n        } else {\n          ch = '\\u2500'; // '─'\n        }\n      } else if (this.border.type === 'bg') {\n        ch = this.border.ch;\n      }\n      if (!this.border.top && x !== xi && x !== xl - 1) {\n        ch = ' ';\n        if (dattr !== cell[0] || ch !== cell[1]) {\n          lines[y][x][0] = dattr;\n          lines[y][x][1] = ch;\n          lines[y].dirty = true;\n          continue;\n        }\n      }\n      if (battr !== cell[0] || ch !== cell[1]) {\n        lines[y][x][0] = battr;\n        lines[y][x][1] = ch;\n        lines[y].dirty = true;\n      }\n    }\n    y = yi + 1;\n    for (; y < yl - 1; y++) {\n      if (!lines[y]) continue;\n      cell = lines[y][xi];\n      if (cell) {\n        if (this.border.left) {\n          if (this.border.type === 'line') {\n            ch = '\\u2502'; // '│'\n          } else if (this.border.type === 'bg') {\n            ch = this.border.ch;\n          }\n          if (!coords.noleft)\n          if (battr !== cell[0] || ch !== cell[1]) {\n            lines[y][xi][0] = battr;\n            lines[y][xi][1] = ch;\n            lines[y].dirty = true;\n          }\n        } else {\n          ch = ' ';\n          if (dattr !== cell[0] || ch !== cell[1]) {\n            lines[y][xi][0] = dattr;\n            lines[y][xi][1] = ch;\n            lines[y].dirty = true;\n          }\n        }\n      }\n      cell = lines[y][xl - 1];\n      if (cell) {\n        if (this.border.right) {\n          if (this.border.type === 'line') {\n            ch = '\\u2502'; // '│'\n          } else if (this.border.type === 'bg') {\n            ch = this.border.ch;\n          }\n          if (!coords.noright)\n          if (battr !== cell[0] || ch !== cell[1]) {\n            lines[y][xl - 1][0] = battr;\n            lines[y][xl - 1][1] = ch;\n            lines[y].dirty = true;\n          }\n        } else {\n          ch = ' ';\n          if (dattr !== cell[0] || ch !== cell[1]) {\n            lines[y][xl - 1][0] = dattr;\n            lines[y][xl - 1][1] = ch;\n            lines[y].dirty = true;\n          }\n        }\n      }\n    }\n    y = yl - 1;\n    if (coords.nobot) y = -1;\n    for (x = xi; x < xl; x++) {\n      if (!lines[y]) break;\n      if (coords.noleft && x === xi) continue;\n      if (coords.noright && x === xl - 1) continue;\n      cell = lines[y][x];\n      if (!cell) continue;\n      if (this.border.type === 'line') {\n        if (x === xi) {\n          ch = '\\u2514'; // '└'\n          if (!this.border.left) {\n            if (this.border.bottom) {\n              ch = '\\u2500'; // '─'\n            } else {\n              continue;\n            }\n          } else {\n            if (!this.border.bottom) {\n              ch = '\\u2502'; // '│'\n            }\n          }\n        } else if (x === xl - 1) {\n          ch = '\\u2518'; // '┘'\n          if (!this.border.right) {\n            if (this.border.bottom) {\n              ch = '\\u2500'; // '─'\n            } else {\n              continue;\n            }\n          } else {\n            if (!this.border.bottom) {\n              ch = '\\u2502'; // '│'\n            }\n          }\n        } else {\n          ch = '\\u2500'; // '─'\n        }\n      } else if (this.border.type === 'bg') {\n        ch = this.border.ch;\n      }\n      if (!this.border.bottom && x !== xi && x !== xl - 1) {\n        ch = ' ';\n        if (dattr !== cell[0] || ch !== cell[1]) {\n          lines[y][x][0] = dattr;\n          lines[y][x][1] = ch;\n          lines[y].dirty = true;\n        }\n        continue;\n      }\n      if (battr !== cell[0] || ch !== cell[1]) {\n        lines[y][x][0] = battr;\n        lines[y][x][1] = ch;\n        lines[y].dirty = true;\n      }\n    }\n  }\n\n  if (this.shadow) {\n    // right\n    y = Math.max(yi + 1, 0);\n    for (; y < yl + 1; y++) {\n      if (!lines[y]) break;\n      x = xl;\n      for (; x < xl + 2; x++) {\n        if (!lines[y][x]) break;\n        // lines[y][x][0] = colors.blend(this.dattr, lines[y][x][0]);\n        lines[y][x][0] = colors.blend(lines[y][x][0]);\n        lines[y].dirty = true;\n      }\n    }\n    // bottom\n    y = yl;\n    for (; y < yl + 1; y++) {\n      if (!lines[y]) break;\n      for (x = Math.max(xi + 1, 0); x < xl; x++) {\n        if (!lines[y][x]) break;\n        // lines[y][x][0] = colors.blend(this.dattr, lines[y][x][0]);\n        lines[y][x][0] = colors.blend(lines[y][x][0]);\n        lines[y].dirty = true;\n      }\n    }\n  }\n\n  this.children.forEach(function(el) {\n    if (el.screen._ci !== -1) {\n      el.index = el.screen._ci++;\n    }\n    // if (el.screen._rendering) {\n    //   el._rendering = true;\n    // }\n    el.render();\n    // if (el.screen._rendering) {\n    //   el._rendering = false;\n    // }\n  });\n\n  this._emit('render', [coords]);\n\n  return coords;\n};\n\nElement.prototype._render = Element.prototype.render;\n\n/**\n * Content Methods\n */\n\nElement.prototype.insertLine = function(i, line) {\n  if (typeof line === 'string') line = line.split('\\n');\n\n  if (i !== i || i == null) {\n    i = this._clines.ftor.length;\n  }\n\n  i = Math.max(i, 0);\n\n  while (this._clines.fake.length < i) {\n    this._clines.fake.push('');\n    this._clines.ftor.push([this._clines.push('') - 1]);\n    this._clines.rtof(this._clines.fake.length - 1);\n  }\n\n  // NOTE: Could possibly compare the first and last ftor line numbers to see\n  // if they're the same, or if they fit in the visible region entirely.\n  var start = this._clines.length\n    , diff\n    , real;\n\n  if (i >= this._clines.ftor.length) {\n    real = this._clines.ftor[this._clines.ftor.length - 1];\n    real = real[real.length - 1] + 1;\n  } else {\n    real = this._clines.ftor[i][0];\n  }\n\n  for (var j = 0; j < line.length; j++) {\n    this._clines.fake.splice(i + j, 0, line[j]);\n  }\n\n  this.setContent(this._clines.fake.join('\\n'), true);\n\n  diff = this._clines.length - start;\n\n  if (diff > 0) {\n    var pos = this._getCoords();\n    if (!pos) return;\n\n    var height = pos.yl - pos.yi - this.iheight\n      , base = this.childBase || 0\n      , visible = real >= base && real - base < height;\n\n    if (pos && visible && this.screen.cleanSides(this)) {\n      this.screen.insertLine(diff,\n        pos.yi + this.itop + real - base,\n        pos.yi,\n        pos.yl - this.ibottom - 1);\n    }\n  }\n};\n\nElement.prototype.deleteLine = function(i, n) {\n  n = n || 1;\n\n  if (i !== i || i == null) {\n    i = this._clines.ftor.length - 1;\n  }\n\n  i = Math.max(i, 0);\n  i = Math.min(i, this._clines.ftor.length - 1);\n\n  // NOTE: Could possibly compare the first and last ftor line numbers to see\n  // if they're the same, or if they fit in the visible region entirely.\n  var start = this._clines.length\n    , diff\n    , real = this._clines.ftor[i][0];\n\n  while (n--) {\n    this._clines.fake.splice(i, 1);\n  }\n\n  this.setContent(this._clines.fake.join('\\n'), true);\n\n  diff = start - this._clines.length;\n\n  // XXX clearPos() without diff statement?\n  var height = 0;\n\n  if (diff > 0) {\n    var pos = this._getCoords();\n    if (!pos) return;\n\n    height = pos.yl - pos.yi - this.iheight;\n\n    var base = this.childBase || 0\n      , visible = real >= base && real - base < height;\n\n    if (pos && visible && this.screen.cleanSides(this)) {\n      this.screen.deleteLine(diff,\n        pos.yi + this.itop + real - base,\n        pos.yi,\n        pos.yl - this.ibottom - 1);\n    }\n  }\n\n  if (this._clines.length < height) {\n    this.clearPos();\n  }\n};\n\nElement.prototype.insertTop = function(line) {\n  var fake = this._clines.rtof[this.childBase || 0];\n  return this.insertLine(fake, line);\n};\n\nElement.prototype.insertBottom = function(line) {\n  var h = (this.childBase || 0) + this.height - this.iheight\n    , i = Math.min(h, this._clines.length)\n    , fake = this._clines.rtof[i - 1] + 1;\n\n  return this.insertLine(fake, line);\n};\n\nElement.prototype.deleteTop = function(n) {\n  var fake = this._clines.rtof[this.childBase || 0];\n  return this.deleteLine(fake, n);\n};\n\nElement.prototype.deleteBottom = function(n) {\n  var h = (this.childBase || 0) + this.height - 1 - this.iheight\n    , i = Math.min(h, this._clines.length - 1)\n    , fake = this._clines.rtof[i];\n\n  n = n || 1;\n\n  return this.deleteLine(fake - (n - 1), n);\n};\n\nElement.prototype.setLine = function(i, line) {\n  i = Math.max(i, 0);\n  while (this._clines.fake.length < i) {\n    this._clines.fake.push('');\n  }\n  this._clines.fake[i] = line;\n  return this.setContent(this._clines.fake.join('\\n'), true);\n};\n\nElement.prototype.setBaseLine = function(i, line) {\n  var fake = this._clines.rtof[this.childBase || 0];\n  return this.setLine(fake + i, line);\n};\n\nElement.prototype.getLine = function(i) {\n  i = Math.max(i, 0);\n  i = Math.min(i, this._clines.fake.length - 1);\n  return this._clines.fake[i];\n};\n\nElement.prototype.getBaseLine = function(i) {\n  var fake = this._clines.rtof[this.childBase || 0];\n  return this.getLine(fake + i);\n};\n\nElement.prototype.clearLine = function(i) {\n  i = Math.min(i, this._clines.fake.length - 1);\n  return this.setLine(i, '');\n};\n\nElement.prototype.clearBaseLine = function(i) {\n  var fake = this._clines.rtof[this.childBase || 0];\n  return this.clearLine(fake + i);\n};\n\nElement.prototype.unshiftLine = function(line) {\n  return this.insertLine(0, line);\n};\n\nElement.prototype.shiftLine = function(n) {\n  return this.deleteLine(0, n);\n};\n\nElement.prototype.pushLine = function(line) {\n  if (!this.content) return this.setLine(0, line);\n  return this.insertLine(this._clines.fake.length, line);\n};\n\nElement.prototype.popLine = function(n) {\n  return this.deleteLine(this._clines.fake.length - 1, n);\n};\n\nElement.prototype.getLines = function() {\n  return this._clines.fake.slice();\n};\n\nElement.prototype.getScreenLines = function() {\n  return this._clines.slice();\n};\n\nElement.prototype.strWidth = function(text) {\n  text = this.parseTags\n    ? helpers.stripTags(text)\n    : text;\n  return this.screen.fullUnicode\n    ? unicode.strWidth(text)\n    : helpers.dropUnicode(text).length;\n};\n\nElement.prototype.screenshot = function(xi, xl, yi, yl) {\n  xi = this.lpos.xi + this.ileft + (xi || 0);\n  if (xl != null) {\n    xl = this.lpos.xi + this.ileft + (xl || 0);\n  } else {\n    xl = this.lpos.xl - this.iright;\n  }\n  yi = this.lpos.yi + this.itop + (yi || 0);\n  if (yl != null) {\n    yl = this.lpos.yi + this.itop + (yl || 0);\n  } else {\n    yl = this.lpos.yl - this.ibottom;\n  }\n  return this.screen.screenshot(xi, xl, yi, yl);\n};\n\n/**\n * Expose\n */\n\nmodule.exports = Element;\n"]},"metadata":{},"sourceType":"script"}