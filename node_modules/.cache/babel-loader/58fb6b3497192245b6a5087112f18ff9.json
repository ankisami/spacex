{"ast":null,"code":"/**\n * overlayimage.js - w3m image element for blessed\n * Copyright (c) 2013-2015, Christopher Jeffrey and contributors (MIT License).\n * https://github.com/chjj/blessed\n */\n\n/**\n * Modules\n */\nvar fs = require('fs'),\n    cp = require('child_process');\n\nvar helpers = require('../helpers');\n\nvar Node = require('./node');\n\nvar Box = require('./box');\n/**\n * OverlayImage\n * Good example of w3mimgdisplay commands:\n * https://github.com/hut/ranger/blob/master/ranger/ext/img_display.py\n */\n\n\nfunction OverlayImage(options) {\n  var self = this;\n\n  if (!(this instanceof Node)) {\n    return new OverlayImage(options);\n  }\n\n  options = options || {};\n  Box.call(this, options);\n\n  if (options.w3m) {\n    OverlayImage.w3mdisplay = options.w3m;\n  }\n\n  if (OverlayImage.hasW3MDisplay == null) {\n    if (fs.existsSync(OverlayImage.w3mdisplay)) {\n      OverlayImage.hasW3MDisplay = true;\n    } else if (options.search !== false) {\n      var file = helpers.findFile('/usr', 'w3mimgdisplay') || helpers.findFile('/lib', 'w3mimgdisplay') || helpers.findFile('/bin', 'w3mimgdisplay');\n\n      if (file) {\n        OverlayImage.hasW3MDisplay = true;\n        OverlayImage.w3mdisplay = file;\n      } else {\n        OverlayImage.hasW3MDisplay = false;\n      }\n    }\n  }\n\n  this.on('hide', function () {\n    self._lastFile = self.file;\n    self.clearImage();\n  });\n  this.on('show', function () {\n    if (!self._lastFile) return;\n    self.setImage(self._lastFile);\n  });\n  this.on('detach', function () {\n    self._lastFile = self.file;\n    self.clearImage();\n  });\n  this.on('attach', function () {\n    if (!self._lastFile) return;\n    self.setImage(self._lastFile);\n  });\n  this.onScreenEvent('resize', function () {\n    self._needsRatio = true;\n  }); // Get images to overlap properly. Maybe not worth it:\n  // this.onScreenEvent('render', function() {\n  //   self.screen.program.flush();\n  //   if (!self._noImage) return;\n  //   function display(el, next) {\n  //     if (el.type === 'w3mimage' && el.file) {\n  //       el.setImage(el.file, next);\n  //     } else {\n  //       next();\n  //     }\n  //   }\n  //   function done(el) {\n  //     el.children.forEach(recurse);\n  //   }\n  //   function recurse(el) {\n  //     display(el, function() {\n  //       var pending = el.children.length;\n  //       el.children.forEach(function(el) {\n  //         display(el, function() {\n  //           if (!--pending) done(el);\n  //         });\n  //       });\n  //     });\n  //   }\n  //   recurse(self.screen);\n  // });\n\n  this.onScreenEvent('render', function () {\n    self.screen.program.flush();\n\n    if (!self._noImage) {\n      self.setImage(self.file);\n    }\n  });\n\n  if (this.options.file || this.options.img) {\n    this.setImage(this.options.file || this.options.img);\n  }\n}\n\nOverlayImage.prototype.__proto__ = Box.prototype;\nOverlayImage.prototype.type = 'overlayimage';\nOverlayImage.w3mdisplay = '/usr/lib/w3m/w3mimgdisplay';\n\nOverlayImage.prototype.spawn = function (file, args, opt, callback) {\n  var spawn = require('child_process').spawn,\n      ps;\n\n  opt = opt || {};\n  ps = spawn(file, args, opt);\n  ps.on('error', function (err) {\n    if (!callback) return;\n    return callback(err);\n  });\n  ps.on('exit', function (code) {\n    if (!callback) return;\n    if (code !== 0) return callback(new Error('Exit Code: ' + code));\n    return callback(null, code === 0);\n  });\n  return ps;\n};\n\nOverlayImage.prototype.setImage = function (img, callback) {\n  var self = this;\n\n  if (this._settingImage) {\n    this._queue = this._queue || [];\n\n    this._queue.push([img, callback]);\n\n    return;\n  }\n\n  this._settingImage = true;\n\n  var reset = function () {\n    self._settingImage = false;\n    self._queue = self._queue || [];\n\n    var item = self._queue.shift();\n\n    if (item) {\n      self.setImage(item[0], item[1]);\n    }\n  };\n\n  if (OverlayImage.hasW3MDisplay === false) {\n    reset();\n    if (!callback) return;\n    return callback(new Error('W3M Image Display not available.'));\n  }\n\n  if (!img) {\n    reset();\n    if (!callback) return;\n    return callback(new Error('No image.'));\n  }\n\n  this.file = img;\n  return this.getPixelRatio(function (err, ratio) {\n    if (err) {\n      reset();\n      if (!callback) return;\n      return callback(err);\n    }\n\n    return self.renderImage(img, ratio, function (err, success) {\n      if (err) {\n        reset();\n        if (!callback) return;\n        return callback(err);\n      }\n\n      if (self.shrink || self.options.autofit) {\n        delete self.shrink;\n        delete self.options.shrink;\n        self.options.autofit = true;\n        return self.imageSize(function (err, size) {\n          if (err) {\n            reset();\n            if (!callback) return;\n            return callback(err);\n          }\n\n          if (self._lastSize && ratio.tw === self._lastSize.tw && ratio.th === self._lastSize.th && size.width === self._lastSize.width && size.height === self._lastSize.height && self.aleft === self._lastSize.aleft && self.atop === self._lastSize.atop) {\n            reset();\n            if (!callback) return;\n            return callback(null, success);\n          }\n\n          self._lastSize = {\n            tw: ratio.tw,\n            th: ratio.th,\n            width: size.width,\n            height: size.height,\n            aleft: self.aleft,\n            atop: self.atop\n          };\n          self.position.width = size.width / ratio.tw | 0;\n          self.position.height = size.height / ratio.th | 0;\n          self._noImage = true;\n          self.screen.render();\n          self._noImage = false;\n          reset();\n          return self.renderImage(img, ratio, callback);\n        });\n      }\n\n      reset();\n      if (!callback) return;\n      return callback(null, success);\n    });\n  });\n};\n\nOverlayImage.prototype.renderImage = function (img, ratio, callback) {\n  var self = this;\n\n  if (cp.execSync) {\n    callback = callback || function (err, result) {\n      return result;\n    };\n\n    try {\n      return callback(null, this.renderImageSync(img, ratio));\n    } catch (e) {\n      return callback(e);\n    }\n  }\n\n  if (OverlayImage.hasW3MDisplay === false) {\n    if (!callback) return;\n    return callback(new Error('W3M Image Display not available.'));\n  }\n\n  if (!ratio) {\n    if (!callback) return;\n    return callback(new Error('No ratio.'));\n  } // clearImage unsets these:\n\n\n  var _file = self.file;\n  var _lastSize = self._lastSize;\n  return self.clearImage(function (err) {\n    if (err) return callback(err);\n    self.file = _file;\n    self._lastSize = _lastSize;\n    var opt = {\n      stdio: 'pipe',\n      env: process.env,\n      cwd: process.env.HOME\n    };\n    var ps = self.spawn(OverlayImage.w3mdisplay, [], opt, function (err, success) {\n      if (!callback) return;\n      return err ? callback(err) : callback(null, success);\n    });\n    var width = self.width * ratio.tw | 0,\n        height = self.height * ratio.th | 0,\n        aleft = self.aleft * ratio.tw | 0,\n        atop = self.atop * ratio.th | 0;\n    var input = '0;1;' + aleft + ';' + atop + ';' + width + ';' + height + ';;;;;' + img + '\\n4;\\n3;\\n';\n    self._props = {\n      aleft: aleft,\n      atop: atop,\n      width: width,\n      height: height\n    };\n    ps.stdin.write(input);\n    ps.stdin.end();\n  });\n};\n\nOverlayImage.prototype.clearImage = function (callback) {\n  if (cp.execSync) {\n    callback = callback || function (err, result) {\n      return result;\n    };\n\n    try {\n      return callback(null, this.clearImageSync());\n    } catch (e) {\n      return callback(e);\n    }\n  }\n\n  if (OverlayImage.hasW3MDisplay === false) {\n    if (!callback) return;\n    return callback(new Error('W3M Image Display not available.'));\n  }\n\n  if (!this._props) {\n    if (!callback) return;\n    return callback(null);\n  }\n\n  var opt = {\n    stdio: 'pipe',\n    env: process.env,\n    cwd: process.env.HOME\n  };\n  var ps = this.spawn(OverlayImage.w3mdisplay, [], opt, function (err, success) {\n    if (!callback) return;\n    return err ? callback(err) : callback(null, success);\n  });\n  var width = this._props.width + 2,\n      height = this._props.height + 2,\n      aleft = this._props.aleft,\n      atop = this._props.atop;\n\n  if (this._drag) {\n    aleft -= 10;\n    atop -= 10;\n    width += 10;\n    height += 10;\n  }\n\n  var input = '6;' + aleft + ';' + atop + ';' + width + ';' + height + '\\n4;\\n3;\\n';\n  delete this.file;\n  delete this._props;\n  delete this._lastSize;\n  ps.stdin.write(input);\n  ps.stdin.end();\n};\n\nOverlayImage.prototype.imageSize = function (callback) {\n  var img = this.file;\n\n  if (cp.execSync) {\n    callback = callback || function (err, result) {\n      return result;\n    };\n\n    try {\n      return callback(null, this.imageSizeSync());\n    } catch (e) {\n      return callback(e);\n    }\n  }\n\n  if (OverlayImage.hasW3MDisplay === false) {\n    if (!callback) return;\n    return callback(new Error('W3M Image Display not available.'));\n  }\n\n  if (!img) {\n    if (!callback) return;\n    return callback(new Error('No image.'));\n  }\n\n  var opt = {\n    stdio: 'pipe',\n    env: process.env,\n    cwd: process.env.HOME\n  };\n  var ps = this.spawn(OverlayImage.w3mdisplay, [], opt);\n  var buf = '';\n  ps.stdout.setEncoding('utf8');\n  ps.stdout.on('data', function (data) {\n    buf += data;\n  });\n  ps.on('error', function (err) {\n    if (!callback) return;\n    return callback(err);\n  });\n  ps.on('exit', function () {\n    if (!callback) return;\n    var size = buf.trim().split(/\\s+/);\n    return callback(null, {\n      raw: buf.trim(),\n      width: +size[0],\n      height: +size[1]\n    });\n  });\n  var input = '5;' + img + '\\n';\n  ps.stdin.write(input);\n  ps.stdin.end();\n};\n\nOverlayImage.prototype.termSize = function (callback) {\n  var self = this;\n\n  if (cp.execSync) {\n    callback = callback || function (err, result) {\n      return result;\n    };\n\n    try {\n      return callback(null, this.termSizeSync());\n    } catch (e) {\n      return callback(e);\n    }\n  }\n\n  if (OverlayImage.hasW3MDisplay === false) {\n    if (!callback) return;\n    return callback(new Error('W3M Image Display not available.'));\n  }\n\n  var opt = {\n    stdio: 'pipe',\n    env: process.env,\n    cwd: process.env.HOME\n  };\n  var ps = this.spawn(OverlayImage.w3mdisplay, ['-test'], opt);\n  var buf = '';\n  ps.stdout.setEncoding('utf8');\n  ps.stdout.on('data', function (data) {\n    buf += data;\n  });\n  ps.on('error', function (err) {\n    if (!callback) return;\n    return callback(err);\n  });\n  ps.on('exit', function () {\n    if (!callback) return;\n\n    if (!buf.trim()) {\n      // Bug: w3mimgdisplay will sometimes\n      // output nothing. Try again:\n      return self.termSize(callback);\n    }\n\n    var size = buf.trim().split(/\\s+/);\n    return callback(null, {\n      raw: buf.trim(),\n      width: +size[0],\n      height: +size[1]\n    });\n  });\n  ps.stdin.end();\n};\n\nOverlayImage.prototype.getPixelRatio = function (callback) {\n  var self = this;\n\n  if (cp.execSync) {\n    callback = callback || function (err, result) {\n      return result;\n    };\n\n    try {\n      return callback(null, this.getPixelRatioSync());\n    } catch (e) {\n      return callback(e);\n    }\n  } // XXX We could cache this, but sometimes it's better\n  // to recalculate to be pixel perfect.\n\n\n  if (this._ratio && !this._needsRatio) {\n    return callback(null, this._ratio);\n  }\n\n  return this.termSize(function (err, dimensions) {\n    if (err) return callback(err);\n    self._ratio = {\n      tw: dimensions.width / self.screen.width,\n      th: dimensions.height / self.screen.height\n    };\n    self._needsRatio = false;\n    return callback(null, self._ratio);\n  });\n};\n\nOverlayImage.prototype.renderImageSync = function (img, ratio) {\n  if (OverlayImage.hasW3MDisplay === false) {\n    throw new Error('W3M Image Display not available.');\n  }\n\n  if (!ratio) {\n    throw new Error('No ratio.');\n  } // clearImage unsets these:\n\n\n  var _file = this.file;\n  var _lastSize = this._lastSize;\n  this.clearImageSync();\n  this.file = _file;\n  this._lastSize = _lastSize;\n  var width = this.width * ratio.tw | 0,\n      height = this.height * ratio.th | 0,\n      aleft = this.aleft * ratio.tw | 0,\n      atop = this.atop * ratio.th | 0;\n  var input = '0;1;' + aleft + ';' + atop + ';' + width + ';' + height + ';;;;;' + img + '\\n4;\\n3;\\n';\n  this._props = {\n    aleft: aleft,\n    atop: atop,\n    width: width,\n    height: height\n  };\n\n  try {\n    cp.execFileSync(OverlayImage.w3mdisplay, [], {\n      env: process.env,\n      encoding: 'utf8',\n      input: input,\n      timeout: 1000\n    });\n  } catch (e) {\n    ;\n  }\n\n  return true;\n};\n\nOverlayImage.prototype.clearImageSync = function () {\n  if (OverlayImage.hasW3MDisplay === false) {\n    throw new Error('W3M Image Display not available.');\n  }\n\n  if (!this._props) {\n    return false;\n  }\n\n  var width = this._props.width + 2,\n      height = this._props.height + 2,\n      aleft = this._props.aleft,\n      atop = this._props.atop;\n\n  if (this._drag) {\n    aleft -= 10;\n    atop -= 10;\n    width += 10;\n    height += 10;\n  }\n\n  var input = '6;' + aleft + ';' + atop + ';' + width + ';' + height + '\\n4;\\n3;\\n';\n  delete this.file;\n  delete this._props;\n  delete this._lastSize;\n\n  try {\n    cp.execFileSync(OverlayImage.w3mdisplay, [], {\n      env: process.env,\n      encoding: 'utf8',\n      input: input,\n      timeout: 1000\n    });\n  } catch (e) {\n    ;\n  }\n\n  return true;\n};\n\nOverlayImage.prototype.imageSizeSync = function () {\n  var img = this.file;\n\n  if (OverlayImage.hasW3MDisplay === false) {\n    throw new Error('W3M Image Display not available.');\n  }\n\n  if (!img) {\n    throw new Error('No image.');\n  }\n\n  var buf = '';\n  var input = '5;' + img + '\\n';\n\n  try {\n    buf = cp.execFileSync(OverlayImage.w3mdisplay, [], {\n      env: process.env,\n      encoding: 'utf8',\n      input: input,\n      timeout: 1000\n    });\n  } catch (e) {\n    ;\n  }\n\n  var size = buf.trim().split(/\\s+/);\n  return {\n    raw: buf.trim(),\n    width: +size[0],\n    height: +size[1]\n  };\n};\n\nOverlayImage.prototype.termSizeSync = function (_, recurse) {\n  if (OverlayImage.hasW3MDisplay === false) {\n    throw new Error('W3M Image Display not available.');\n  }\n\n  var buf = '';\n\n  try {\n    buf = cp.execFileSync(OverlayImage.w3mdisplay, ['-test'], {\n      env: process.env,\n      encoding: 'utf8',\n      timeout: 1000\n    });\n  } catch (e) {\n    ;\n  }\n\n  if (!buf.trim()) {\n    // Bug: w3mimgdisplay will sometimes\n    // output nothing. Try again:\n    recurse = recurse || 0;\n\n    if (++recurse === 5) {\n      throw new Error('Term size not determined.');\n    }\n\n    return this.termSizeSync(_, recurse);\n  }\n\n  var size = buf.trim().split(/\\s+/);\n  return {\n    raw: buf.trim(),\n    width: +size[0],\n    height: +size[1]\n  };\n};\n\nOverlayImage.prototype.getPixelRatioSync = function () {\n  // XXX We could cache this, but sometimes it's better\n  // to recalculate to be pixel perfect.\n  if (this._ratio && !this._needsRatio) {\n    return this._ratio;\n  }\n\n  this._needsRatio = false;\n  var dimensions = this.termSizeSync();\n  this._ratio = {\n    tw: dimensions.width / this.screen.width,\n    th: dimensions.height / this.screen.height\n  };\n  return this._ratio;\n};\n\nOverlayImage.prototype.displayImage = function (callback) {\n  return this.screen.displayImage(this.file, callback);\n};\n/**\n * Expose\n */\n\n\nmodule.exports = OverlayImage;","map":{"version":3,"sources":["/Users/samianki/node_modules/blessed/lib/widgets/overlayimage.js"],"names":["fs","require","cp","helpers","Node","Box","OverlayImage","options","self","call","w3m","w3mdisplay","hasW3MDisplay","existsSync","search","file","findFile","on","_lastFile","clearImage","setImage","onScreenEvent","_needsRatio","screen","program","flush","_noImage","img","prototype","__proto__","type","spawn","args","opt","callback","ps","err","code","Error","_settingImage","_queue","push","reset","item","shift","getPixelRatio","ratio","renderImage","success","shrink","autofit","imageSize","size","_lastSize","tw","th","width","height","aleft","atop","position","render","execSync","result","renderImageSync","e","_file","stdio","env","process","cwd","HOME","input","_props","stdin","write","end","clearImageSync","_drag","imageSizeSync","buf","stdout","setEncoding","data","trim","split","raw","termSize","termSizeSync","getPixelRatioSync","_ratio","dimensions","execFileSync","encoding","timeout","_","recurse","displayImage","module","exports"],"mappings":"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","sourcesContent":["/**\n * overlayimage.js - w3m image element for blessed\n * Copyright (c) 2013-2015, Christopher Jeffrey and contributors (MIT License).\n * https://github.com/chjj/blessed\n */\n\n/**\n * Modules\n */\n\nvar fs = require('fs')\n  , cp = require('child_process');\n\nvar helpers = require('../helpers');\n\nvar Node = require('./node');\nvar Box = require('./box');\n\n/**\n * OverlayImage\n * Good example of w3mimgdisplay commands:\n * https://github.com/hut/ranger/blob/master/ranger/ext/img_display.py\n */\n\nfunction OverlayImage(options) {\n  var self = this;\n\n  if (!(this instanceof Node)) {\n    return new OverlayImage(options);\n  }\n\n  options = options || {};\n\n  Box.call(this, options);\n\n  if (options.w3m) {\n    OverlayImage.w3mdisplay = options.w3m;\n  }\n\n  if (OverlayImage.hasW3MDisplay == null) {\n    if (fs.existsSync(OverlayImage.w3mdisplay)) {\n      OverlayImage.hasW3MDisplay = true;\n    } else if (options.search !== false) {\n      var file = helpers.findFile('/usr', 'w3mimgdisplay')\n              || helpers.findFile('/lib', 'w3mimgdisplay')\n              || helpers.findFile('/bin', 'w3mimgdisplay');\n      if (file) {\n        OverlayImage.hasW3MDisplay = true;\n        OverlayImage.w3mdisplay = file;\n      } else {\n        OverlayImage.hasW3MDisplay = false;\n      }\n    }\n  }\n\n  this.on('hide', function() {\n    self._lastFile = self.file;\n    self.clearImage();\n  });\n\n  this.on('show', function() {\n    if (!self._lastFile) return;\n    self.setImage(self._lastFile);\n  });\n\n  this.on('detach', function() {\n    self._lastFile = self.file;\n    self.clearImage();\n  });\n\n  this.on('attach', function() {\n    if (!self._lastFile) return;\n    self.setImage(self._lastFile);\n  });\n\n  this.onScreenEvent('resize', function() {\n    self._needsRatio = true;\n  });\n\n  // Get images to overlap properly. Maybe not worth it:\n  // this.onScreenEvent('render', function() {\n  //   self.screen.program.flush();\n  //   if (!self._noImage) return;\n  //   function display(el, next) {\n  //     if (el.type === 'w3mimage' && el.file) {\n  //       el.setImage(el.file, next);\n  //     } else {\n  //       next();\n  //     }\n  //   }\n  //   function done(el) {\n  //     el.children.forEach(recurse);\n  //   }\n  //   function recurse(el) {\n  //     display(el, function() {\n  //       var pending = el.children.length;\n  //       el.children.forEach(function(el) {\n  //         display(el, function() {\n  //           if (!--pending) done(el);\n  //         });\n  //       });\n  //     });\n  //   }\n  //   recurse(self.screen);\n  // });\n\n  this.onScreenEvent('render', function() {\n    self.screen.program.flush();\n    if (!self._noImage) {\n      self.setImage(self.file);\n    }\n  });\n\n  if (this.options.file || this.options.img) {\n    this.setImage(this.options.file || this.options.img);\n  }\n}\n\nOverlayImage.prototype.__proto__ = Box.prototype;\n\nOverlayImage.prototype.type = 'overlayimage';\n\nOverlayImage.w3mdisplay = '/usr/lib/w3m/w3mimgdisplay';\n\nOverlayImage.prototype.spawn = function(file, args, opt, callback) {\n  var spawn = require('child_process').spawn\n    , ps;\n\n  opt = opt || {};\n  ps = spawn(file, args, opt);\n\n  ps.on('error', function(err) {\n    if (!callback) return;\n    return callback(err);\n  });\n\n  ps.on('exit', function(code) {\n    if (!callback) return;\n    if (code !== 0) return callback(new Error('Exit Code: ' + code));\n    return callback(null, code === 0);\n  });\n\n  return ps;\n};\n\nOverlayImage.prototype.setImage = function(img, callback) {\n  var self = this;\n\n  if (this._settingImage) {\n    this._queue = this._queue || [];\n    this._queue.push([img, callback]);\n    return;\n  }\n  this._settingImage = true;\n\n  var reset = function() {\n    self._settingImage = false;\n    self._queue = self._queue || [];\n    var item = self._queue.shift();\n    if (item) {\n      self.setImage(item[0], item[1]);\n    }\n  };\n\n  if (OverlayImage.hasW3MDisplay === false) {\n    reset();\n    if (!callback) return;\n    return callback(new Error('W3M Image Display not available.'));\n  }\n\n  if (!img) {\n    reset();\n    if (!callback) return;\n    return callback(new Error('No image.'));\n  }\n\n  this.file = img;\n\n  return this.getPixelRatio(function(err, ratio) {\n    if (err) {\n      reset();\n      if (!callback) return;\n      return callback(err);\n    }\n\n    return self.renderImage(img, ratio, function(err, success) {\n      if (err) {\n        reset();\n        if (!callback) return;\n        return callback(err);\n      }\n\n      if (self.shrink || self.options.autofit) {\n        delete self.shrink;\n        delete self.options.shrink;\n        self.options.autofit = true;\n        return self.imageSize(function(err, size) {\n          if (err) {\n            reset();\n            if (!callback) return;\n            return callback(err);\n          }\n\n          if (self._lastSize\n              && ratio.tw === self._lastSize.tw\n              && ratio.th === self._lastSize.th\n              && size.width === self._lastSize.width\n              && size.height === self._lastSize.height\n              && self.aleft === self._lastSize.aleft\n              && self.atop === self._lastSize.atop) {\n            reset();\n            if (!callback) return;\n            return callback(null, success);\n          }\n\n          self._lastSize = {\n            tw: ratio.tw,\n            th: ratio.th,\n            width: size.width,\n            height: size.height,\n            aleft: self.aleft,\n            atop: self.atop\n          };\n\n          self.position.width = size.width / ratio.tw | 0;\n          self.position.height = size.height / ratio.th | 0;\n\n          self._noImage = true;\n          self.screen.render();\n          self._noImage = false;\n\n          reset();\n          return self.renderImage(img, ratio, callback);\n        });\n      }\n\n      reset();\n      if (!callback) return;\n      return callback(null, success);\n    });\n  });\n};\n\nOverlayImage.prototype.renderImage = function(img, ratio, callback) {\n  var self = this;\n\n  if (cp.execSync) {\n    callback = callback || function(err, result) { return result; };\n    try {\n      return callback(null, this.renderImageSync(img, ratio));\n    } catch (e) {\n      return callback(e);\n    }\n  }\n\n  if (OverlayImage.hasW3MDisplay === false) {\n    if (!callback) return;\n    return callback(new Error('W3M Image Display not available.'));\n  }\n\n  if (!ratio) {\n    if (!callback) return;\n    return callback(new Error('No ratio.'));\n  }\n\n  // clearImage unsets these:\n  var _file = self.file;\n  var _lastSize = self._lastSize;\n  return self.clearImage(function(err) {\n    if (err) return callback(err);\n\n    self.file = _file;\n    self._lastSize = _lastSize;\n\n    var opt = {\n      stdio: 'pipe',\n      env: process.env,\n      cwd: process.env.HOME\n    };\n\n    var ps = self.spawn(OverlayImage.w3mdisplay, [], opt, function(err, success) {\n      if (!callback) return;\n      return err\n        ? callback(err)\n        : callback(null, success);\n    });\n\n    var width = self.width * ratio.tw | 0\n      , height = self.height * ratio.th | 0\n      , aleft = self.aleft * ratio.tw | 0\n      , atop = self.atop * ratio.th | 0;\n\n    var input = '0;1;'\n      + aleft + ';'\n      + atop + ';'\n      + width + ';'\n      + height + ';;;;;'\n      + img\n      + '\\n4;\\n3;\\n';\n\n    self._props = {\n      aleft: aleft,\n      atop: atop,\n      width: width,\n      height: height\n    };\n\n    ps.stdin.write(input);\n    ps.stdin.end();\n  });\n};\n\nOverlayImage.prototype.clearImage = function(callback) {\n  if (cp.execSync) {\n    callback = callback || function(err, result) { return result; };\n    try {\n      return callback(null, this.clearImageSync());\n    } catch (e) {\n      return callback(e);\n    }\n  }\n\n  if (OverlayImage.hasW3MDisplay === false) {\n    if (!callback) return;\n    return callback(new Error('W3M Image Display not available.'));\n  }\n\n  if (!this._props) {\n    if (!callback) return;\n    return callback(null);\n  }\n\n  var opt = {\n    stdio: 'pipe',\n    env: process.env,\n    cwd: process.env.HOME\n  };\n\n  var ps = this.spawn(OverlayImage.w3mdisplay, [], opt, function(err, success) {\n    if (!callback) return;\n    return err\n      ? callback(err)\n      : callback(null, success);\n  });\n\n  var width = this._props.width + 2\n    , height = this._props.height + 2\n    , aleft = this._props.aleft\n    , atop = this._props.atop;\n\n  if (this._drag) {\n    aleft -= 10;\n    atop -= 10;\n    width += 10;\n    height += 10;\n  }\n\n  var input = '6;'\n   + aleft + ';'\n   + atop + ';'\n   + width + ';'\n   + height\n   + '\\n4;\\n3;\\n';\n\n  delete this.file;\n  delete this._props;\n  delete this._lastSize;\n\n  ps.stdin.write(input);\n  ps.stdin.end();\n};\n\nOverlayImage.prototype.imageSize = function(callback) {\n  var img = this.file;\n\n  if (cp.execSync) {\n    callback = callback || function(err, result) { return result; };\n    try {\n      return callback(null, this.imageSizeSync());\n    } catch (e) {\n      return callback(e);\n    }\n  }\n\n  if (OverlayImage.hasW3MDisplay === false) {\n    if (!callback) return;\n    return callback(new Error('W3M Image Display not available.'));\n  }\n\n  if (!img) {\n    if (!callback) return;\n    return callback(new Error('No image.'));\n  }\n\n  var opt = {\n    stdio: 'pipe',\n    env: process.env,\n    cwd: process.env.HOME\n  };\n\n  var ps = this.spawn(OverlayImage.w3mdisplay, [], opt);\n\n  var buf = '';\n\n  ps.stdout.setEncoding('utf8');\n\n  ps.stdout.on('data', function(data) {\n    buf += data;\n  });\n\n  ps.on('error', function(err) {\n    if (!callback) return;\n    return callback(err);\n  });\n\n  ps.on('exit', function() {\n    if (!callback) return;\n    var size = buf.trim().split(/\\s+/);\n    return callback(null, {\n      raw: buf.trim(),\n      width: +size[0],\n      height: +size[1]\n    });\n  });\n\n  var input = '5;' + img + '\\n';\n\n  ps.stdin.write(input);\n  ps.stdin.end();\n};\n\nOverlayImage.prototype.termSize = function(callback) {\n  var self = this;\n\n  if (cp.execSync) {\n    callback = callback || function(err, result) { return result; };\n    try {\n      return callback(null, this.termSizeSync());\n    } catch (e) {\n      return callback(e);\n    }\n  }\n\n  if (OverlayImage.hasW3MDisplay === false) {\n    if (!callback) return;\n    return callback(new Error('W3M Image Display not available.'));\n  }\n\n  var opt = {\n    stdio: 'pipe',\n    env: process.env,\n    cwd: process.env.HOME\n  };\n\n  var ps = this.spawn(OverlayImage.w3mdisplay, ['-test'], opt);\n\n  var buf = '';\n\n  ps.stdout.setEncoding('utf8');\n\n  ps.stdout.on('data', function(data) {\n    buf += data;\n  });\n\n  ps.on('error', function(err) {\n    if (!callback) return;\n    return callback(err);\n  });\n\n  ps.on('exit', function() {\n    if (!callback) return;\n\n    if (!buf.trim()) {\n      // Bug: w3mimgdisplay will sometimes\n      // output nothing. Try again:\n      return self.termSize(callback);\n    }\n\n    var size = buf.trim().split(/\\s+/);\n\n    return callback(null, {\n      raw: buf.trim(),\n      width: +size[0],\n      height: +size[1]\n    });\n  });\n\n  ps.stdin.end();\n};\n\nOverlayImage.prototype.getPixelRatio = function(callback) {\n  var self = this;\n\n  if (cp.execSync) {\n    callback = callback || function(err, result) { return result; };\n    try {\n      return callback(null, this.getPixelRatioSync());\n    } catch (e) {\n      return callback(e);\n    }\n  }\n\n  // XXX We could cache this, but sometimes it's better\n  // to recalculate to be pixel perfect.\n  if (this._ratio && !this._needsRatio) {\n    return callback(null, this._ratio);\n  }\n\n  return this.termSize(function(err, dimensions) {\n    if (err) return callback(err);\n\n    self._ratio = {\n      tw: dimensions.width / self.screen.width,\n      th: dimensions.height / self.screen.height\n    };\n\n    self._needsRatio = false;\n\n    return callback(null, self._ratio);\n  });\n};\n\nOverlayImage.prototype.renderImageSync = function(img, ratio) {\n  if (OverlayImage.hasW3MDisplay === false) {\n    throw new Error('W3M Image Display not available.');\n  }\n\n  if (!ratio) {\n    throw new Error('No ratio.');\n  }\n\n  // clearImage unsets these:\n  var _file = this.file;\n  var _lastSize = this._lastSize;\n\n  this.clearImageSync();\n\n  this.file = _file;\n  this._lastSize = _lastSize;\n\n  var width = this.width * ratio.tw | 0\n    , height = this.height * ratio.th | 0\n    , aleft = this.aleft * ratio.tw | 0\n    , atop = this.atop * ratio.th | 0;\n\n  var input = '0;1;'\n    + aleft + ';'\n    + atop + ';'\n    + width + ';'\n    + height + ';;;;;'\n    + img\n    + '\\n4;\\n3;\\n';\n\n  this._props = {\n    aleft: aleft,\n    atop: atop,\n    width: width,\n    height: height\n  };\n\n  try {\n    cp.execFileSync(OverlayImage.w3mdisplay, [], {\n      env: process.env,\n      encoding: 'utf8',\n      input: input,\n      timeout: 1000\n    });\n  } catch (e) {\n    ;\n  }\n\n  return true;\n};\n\nOverlayImage.prototype.clearImageSync = function() {\n  if (OverlayImage.hasW3MDisplay === false) {\n    throw new Error('W3M Image Display not available.');\n  }\n\n  if (!this._props) {\n    return false;\n  }\n\n  var width = this._props.width + 2\n    , height = this._props.height + 2\n    , aleft = this._props.aleft\n    , atop = this._props.atop;\n\n  if (this._drag) {\n    aleft -= 10;\n    atop -= 10;\n    width += 10;\n    height += 10;\n  }\n\n  var input = '6;'\n   + aleft + ';'\n   + atop + ';'\n   + width + ';'\n   + height\n   + '\\n4;\\n3;\\n';\n\n  delete this.file;\n  delete this._props;\n  delete this._lastSize;\n\n  try {\n    cp.execFileSync(OverlayImage.w3mdisplay, [], {\n      env: process.env,\n      encoding: 'utf8',\n      input: input,\n      timeout: 1000\n    });\n  } catch (e) {\n    ;\n  }\n\n  return true;\n};\n\nOverlayImage.prototype.imageSizeSync = function() {\n  var img = this.file;\n\n  if (OverlayImage.hasW3MDisplay === false) {\n    throw new Error('W3M Image Display not available.');\n  }\n\n  if (!img) {\n    throw new Error('No image.');\n  }\n\n  var buf = '';\n  var input = '5;' + img + '\\n';\n\n  try {\n    buf = cp.execFileSync(OverlayImage.w3mdisplay, [], {\n      env: process.env,\n      encoding: 'utf8',\n      input: input,\n      timeout: 1000\n    });\n  } catch (e) {\n    ;\n  }\n\n  var size = buf.trim().split(/\\s+/);\n\n  return {\n    raw: buf.trim(),\n    width: +size[0],\n    height: +size[1]\n  };\n};\n\nOverlayImage.prototype.termSizeSync = function(_, recurse) {\n  if (OverlayImage.hasW3MDisplay === false) {\n    throw new Error('W3M Image Display not available.');\n  }\n\n  var buf = '';\n\n  try {\n    buf = cp.execFileSync(OverlayImage.w3mdisplay, ['-test'], {\n      env: process.env,\n      encoding: 'utf8',\n      timeout: 1000\n    });\n  } catch (e) {\n    ;\n  }\n\n  if (!buf.trim()) {\n    // Bug: w3mimgdisplay will sometimes\n    // output nothing. Try again:\n    recurse = recurse || 0;\n    if (++recurse === 5) {\n      throw new Error('Term size not determined.');\n    }\n    return this.termSizeSync(_, recurse);\n  }\n\n  var size = buf.trim().split(/\\s+/);\n\n  return {\n    raw: buf.trim(),\n    width: +size[0],\n    height: +size[1]\n  };\n};\n\nOverlayImage.prototype.getPixelRatioSync = function() {\n  // XXX We could cache this, but sometimes it's better\n  // to recalculate to be pixel perfect.\n  if (this._ratio && !this._needsRatio) {\n    return this._ratio;\n  }\n  this._needsRatio = false;\n\n  var dimensions = this.termSizeSync();\n\n  this._ratio = {\n    tw: dimensions.width / this.screen.width,\n    th: dimensions.height / this.screen.height\n  };\n\n  return this._ratio;\n};\n\nOverlayImage.prototype.displayImage = function(callback) {\n  return this.screen.displayImage(this.file, callback);\n};\n\n/**\n * Expose\n */\n\nmodule.exports = OverlayImage;\n"]},"metadata":{},"sourceType":"script"}