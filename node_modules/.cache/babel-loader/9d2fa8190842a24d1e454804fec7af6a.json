{"ast":null,"code":"/**\n * scrollablebox.js - scrollable box element for blessed\n * Copyright (c) 2013-2015, Christopher Jeffrey and contributors (MIT License).\n * https://github.com/chjj/blessed\n */\n\n/**\n * Modules\n */\nvar Node = require('./node');\n\nvar Box = require('./box');\n/**\n * ScrollableBox\n */\n\n\nfunction ScrollableBox(options) {\n  var self = this;\n\n  if (!(this instanceof Node)) {\n    return new ScrollableBox(options);\n  }\n\n  options = options || {};\n  Box.call(this, options);\n\n  if (options.scrollable === false) {\n    return this;\n  }\n\n  this.scrollable = true;\n  this.childOffset = 0;\n  this.childBase = 0;\n  this.baseLimit = options.baseLimit || Infinity;\n  this.alwaysScroll = options.alwaysScroll;\n  this.scrollbar = options.scrollbar;\n\n  if (this.scrollbar) {\n    this.scrollbar.ch = this.scrollbar.ch || ' ';\n    this.style.scrollbar = this.style.scrollbar || this.scrollbar.style;\n\n    if (!this.style.scrollbar) {\n      this.style.scrollbar = {};\n      this.style.scrollbar.fg = this.scrollbar.fg;\n      this.style.scrollbar.bg = this.scrollbar.bg;\n      this.style.scrollbar.bold = this.scrollbar.bold;\n      this.style.scrollbar.underline = this.scrollbar.underline;\n      this.style.scrollbar.inverse = this.scrollbar.inverse;\n      this.style.scrollbar.invisible = this.scrollbar.invisible;\n    } //this.scrollbar.style = this.style.scrollbar;\n\n\n    if (this.track || this.scrollbar.track) {\n      this.track = this.scrollbar.track || this.track;\n      this.style.track = this.style.scrollbar.track || this.style.track;\n      this.track.ch = this.track.ch || ' ';\n      this.style.track = this.style.track || this.track.style;\n\n      if (!this.style.track) {\n        this.style.track = {};\n        this.style.track.fg = this.track.fg;\n        this.style.track.bg = this.track.bg;\n        this.style.track.bold = this.track.bold;\n        this.style.track.underline = this.track.underline;\n        this.style.track.inverse = this.track.inverse;\n        this.style.track.invisible = this.track.invisible;\n      }\n\n      this.track.style = this.style.track;\n    } // Allow controlling of the scrollbar via the mouse:\n\n\n    if (options.mouse) {\n      this.on('mousedown', function (data) {\n        if (self._scrollingBar) {\n          // Do not allow dragging on the scrollbar:\n          delete self.screen._dragging;\n          delete self._drag;\n          return;\n        }\n\n        var x = data.x - self.aleft;\n        var y = data.y - self.atop;\n\n        if (x === self.width - self.iright - 1) {\n          // Do not allow dragging on the scrollbar:\n          delete self.screen._dragging;\n          delete self._drag;\n          var perc = (y - self.itop) / (self.height - self.iheight);\n          self.setScrollPerc(perc * 100 | 0);\n          self.screen.render();\n          var smd, smu;\n          self._scrollingBar = true;\n          self.onScreenEvent('mousedown', smd = function (data) {\n            var y = data.y - self.atop;\n            var perc = y / self.height;\n            self.setScrollPerc(perc * 100 | 0);\n            self.screen.render();\n          }); // If mouseup occurs out of the window, no mouseup event fires, and\n          // scrollbar will drag again on mousedown until another mouseup\n          // occurs.\n\n          self.onScreenEvent('mouseup', smu = function () {\n            self._scrollingBar = false;\n            self.removeScreenEvent('mousedown', smd);\n            self.removeScreenEvent('mouseup', smu);\n          });\n        }\n      });\n    }\n  }\n\n  if (options.mouse) {\n    this.on('wheeldown', function () {\n      self.scroll(self.height / 2 | 0 || 1);\n      self.screen.render();\n    });\n    this.on('wheelup', function () {\n      self.scroll(-(self.height / 2 | 0) || -1);\n      self.screen.render();\n    });\n  }\n\n  if (options.keys && !options.ignoreKeys) {\n    this.on('keypress', function (ch, key) {\n      if (key.name === 'up' || options.vi && key.name === 'k') {\n        self.scroll(-1);\n        self.screen.render();\n        return;\n      }\n\n      if (key.name === 'down' || options.vi && key.name === 'j') {\n        self.scroll(1);\n        self.screen.render();\n        return;\n      }\n\n      if (options.vi && key.name === 'u' && key.ctrl) {\n        self.scroll(-(self.height / 2 | 0) || -1);\n        self.screen.render();\n        return;\n      }\n\n      if (options.vi && key.name === 'd' && key.ctrl) {\n        self.scroll(self.height / 2 | 0 || 1);\n        self.screen.render();\n        return;\n      }\n\n      if (options.vi && key.name === 'b' && key.ctrl) {\n        self.scroll(-self.height || -1);\n        self.screen.render();\n        return;\n      }\n\n      if (options.vi && key.name === 'f' && key.ctrl) {\n        self.scroll(self.height || 1);\n        self.screen.render();\n        return;\n      }\n\n      if (options.vi && key.name === 'g' && !key.shift) {\n        self.scrollTo(0);\n        self.screen.render();\n        return;\n      }\n\n      if (options.vi && key.name === 'g' && key.shift) {\n        self.scrollTo(self.getScrollHeight());\n        self.screen.render();\n        return;\n      }\n    });\n  }\n\n  this.on('parsed content', function () {\n    self._recalculateIndex();\n  });\n\n  self._recalculateIndex();\n}\n\nScrollableBox.prototype.__proto__ = Box.prototype;\nScrollableBox.prototype.type = 'scrollable-box'; // XXX Potentially use this in place of scrollable checks elsewhere.\n\nScrollableBox.prototype.__defineGetter__('reallyScrollable', function () {\n  if (this.shrink) return this.scrollable;\n  return this.getScrollHeight() > this.height;\n});\n\nScrollableBox.prototype._scrollBottom = function () {\n  if (!this.scrollable) return 0; // We could just calculate the children, but we can\n  // optimize for lists by just returning the items.length.\n\n  if (this._isList) {\n    return this.items ? this.items.length : 0;\n  }\n\n  if (this.lpos && this.lpos._scrollBottom) {\n    return this.lpos._scrollBottom;\n  }\n\n  var bottom = this.children.reduce(function (current, el) {\n    // el.height alone does not calculate the shrunken height, we need to use\n    // getCoords. A shrunken box inside a scrollable element will not grow any\n    // larger than the scrollable element's context regardless of how much\n    // content is in the shrunken box, unless we do this (call getCoords\n    // without the scrollable calculation):\n    // See: $ node test/widget-shrink-fail-2.js\n    if (!el.detached) {\n      var lpos = el._getCoords(false, true);\n\n      if (lpos) {\n        return Math.max(current, el.rtop + (lpos.yl - lpos.yi));\n      }\n    }\n\n    return Math.max(current, el.rtop + el.height);\n  }, 0); // XXX Use this? Makes .getScrollHeight() useless!\n  // if (bottom < this._clines.length) bottom = this._clines.length;\n\n  if (this.lpos) this.lpos._scrollBottom = bottom;\n  return bottom;\n};\n\nScrollableBox.prototype.setScroll = ScrollableBox.prototype.scrollTo = function (offset, always) {\n  // XXX\n  // At first, this appeared to account for the first new calculation of childBase:\n  this.scroll(0);\n  return this.scroll(offset - (this.childBase + this.childOffset), always);\n};\n\nScrollableBox.prototype.getScroll = function () {\n  return this.childBase + this.childOffset;\n};\n\nScrollableBox.prototype.scroll = function (offset, always) {\n  if (!this.scrollable) return;\n  if (this.detached) return; // Handle scrolling.\n\n  var visible = this.height - this.iheight,\n      base = this.childBase,\n      d,\n      p,\n      t,\n      b,\n      max,\n      emax;\n\n  if (this.alwaysScroll || always) {\n    // Semi-workaround\n    this.childOffset = offset > 0 ? visible - 1 + offset : offset;\n  } else {\n    this.childOffset += offset;\n  }\n\n  if (this.childOffset > visible - 1) {\n    d = this.childOffset - (visible - 1);\n    this.childOffset -= d;\n    this.childBase += d;\n  } else if (this.childOffset < 0) {\n    d = this.childOffset;\n    this.childOffset += -d;\n    this.childBase += d;\n  }\n\n  if (this.childBase < 0) {\n    this.childBase = 0;\n  } else if (this.childBase > this.baseLimit) {\n    this.childBase = this.baseLimit;\n  } // Find max \"bottom\" value for\n  // content and descendant elements.\n  // Scroll the content if necessary.\n\n\n  if (this.childBase === base) {\n    return this.emit('scroll');\n  } // When scrolling text, we want to be able to handle SGR codes as well as line\n  // feeds. This allows us to take preformatted text output from other programs\n  // and put it in a scrollable text box.\n\n\n  this.parseContent(); // XXX\n  // max = this.getScrollHeight() - (this.height - this.iheight);\n\n  max = this._clines.length - (this.height - this.iheight);\n  if (max < 0) max = 0;\n  emax = this._scrollBottom() - (this.height - this.iheight);\n  if (emax < 0) emax = 0;\n  this.childBase = Math.min(this.childBase, Math.max(emax, max));\n\n  if (this.childBase < 0) {\n    this.childBase = 0;\n  } else if (this.childBase > this.baseLimit) {\n    this.childBase = this.baseLimit;\n  } // Optimize scrolling with CSR + IL/DL.\n\n\n  p = this.lpos; // Only really need _getCoords() if we want\n  // to allow nestable scrolling elements...\n  // or if we **really** want shrinkable\n  // scrolling elements.\n  // p = this._getCoords();\n\n  if (p && this.childBase !== base && this.screen.cleanSides(this)) {\n    t = p.yi + this.itop;\n    b = p.yl - this.ibottom - 1;\n    d = this.childBase - base;\n\n    if (d > 0 && d < visible) {\n      // scrolled down\n      this.screen.deleteLine(d, t, t, b);\n    } else if (d < 0 && -d < visible) {\n      // scrolled up\n      d = -d;\n      this.screen.insertLine(d, t, t, b);\n    }\n  }\n\n  return this.emit('scroll');\n};\n\nScrollableBox.prototype._recalculateIndex = function () {\n  var max, emax;\n\n  if (this.detached || !this.scrollable) {\n    return 0;\n  } // XXX\n  // max = this.getScrollHeight() - (this.height - this.iheight);\n\n\n  max = this._clines.length - (this.height - this.iheight);\n  if (max < 0) max = 0;\n  emax = this._scrollBottom() - (this.height - this.iheight);\n  if (emax < 0) emax = 0;\n  this.childBase = Math.min(this.childBase, Math.max(emax, max));\n\n  if (this.childBase < 0) {\n    this.childBase = 0;\n  } else if (this.childBase > this.baseLimit) {\n    this.childBase = this.baseLimit;\n  }\n};\n\nScrollableBox.prototype.resetScroll = function () {\n  if (!this.scrollable) return;\n  this.childOffset = 0;\n  this.childBase = 0;\n  return this.emit('scroll');\n};\n\nScrollableBox.prototype.getScrollHeight = function () {\n  return Math.max(this._clines.length, this._scrollBottom());\n};\n\nScrollableBox.prototype.getScrollPerc = function (s) {\n  var pos = this.lpos || this._getCoords();\n\n  if (!pos) return s ? -1 : 0;\n  var height = pos.yl - pos.yi - this.iheight,\n      i = this.getScrollHeight(),\n      p;\n\n  if (height < i) {\n    if (this.alwaysScroll) {\n      p = this.childBase / (i - height);\n    } else {\n      p = (this.childBase + this.childOffset) / (i - 1);\n    }\n\n    return p * 100;\n  }\n\n  return s ? -1 : 0;\n};\n\nScrollableBox.prototype.setScrollPerc = function (i) {\n  // XXX\n  // var m = this.getScrollHeight();\n  var m = Math.max(this._clines.length, this._scrollBottom());\n  return this.scrollTo(i / 100 * m | 0);\n};\n/**\n * Expose\n */\n\n\nmodule.exports = ScrollableBox;","map":{"version":3,"sources":["/Users/samianki/node_modules/blessed/lib/widgets/scrollablebox.js"],"names":["Node","require","Box","ScrollableBox","options","self","call","scrollable","childOffset","childBase","baseLimit","Infinity","alwaysScroll","scrollbar","ch","style","fg","bg","bold","underline","inverse","invisible","track","mouse","on","data","_scrollingBar","screen","_dragging","_drag","x","aleft","y","atop","width","iright","perc","itop","height","iheight","setScrollPerc","render","smd","smu","onScreenEvent","removeScreenEvent","scroll","keys","ignoreKeys","key","name","vi","ctrl","shift","scrollTo","getScrollHeight","_recalculateIndex","prototype","__proto__","type","__defineGetter__","shrink","_scrollBottom","_isList","items","length","lpos","bottom","children","reduce","current","el","detached","_getCoords","Math","max","rtop","yl","yi","setScroll","offset","always","getScroll","visible","base","d","p","t","b","emax","emit","parseContent","_clines","min","cleanSides","ibottom","deleteLine","insertLine","resetScroll","getScrollPerc","s","pos","i","m","module","exports"],"mappings":"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","sourcesContent":["/**\n * scrollablebox.js - scrollable box element for blessed\n * Copyright (c) 2013-2015, Christopher Jeffrey and contributors (MIT License).\n * https://github.com/chjj/blessed\n */\n\n/**\n * Modules\n */\n\nvar Node = require('./node');\nvar Box = require('./box');\n\n/**\n * ScrollableBox\n */\n\nfunction ScrollableBox(options) {\n  var self = this;\n\n  if (!(this instanceof Node)) {\n    return new ScrollableBox(options);\n  }\n\n  options = options || {};\n\n  Box.call(this, options);\n\n  if (options.scrollable === false) {\n    return this;\n  }\n\n  this.scrollable = true;\n  this.childOffset = 0;\n  this.childBase = 0;\n  this.baseLimit = options.baseLimit || Infinity;\n  this.alwaysScroll = options.alwaysScroll;\n\n  this.scrollbar = options.scrollbar;\n  if (this.scrollbar) {\n    this.scrollbar.ch = this.scrollbar.ch || ' ';\n    this.style.scrollbar = this.style.scrollbar || this.scrollbar.style;\n    if (!this.style.scrollbar) {\n      this.style.scrollbar = {};\n      this.style.scrollbar.fg = this.scrollbar.fg;\n      this.style.scrollbar.bg = this.scrollbar.bg;\n      this.style.scrollbar.bold = this.scrollbar.bold;\n      this.style.scrollbar.underline = this.scrollbar.underline;\n      this.style.scrollbar.inverse = this.scrollbar.inverse;\n      this.style.scrollbar.invisible = this.scrollbar.invisible;\n    }\n    //this.scrollbar.style = this.style.scrollbar;\n    if (this.track || this.scrollbar.track) {\n      this.track = this.scrollbar.track || this.track;\n      this.style.track = this.style.scrollbar.track || this.style.track;\n      this.track.ch = this.track.ch || ' ';\n      this.style.track = this.style.track || this.track.style;\n      if (!this.style.track) {\n        this.style.track = {};\n        this.style.track.fg = this.track.fg;\n        this.style.track.bg = this.track.bg;\n        this.style.track.bold = this.track.bold;\n        this.style.track.underline = this.track.underline;\n        this.style.track.inverse = this.track.inverse;\n        this.style.track.invisible = this.track.invisible;\n      }\n      this.track.style = this.style.track;\n    }\n    // Allow controlling of the scrollbar via the mouse:\n    if (options.mouse) {\n      this.on('mousedown', function(data) {\n        if (self._scrollingBar) {\n          // Do not allow dragging on the scrollbar:\n          delete self.screen._dragging;\n          delete self._drag;\n          return;\n        }\n        var x = data.x - self.aleft;\n        var y = data.y - self.atop;\n        if (x === self.width - self.iright - 1) {\n          // Do not allow dragging on the scrollbar:\n          delete self.screen._dragging;\n          delete self._drag;\n          var perc = (y - self.itop) / (self.height - self.iheight);\n          self.setScrollPerc(perc * 100 | 0);\n          self.screen.render();\n          var smd, smu;\n          self._scrollingBar = true;\n          self.onScreenEvent('mousedown', smd = function(data) {\n            var y = data.y - self.atop;\n            var perc = y / self.height;\n            self.setScrollPerc(perc * 100 | 0);\n            self.screen.render();\n          });\n          // If mouseup occurs out of the window, no mouseup event fires, and\n          // scrollbar will drag again on mousedown until another mouseup\n          // occurs.\n          self.onScreenEvent('mouseup', smu = function() {\n            self._scrollingBar = false;\n            self.removeScreenEvent('mousedown', smd);\n            self.removeScreenEvent('mouseup', smu);\n          });\n        }\n      });\n    }\n  }\n\n  if (options.mouse) {\n    this.on('wheeldown', function() {\n      self.scroll(self.height / 2 | 0 || 1);\n      self.screen.render();\n    });\n    this.on('wheelup', function() {\n      self.scroll(-(self.height / 2 | 0) || -1);\n      self.screen.render();\n    });\n  }\n\n  if (options.keys && !options.ignoreKeys) {\n    this.on('keypress', function(ch, key) {\n      if (key.name === 'up' || (options.vi && key.name === 'k')) {\n        self.scroll(-1);\n        self.screen.render();\n        return;\n      }\n      if (key.name === 'down' || (options.vi && key.name === 'j')) {\n        self.scroll(1);\n        self.screen.render();\n        return;\n      }\n      if (options.vi && key.name === 'u' && key.ctrl) {\n        self.scroll(-(self.height / 2 | 0) || -1);\n        self.screen.render();\n        return;\n      }\n      if (options.vi && key.name === 'd' && key.ctrl) {\n        self.scroll(self.height / 2 | 0 || 1);\n        self.screen.render();\n        return;\n      }\n      if (options.vi && key.name === 'b' && key.ctrl) {\n        self.scroll(-self.height || -1);\n        self.screen.render();\n        return;\n      }\n      if (options.vi && key.name === 'f' && key.ctrl) {\n        self.scroll(self.height || 1);\n        self.screen.render();\n        return;\n      }\n      if (options.vi && key.name === 'g' && !key.shift) {\n        self.scrollTo(0);\n        self.screen.render();\n        return;\n      }\n      if (options.vi && key.name === 'g' && key.shift) {\n        self.scrollTo(self.getScrollHeight());\n        self.screen.render();\n        return;\n      }\n    });\n  }\n\n  this.on('parsed content', function() {\n    self._recalculateIndex();\n  });\n\n  self._recalculateIndex();\n}\n\nScrollableBox.prototype.__proto__ = Box.prototype;\n\nScrollableBox.prototype.type = 'scrollable-box';\n\n// XXX Potentially use this in place of scrollable checks elsewhere.\nScrollableBox.prototype.__defineGetter__('reallyScrollable', function() {\n  if (this.shrink) return this.scrollable;\n  return this.getScrollHeight() > this.height;\n});\n\nScrollableBox.prototype._scrollBottom = function() {\n  if (!this.scrollable) return 0;\n\n  // We could just calculate the children, but we can\n  // optimize for lists by just returning the items.length.\n  if (this._isList) {\n    return this.items ? this.items.length : 0;\n  }\n\n  if (this.lpos && this.lpos._scrollBottom) {\n    return this.lpos._scrollBottom;\n  }\n\n  var bottom = this.children.reduce(function(current, el) {\n    // el.height alone does not calculate the shrunken height, we need to use\n    // getCoords. A shrunken box inside a scrollable element will not grow any\n    // larger than the scrollable element's context regardless of how much\n    // content is in the shrunken box, unless we do this (call getCoords\n    // without the scrollable calculation):\n    // See: $ node test/widget-shrink-fail-2.js\n    if (!el.detached) {\n      var lpos = el._getCoords(false, true);\n      if (lpos) {\n        return Math.max(current, el.rtop + (lpos.yl - lpos.yi));\n      }\n    }\n    return Math.max(current, el.rtop + el.height);\n  }, 0);\n\n  // XXX Use this? Makes .getScrollHeight() useless!\n  // if (bottom < this._clines.length) bottom = this._clines.length;\n\n  if (this.lpos) this.lpos._scrollBottom = bottom;\n\n  return bottom;\n};\n\nScrollableBox.prototype.setScroll =\nScrollableBox.prototype.scrollTo = function(offset, always) {\n  // XXX\n  // At first, this appeared to account for the first new calculation of childBase:\n  this.scroll(0);\n  return this.scroll(offset - (this.childBase + this.childOffset), always);\n};\n\nScrollableBox.prototype.getScroll = function() {\n  return this.childBase + this.childOffset;\n};\n\nScrollableBox.prototype.scroll = function(offset, always) {\n  if (!this.scrollable) return;\n\n  if (this.detached) return;\n\n  // Handle scrolling.\n  var visible = this.height - this.iheight\n    , base = this.childBase\n    , d\n    , p\n    , t\n    , b\n    , max\n    , emax;\n\n  if (this.alwaysScroll || always) {\n    // Semi-workaround\n    this.childOffset = offset > 0\n      ? visible - 1 + offset\n      : offset;\n  } else {\n    this.childOffset += offset;\n  }\n\n  if (this.childOffset > visible - 1) {\n    d = this.childOffset - (visible - 1);\n    this.childOffset -= d;\n    this.childBase += d;\n  } else if (this.childOffset < 0) {\n    d = this.childOffset;\n    this.childOffset += -d;\n    this.childBase += d;\n  }\n\n  if (this.childBase < 0) {\n    this.childBase = 0;\n  } else if (this.childBase > this.baseLimit) {\n    this.childBase = this.baseLimit;\n  }\n\n  // Find max \"bottom\" value for\n  // content and descendant elements.\n  // Scroll the content if necessary.\n  if (this.childBase === base) {\n    return this.emit('scroll');\n  }\n\n  // When scrolling text, we want to be able to handle SGR codes as well as line\n  // feeds. This allows us to take preformatted text output from other programs\n  // and put it in a scrollable text box.\n  this.parseContent();\n\n  // XXX\n  // max = this.getScrollHeight() - (this.height - this.iheight);\n\n  max = this._clines.length - (this.height - this.iheight);\n  if (max < 0) max = 0;\n  emax = this._scrollBottom() - (this.height - this.iheight);\n  if (emax < 0) emax = 0;\n\n  this.childBase = Math.min(this.childBase, Math.max(emax, max));\n\n  if (this.childBase < 0) {\n    this.childBase = 0;\n  } else if (this.childBase > this.baseLimit) {\n    this.childBase = this.baseLimit;\n  }\n\n  // Optimize scrolling with CSR + IL/DL.\n  p = this.lpos;\n  // Only really need _getCoords() if we want\n  // to allow nestable scrolling elements...\n  // or if we **really** want shrinkable\n  // scrolling elements.\n  // p = this._getCoords();\n  if (p && this.childBase !== base && this.screen.cleanSides(this)) {\n    t = p.yi + this.itop;\n    b = p.yl - this.ibottom - 1;\n    d = this.childBase - base;\n\n    if (d > 0 && d < visible) {\n      // scrolled down\n      this.screen.deleteLine(d, t, t, b);\n    } else if (d < 0 && -d < visible) {\n      // scrolled up\n      d = -d;\n      this.screen.insertLine(d, t, t, b);\n    }\n  }\n\n  return this.emit('scroll');\n};\n\nScrollableBox.prototype._recalculateIndex = function() {\n  var max, emax;\n\n  if (this.detached || !this.scrollable) {\n    return 0;\n  }\n\n  // XXX\n  // max = this.getScrollHeight() - (this.height - this.iheight);\n\n  max = this._clines.length - (this.height - this.iheight);\n  if (max < 0) max = 0;\n  emax = this._scrollBottom() - (this.height - this.iheight);\n  if (emax < 0) emax = 0;\n\n  this.childBase = Math.min(this.childBase, Math.max(emax, max));\n\n  if (this.childBase < 0) {\n    this.childBase = 0;\n  } else if (this.childBase > this.baseLimit) {\n    this.childBase = this.baseLimit;\n  }\n};\n\nScrollableBox.prototype.resetScroll = function() {\n  if (!this.scrollable) return;\n  this.childOffset = 0;\n  this.childBase = 0;\n  return this.emit('scroll');\n};\n\nScrollableBox.prototype.getScrollHeight = function() {\n  return Math.max(this._clines.length, this._scrollBottom());\n};\n\nScrollableBox.prototype.getScrollPerc = function(s) {\n  var pos = this.lpos || this._getCoords();\n  if (!pos) return s ? -1 : 0;\n\n  var height = (pos.yl - pos.yi) - this.iheight\n    , i = this.getScrollHeight()\n    , p;\n\n  if (height < i) {\n    if (this.alwaysScroll) {\n      p = this.childBase / (i - height);\n    } else {\n      p = (this.childBase + this.childOffset) / (i - 1);\n    }\n    return p * 100;\n  }\n\n  return s ? -1 : 0;\n};\n\nScrollableBox.prototype.setScrollPerc = function(i) {\n  // XXX\n  // var m = this.getScrollHeight();\n  var m = Math.max(this._clines.length, this._scrollBottom());\n  return this.scrollTo((i / 100) * m | 0);\n};\n\n/**\n * Expose\n */\n\nmodule.exports = ScrollableBox;\n"]},"metadata":{},"sourceType":"script"}